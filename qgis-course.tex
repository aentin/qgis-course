% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  12pt,
]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
  \setmainfont[]{PT Serif}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{apalike}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Основы геоинформатики: практикум в QGIS},
  pdfauthor={Андрей Энтин, Тимофей Самсонов, Андрей Карпачевский, Герман Титов},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Основы геоинформатики: практикум в QGIS}
\author{Андрей Энтин, Тимофей Самсонов, Андрей Карпачевский, Герман Титов}
\date{2022-12-01}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{ux43eux431ux449ux438ux435-ux441ux432ux435ux434ux435ux43dux438ux44f}{%
\chapter*{Общие сведения}\label{ux43eux431ux449ux438ux435-ux441ux432ux435ux434ux435ux43dux438ux44f}}
\addcontentsline{toc}{chapter}{Общие сведения}

\begin{quote}
Если вы ищете практикум на основе \textbf{ArcGIS}, то он находится \href{https://tsamsonov.github.io/arcgis-course/}{\textbf{тут}}.
\end{quote}

\hypertarget{ux443ux447ux435ux431ux43dux44bux435-ux43cux430ux442ux435ux440ux438ux430ux43bux44b}{%
\section*{Учебные материалы}\label{ux443ux447ux435ux431ux43dux44bux435-ux43cux430ux442ux435ux440ux438ux430ux43bux44b}}
\addcontentsline{toc}{section}{Учебные материалы}

\begin{itemize}
\item
  \textbf{Учебник}: Лурье И. К. \emph{Геоинформационное картографирование. Методы геоинформатики и цифровой обработки космических снимков: Учебник для вузов.} 2-е изд. -- М.: КДУ, 2010. \href{https://istina.msu.ru/download/295728157/1jUpeD:roxrGk69x0LxZCpC5w_KNV0o390/}{\textbf{PDF}}
\item
  \textbf{Пособие}: Лурье И. К., Самсонов Т. Е. \emph{Информатика с основами геоинформатики. Часть 2. Основы геоинформатики. Учебное пособие.} Москва. Изд-во МГУ, 2016. \href{https://istina.msu.ru/download/45821659/1ej66u:uSUtcUS-XmdMMyRRpC-yflDmCv8/}{\textbf{PDF}}
\item
  \textbf{Практикум в ArcGIS}: Самсонов Т. Е. \emph{Основы геоинформатики: практикум в ArcGIS}. --- Географический факультет МГУ Москва, 2018. --- 460 с. DOI: 10.5281/zenodo.1167857. \href{https://tsamsonov.github.io/arcgis-course/}{\textbf{Website}}
\item
  \textbf{Практикум в QGIS}: Энтин А. Л., Самсонов Т. Е. \emph{Основы геоинформатики: практикум в QGIS}. \href{https://aentin.github.io/qgis-course/}{\textbf{Website}}
\end{itemize}

\hypertarget{ux43fux440ux43eux433ux440ux430ux43cux43cux43dux43eux435-ux43eux431ux435ux441ux43fux435ux447ux435ux43dux438ux435-ux434ux43bux44f-ux440ux430ux431ux43eux442ux44b}{%
\section*{Программное обеспечение для работы}\label{ux43fux440ux43eux433ux440ux430ux43cux43cux43dux43eux435-ux43eux431ux435ux441ux43fux435ux447ux435ux43dux438ux435-ux434ux43bux44f-ux440ux430ux431ux43eux442ux44b}}
\addcontentsline{toc}{section}{Программное обеспечение для работы}

Для работы вам потребуется скачать и установить на свои компьютеры геоинформационное приложение QGIS. Это свободно распространяемое программное обеспечение, для его установки не требуется покупка или регистрация.

\hypertarget{windows}{%
\subsection*{Windows}\label{windows}}
\addcontentsline{toc}{subsection}{Windows}

Скачайте с \href{https://qgis.org/ru/site/forusers/download.html}{официального сайта} последнюю стабильную версию QGIS. По состоянию на 7 февраля 2022 г. это версия 3.16. \href{https://qgis.org/downloads/QGIS-OSGeo4W-3.16.16-1.msi}{Скачать}.

Если на вашем компьютере уже установлена более старая версия QGIS, удалите её перед началом установки новой версии. Вы можете использовать старую версию QGIS для выполнения большинства заданий практикума, однако, если у вас возникнут технические проблемы,

Когда исполняемый файл загрузится, запустите его. Если потребуется, разрешите приложению вносить изменения на вашем устройстве.

Будет показано приветственное окно мастера установки. Нажмите «Далее», чтобы перейти на следующий шаг.

\includegraphics{images/installation_instruction_win/win01.png}

На следующем шаге будет показано лицензионное соглашение QGIS и другого программного обеспечения, входящего в пакет поставки. Нажмите «Принимаю».

\includegraphics{images/installation_instruction_win/win02.png}

На следующем шаге выберите папку для установки и отметьте, нужно ли создавать ярлыки на рабочем столе и в меню «Пуск». По возможности используйте параметры, предлагаемые по умолчанию.

\includegraphics{images/installation_instruction_win/win03.png}

На следующем шаге предлагается запустить процедуру установки. Нажмите «Install». Когда система выдаст запрос на внесение изменений, примите его.

\includegraphics{images/installation_instruction_win/win04.png}

После окончания установки ярлыки QGIS будут добавлены в меню ``Пуск'' и в отдельную папку QGIS на рабочем столе.

\hypertarget{macos}{%
\subsection*{macOS}\label{macos}}
\addcontentsline{toc}{subsection}{macOS}

По состоянию на 7 февраля 2022 г. для прохождения практикума рекомендуется использовать альтернативную сборку версии \href{https://www.kyngchaos.com/files/software/qgis/QGIS-macOS-3.4.12-1.dmg}{3.4.12}. Перейдя по ссылке, необходимо согласиться сохранить образ установочного диска на компьютер (можно разрешить его сразу открыть средствами \emph{DiskImageMounter}):

\includegraphics{images/installation_instruction_mac/mac01.png}

После того как образ загрузится и будет открыт, необходимо последовательно запустить три установщика, выделенные на снимке экрана ниже (именно в том порядке, в котором они пронумерованы!):

\includegraphics{images/installation_instruction_mac/mac02.png}

Установщики \textbf{GDAL Complete} и \textbf{QGIS 3 LTR} необходимо запускать через контекстное меню и выбирать пункт ``Открыть'':

\includegraphics{images/installation_instruction_mac/mac03.png}

В появившемся диалоговом окне необходимо нажать ``Открыть'', чтобы разрешить установку:

\includegraphics{images/installation_instruction_mac/mac04.png}

Все опции при установке каждой компоненты приложения оставляйте по умолчанию, ничего не меняйте и нажимайте в диалоговых окнах ``Продолжить'', пока не запустится установщик.

После того как последняя компонента --- \textbf{QGIS} --- будет установлена, вы сможете найти приложение и запустить его из каталога \emph{Программы} macOS:

\includegraphics{images/installation_instruction_mac/mac05.png}

\hypertarget{linux}{%
\subsection*{Linux}\label{linux}}
\addcontentsline{toc}{subsection}{Linux}

Воспользуйтесь инструкциями по \href{https://qgis.org/ru/site/forusers/alldownloads.html\#linux}{этой ссылке}.

Дополнительную информацию по установке можно найти на \url{https://qgis.org/ru/site/forusers/download.html}.

\hypertarget{part-ux43eux441ux43dux43eux432ux44b-ux440ux430ux431ux43eux442ux44b-ux441-qgis}{%
\part{Основы работы с QGIS}\label{part-ux43eux441ux43dux43eux432ux44b-ux440ux430ux431ux43eux442ux44b-ux441-qgis}}

\hypertarget{map-design-general}{%
\chapter{Создание общегеографической карты}\label{map-design-general}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex01.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex01_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{map-design-general-intro}{%
\section{Введение}\label{map-design-general-intro}}

\textbf{Цель задания} --- знакомство с моделями пространственных объектов и базой пространственных данных. Визуализация данных на карте. Оформление легенды и компоновки карты.

\textbf{Необходимая теоретическая подготовка:} модели пространственных данных, модели пространственных объектов, базы пространственных объектов, картографические проекции.

\textbf{Необходимая практическая подготовка:} практическая подготовка не требуется.

\textbf{Исходные данные:} база географических данных на территорию Кавказских гор, собранная из нескольких источников.

\textbf{Ожидаемый результат:} общегеографическая карта гор Кавказа и прилегающих территорий масштаба 1:4 500 000.

\hypertarget{map-design-general-checklist}{%
\subsection{Контольный лист}\label{map-design-general-checklist}}

\begin{itemize}
\tightlist
\item
  Добавить на карту источники пространственных данных и настроить их оформление
\item
  Настроить подписи объектов
\item
  Создать компоновку карты и легенду
\item
  Экспортировать результат в графический файл
\end{itemize}

\hypertarget{map-design-general-begin}{%
\section{Начало работы}\label{map-design-general-begin}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скачайте архив с исходными данными для упражнения и распакуйте его в свою рабочую директорию.
\item
  Запустите \textbf{QGIS}. Для запуска воспользуйтесь иконкой с названием \textbf{\texttt{QGIS\ Desktop\ ...}}, где \texttt{...} --- номер версии QGIS, установленной на вашем компьютере.
\item
  Найдите \textbf{панель менеджера источников данных} \includegraphics{images/Ex01/DataSourceManagerPanel.png} и откройте \textbf{Менеджер источников данных}.

  \begin{quote}
  Ряд действий в QGIS можно выполнить с помощью горячих клавиш. Так, для открытия Менеджера источников данных можно нажать \texttt{Ctrl+L}. Сведения о доступных горячих главишах отображаются во всплывающих подсказках при наведении курсора на иконку.
  \end{quote}

  \includegraphics{images/Ex01/DataSourceManager.png}
\item
  В менеджере источников данных в режиме браузера найдите вашу рабочую директорию, а в ней --- каталог \texttt{Ex01\textbackslash{}raster\_data}. В этом каталоге отображается единственный источник данных --- \texttt{30n030e\_20101117\_gmted\_mea300.tif}. Иконка \includegraphics{images/Ex01/raster.png} и расширение \texttt{*.tif} (Tagged Image Tile Format) подсказывают вам, что этот источник представляет пространственные данные в растровой (регулярно-сеточной) модели.

  \includegraphics{images/Ex01/DataSourceManager_tif.png}

  \begin{quote}
  Замечание 1: растр, с которым вы будете работать сейчас, сохранён в формате \href{https://www.opengeospatial.org/standards/geotiff}{GeoTIFF}. От «обычного» TIFF этот формат отличается тем, что сведения о пространственной привязке в GeoTIFF записываются непосредственно в файл с данными, в то время как «обычный» формат TIFF не поддерживает запись сведений о пространственной привязке, поэтому она хранится отдельно --- в \href{https://en.wikipedia.org/wiki/World_file}{world-файле}. В дальнейшем вы часто будете работать и с тем, и с другим способом хранения пространственных данных.
  \end{quote}

  \begin{quote}
  Замечание 2: файл \texttt{30n030e\_20101117\_gmted\_mea300.tif} является фрагментом («тайлом») глобальной цифровой модели рельефа (ЦМР) \href{https://www.usgs.gov/land-resources/eros/coastal-changes-and-impacts/gmted2010}{GMTED2010}. Этот источник часто используется для геоинформационного анализа и картографирования. Загрузить тайлы GMTED2010 можно через сервис \href{https://earthexplorer.usgs.gov/}{EarthExplorer} геологической службы США.
  \end{quote}
\item
  Дважды щёлкните левой кнопкой мыши на название файла \texttt{30n030e\_20101117\_gmted\_mea300.tif} в менеджере источников данных. В панель слоёв (по умолчанию слева) добавится слой с названием \texttt{30n030e\_20101117\_gmted\_mea300}. После добавления слоя можно закрыть окно Менеджера источников данных.
\item
  Сохраните проект QGIS в папку с материалами упражнения (на том же иерархическом уровне, где находятся папки \texttt{raster\_data} и \texttt{vector\_data}). Назовите его по шаблону \texttt{\textless{}Ex01\_\%Фамилия\%\textgreater{}}, где \texttt{\%Фамилия\%} --- ваша фамилия латинскими буквами. После сохранения проека сделайте снимок экрана и вставьте его в отчётный файл.
\end{enumerate}

\textbf{Снимок экрана №1.} Окно QGIS после загрузки набора данных

\begin{quote}
Примечание: файл проекта QGIS (*.qgs, *.qgz) и документ карты ArcGIS (*.mxd) отличаются от тех файлов, с которыми вы работали ранее. В этих файлах не хранятся пространственные данные, а только ссылки на них и настройки их отображения (включая порядок слоёв, символику и подписи). Если вы перемещаете файл проекта относительно источников данных, ссылки «теряются». Поэтому важно правильно организовать структуру ГИС-проекта. В рамках нашего упражнения мы разместили файл проекта в директории более высокого уровня по отношению к тем директориям, где лежат данные. Теперь, если мы переместим всю папку Ex01 вместе со всем её содержимым, относительные пути от файла проекта до файлов данных не изменятся, и проект сохранит работоспособность. Конечно, такое решение не будет оптимальным для крупных организаций с разветвлённой структурой сетевых ресурсов, но для студенческих проектов оно, как правило, работает.
\end{quote}

\hypertarget{map-design-general-projection}{%
\section{Настройка системы координат}\label{map-design-general-projection}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

В правом нижнем углу карты вы видите надпись \includegraphics{images/Ex01/pic02.png}. Нажмите на эту надпись, чтобы открыть интерфейс выбора системы координат проекта.

\begin{figure}
\centering
\includegraphics{images/Ex01/Properties_CoordinateSystem.png}
\caption{Properties\_CoordinateSystem}
\end{figure}

В открывшемся окне вы видите более подробную информацию об используемой системе координат. Код \texttt{EPSG:4326} соответствует системе географических координат \textbf{WGS 84}. Термин «географическая система координат» (\emph{geographic coordinate systems}) в ГИС означает, что координаты объектов и линейные параметры растров хранятся в виде широты и долготы. Альтернативный подход --- проецированные системы координат (\emph{projected coordinate systems}), где плановые координаты измеряются в метрических единицах.

Система координат проекта была импортирована из первого (в нашем случае --- пока единственного) загруженного источника пространственных данных. Система координат WGS 84 обычно не используется для картографирования, поэтому мы изменим систему координат проекта.

Для выбора проекции воспользуемся удобным инструментом, который позволяет оптимизировать этот процесс --- \href{http://projectionwizard.org/}{Projection Wizard}.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Перейдите на сайт \href{http://projectionwizard.org/}{Projection Wizard}. Настройте параметры территории и проекции следующим образом:

  \begin{itemize}
  \tightlist
  \item
    класс проекции по виду искажений: \textbf{равнопромежуточная} (\emph{Equidistant});
  \item
    охват территории картографирования: от 39° с.ш. до 46° с.ш., от 36° в.д. до 51° в.д.
  \end{itemize}

  Если все сделано верно, то окно приложения должно принять приблизительно следующий вид:
  \includegraphics{images/Ex01/pwizard.png}

  Вам будет предложено две проекции. \textbf{Нажмите на ссылку WKT}, соответствующей \textbf{косой азимутальной} проекции (англ. \emph{oblique azimuthal}). На экране будет отображено всплывающее окно с параметрами выбранной проекции в формате \href{https://docs.geotools.org/stable/javadocs/org/opengis/referencing/doc-files/WKT.html}{WKT}.
\item
  Скопируйте описание WKT в буфер обмена

  Также \textbf{вставьте скопированную строку в отчётный документ}

  С помощью сайта Projection Wizard вы успешно создали новое определение системы координат. Теперь нужно ввести это определение во внутреннюю базу QGIS.
\item
  В QGIS откройте меню \textbf{Установки} --- \textbf{Пользовательские проекции\ldots{}}
\item
  Нажмите кнопку \textbf{Добавить систему координат} \includegraphics{images/Ex01/plus.png}
\item
  В полях для ввода ниже введите название проекции: \texttt{Azimuthal\ Equidistant\ (Caucasus)}, в поле \emph{Формат} выберите тип \texttt{WKT}, в поле \emph{Параметры} вставьте скопированное определение WKT.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/NewCRS.png}
  \caption{New CRS}
  \end{figure}
\item
  Нажмите \textbf{ОК}.

  Вы успешно добавили новую систему координат в пользовательский список. Теперь нужно применить её к проекту.
\item
  Откройте интерфейс выбора системы координат. Это можно сделать не только нажатием на элемент в правом нижнем углу, или через меню \textbf{Проект} --- \textbf{Свойства\ldots{}} (вкладка \textbf{Система координат}).
\item
  В открывшемся меню найдите в списке свою проекцию (для этого можно использовать поле ``Фильтр'' вверху окна), выберите её и нажмите \textbf{ОК}.
\end{enumerate}

Если все сделано верно, изображение ЦМР должно приобрести форму сфероидической трапеции. Сделайте снимок экрана и вставьте его в отчётный файл.

\textbf{Снимок экрана №2.} Окно QGIS после изменения проекции

Закройте интерфейс выбора системы координат и нажмите правой кнопкой на слой \texttt{30n030e\_20101117\_gmted\_mea300} в таблице слоёв. В контекстном меню выберите \textbf{Свойства\ldots{}} и в открывшемся окне перейдите на вкладку \textbf{Информация}. Вы видите, что проекция набора данных не изменилась. QGIS, как и большинство ГИС-пакетов, умеет трансформировать наборы данных для отображения их в целевой проекции. На жаргоне ГИС-специалистов это называется \emph{«перепроецирование на лету» (reprojection on the fly)}.

\hypertarget{map-design-general-navigation}{%
\section{Навигация по карте}\label{map-design-general-navigation}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

Чтобы иметь возможность рассмотреть территорию картографирования более детально, потребуется увеличить масштаб и переместить изображение. Изучите функциональные возможности инструментов навигациии, которые расположены на панели инструментов \textbf{Map Navigation} (если панель отсутствует, щелкните на пустом поле среди панелей инструментов, и активируйте соответствующий пункт в меню):

\begin{figure}
\centering
\includegraphics{images/Ex01/NavigationPanel.png}
\caption{Инструменты перемещения по карте}
\end{figure}

Некоторые инструменты навигации могут быть задействованы независимо. Например, масштабирование выполняется прокруткой колеса мыши, а перемещение по карте --- движением мыши с зажатой средней кнопкой.

\begin{quote}
Режим \emph{панорамирования} (перемещения карты) также активируется нажитием пробела. Зажмите пробел и просто двигайте курсор мышкой или тачпадом. Нажимать кнопку мыши или тачпад при этом не надо!
\end{quote}

После того как инструменты навигации станут понятны, установите масштаб карты равным \(1:5~000~000\). Это можно сделать в элементе \emph{Масштаб} в нижней панели QGIS. При этом достаточно ввести только знаменатель масштаба, выделив его двойным кликом и заменив на нужное значение без пробела (\texttt{5000000}).

После этого переместите изображение таким образом, чтобы Кавказские горы занимали картографическое изображение целиком по ширине.

\hypertarget{map-design-general-relief}{%
\section{Оформление изображения рельефа}\label{map-design-general-relief}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

Изображение рельефа, которые вы видите, представляет собой так называемую аналитическую отмывку по высоте. Для аналитической отмывки используется шкала оттенков серого, применяемая по умолчанию. Мы будем использовать аналитическую отмывку по высоте вместе со светотеневой отмывкой.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя \texttt{30n030e\_20101117\_gmted\_mea300} и перейдите на вкладку \textbf{Стиль}.
\item
  Измените тип представления с \emph{Одноканальное серое} на \emph{Одноканальное псевдоцветное}.
\item
  Установите минимальное значение равным \emph{0}, а максимальное значение --- \emph{4000}.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style1.png}
  \caption{Настройки стиля 1}
  \end{figure}
\item
  В строке выбора градиента («Цветовой ряд») нажмите правой кнопкой на шкалу и в открывшемся контекстном меню выберите опцию \textbf{Новый цветовой ряд\ldots{}}

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style2.png}
  \caption{Настройки стиля 2}
  \end{figure}
\item
  В появившемся всплывающем окне в ниспадающем списке выберите тип градиента \emph{Каталог: cpt-city} (\href{http://soliton.vm.bytemark.co.uk/pub/cpt-city/}{подробнее о cpt-city})
\item
  В открывшемся каталоге в разделе \emph{Topography} выберите градиент \emph{c3t3} и нажмите \textbf{OK}

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style3.png}
  \caption{Настройки стиля 3}
  \end{figure}
\item
  После нажатия OK были закрыты все окна, кроме окна свойств слоя \texttt{30n030e\_20101117\_gmted\_mea300}. Нажмите \textbf{OK}, чтобы применить изменения символики и закрыть окно.

  Вы успешно применили аналитическую отмывку по высоте к цифровой модели рельефа. Но для красочного, визуально привлекательного изображения этого недостаточно. Помимо аналитической отмывки по высоте, мы создадим светотеневую отмывку.
\item
  Щёлкните правой кнопкой мыши по слою \texttt{30n030e\_20101117\_gmted\_mea300} в таблице слоёв и в контекстном меню нажмите \textbf{Дублировать слой}.

  Дубликат слоя будет помещён в таблице слоёв ниже исходного слоя, выключен, а к его имени будет приписано ``копия''.

  \begin{quote}
  \textbf{Обратите внимание, что оба слоя используют один и тот же источник данных.} Вы можете сделать сколько угодно слоёв с разными настройками визуализации на базе одного и того же набора пространственных данных. Но если вы измените используемый набор пространственных данных, это повлечёт за собой автоматическое изменение вида слоёв (но не настроек их визуализации).
  \end{quote}
\item
  Используя контекстное меню или окно свойств слоя, переименуйте оба слоя. Нижний слой назовите \emph{Аналитическая отмывка по высоте}, верхний --- \emph{Светотеневая отмывка}.

  \begin{quote}
  Названия слоёв никак не затрагивают источник пространственных данных. До тех пор, пока вам не приходится работать со слоями с помощью скриптов на языке Python, вы можете никак не ограничивать себя в названиях.
  \end{quote}
\item
  Включите отображение нижнего слоя.
\item
  Откройте свойства слоя «Светотеневая отмывка», перейдите на вкладку «Стиль».
\item
  Измените способ визуализации на \emph{Теневой рельеф} и нажмите \textbf{Применить}. При этом изменения будут применены, но окно свойств не закроется.

  На заднем плане вы видите изменения, произошедшие с вашим слоем. Во-первых, изображение светотеневой отмывки полностью закрыло изображение аналитической отмывки по высоте. Эту проблему можно решить, включив настройки прозрачности для слоя. Во-вторых, сама светотеневая отмывка выглядит очень тёмной. Это связано с несовпадением единиц измерения «по горизонтали» и «по вертикали» в исходном наборе данных: ячейки растра образут градусную сетку, а высотные отметки хранятся в метрах. Проблему можно решить двумя путями: трансформировать слой в проецированную систему координат или применить коэффициент масштабирования по вертикали (\emph{Z-factor}). Мы пойдём вторым путём и будем изменять значение коэффициента масштабирования.

  \begin{quote}
  Коэффициент масштабирования представляет собой переводной коэффициент из «вертикальных» единиц измерения в «горизонтальные». Для растров на градусной сетке, коэффициент, строго говоря, будет различным по широте и долготе в силу сближения меридианов.
  \end{quote}

  \textbf{Рассчитайте коэффициент масштабирования по отношению к 1° долготы и 1° широты (на широте параллели касания проекции)}. После этого сверьтесь с результатом ниже:
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{12}
\item
  Помимо переводного коэффициента между единицами измерения, нам нужно дополнительно масштабировать высоты по вертикали, чтобы отмывка выглядела более «рельефно». В разных случаях применяется дополнительный множитель в диапазоне от 1,5 до 10, мы воспользуемся коэффициентом \emph{5}.
\item
  Перемножьте оба коэффициента и введите полученное значение в качестве Z-фактора слоя.
\item
  Перейдите на вкладку \textbf{Прозрачность} и установите коэффициент непрозрачности для слоя равным 50 \%. Примените изменения, закройте окно свойств слоя и сохраните проект.
\end{enumerate}

\textbf{Снимок экрана №3.} Изображение рельефа с высотной и светотеневой отмывкой

\begin{quote}
Настройки визуализации рельефа, которые применялись в этом упражнении, подобраны приблизительно, без предварительного анализа распределения высот картографируемой территории и выбора оптимальной шкалы. Эти вопросы подробно освещаются в курсах «Оформление карт» и «Общегеографическое картографирование», читаемых на кафедре картографии и геоинформатики
\end{quote}

\hypertarget{map-design-general-vector}{%
\section{Добавление векторных наборов данных}\label{map-design-general-vector}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

Откройте стыкуемое окно браузера и перейдите в директорию \emph{Домашний каталог проекта}. Раскройте папку \emph{vector\_data}.

\begin{quote}
Домашний каталог проекта --- это директория (папка), в которую был сохранён проект QGIS (*.qgz).
\end{quote}

\begin{figure}
\centering
\includegraphics{images/Ex01/DefaultLocation.png}
\caption{Default location}
\end{figure}

Вы видите несколько источников данных, обозначенных символом \includegraphics{images/Ex01/polygon.png}. Это векторные наборы данных, представленные в формате \href{https://desktop.arcgis.com/ru/arcmap/latest/manage-data/shapefiles/what-is-a-shapefile.htm}{шейп-файлов}.

Теперь откройте эту же директорию через Проводник Windows (или любой другой файловый менеджер). Сравните количество файлов в Проводнике с количеством доступных источников данных в браузере QGIS

\begin{quote}
Шейп-файлы были базовым форматом ГИС-пакета ArcView и за счёт этого получили очень широкое распространение. Шейп-файлы не такие функциональные, как базы геоданных ESRI (современный базовый формат для продуктов линейки ArcGIS) или GeoPackage, но тем не менее их продолжают активно использовать. Многие особенности шейп-файлов обусловлены спецификой и возможностями компьютеров начала 90-х гг. В частности, геометрия набора данных хранится отдельно (в файле \texttt{*.shp}), семантика --- отдельно (в формате dBASE, \texttt{*.dbf}), а для связи между ними используется индекс-файл (\texttt{*.shx}). Эти три файла --- обязательные компоненты шейп-файла. Помимо них, отдельно могут быть записаны сведения о проекции (\texttt{*.prj}), кодировке (\texttt{*.cpg}) и многое другое. Основным файлом, тем не менее, считается \texttt{*.shp}, а все остальные на компьютерном сленге называются \href{https://en.wikipedia.org/wiki/Sidecar_file}{\emph{sidecar}-файлами}.
\end{quote}

\begin{quote}
\textbf{Важно:} при копировании шейп-файлов через Проводник необходимо копировать \textbf{все} файлы с одинаковым именем
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту наборы данных об объектах гидрографии (\texttt{hydrography-polyline.shp}, \texttt{hydrography-polygon.shp}). В таблице слоёв разместите линии над полигонами. Переименуйте слои в «Водотоки» и «Водоёмы» соответственно.

  \begin{quote}
  Все векторные наборы данных для этого упражнения созданы на основе \href{http://www.vsegei.com/ru/info/topo/}{цифровых географических основ ВСЕГЕИ}. Это один из немногих общедоступных источников пространственных данных общегеографического содержания на территорию Российской Федерации и ближнего зарубежья.
  \end{quote}
\item
  Настройте символику для добавленных векторных наборов данных. Также, как и для растров, настройки символики векторных данных помещаются в свойствах слоя, на вкладке \textbf{Стиль}.

  \begin{itemize}
  \tightlist
  \item
    Для полигонов гидрографии установите стандартный стиль \emph{topo water} из библиотеки QGIS.\\
  \item
    Для линейных объектов используйте стандартный стиль \emph{simple blue line}, но уменьшите толщину линии до 0,26 мм
  \end{itemize}

  \includegraphics{images/Ex01/style4.png}
  \includegraphics{images/Ex01/style5.png}

  \begin{quote}
  Если приглядеться, то можно увидеть, что знак контура береговой линии и знаки линейных объектов гидрографии на суше не совпадают. Можно изменить цвет и толщину обводки для полигонов объектов гидрографии, сделав их такими же, как у рек и каналов.
  \end{quote}
\item
  Добавьте к карте железные дороги и автодороги. Переименуйте слои и изобразите их линиями толщиной 0,26 мм. Для автодорог используйте красный цвет, для железных дорог --- тёмно-серый (20 \% светлоты).
\end{enumerate}

\hypertarget{map-design-general-attributes}{%
\section{Использование атрибутов объектов при визуализации}\label{map-design-general-attributes}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

До этого момента мы работали только визуальным представлением слоя и никак не касались семантической составляющей. На следующем шаге вы будете использовать разные значки для различных типов объектов в одном слое.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте к карте набор данных \texttt{adm\_line}, переместите добавленный слой ниже всех линейных объектов и переименуйте его в «Границы».
\item
  Вызовите контекстное меню слоя «Границы» и выберите опцию «Открыть таблицу атрибутов». Откроется таблица атрибутов источника данных.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/AttributeTable.png}
  \caption{Attribute Table}
  \end{figure}

  Таблица атрибутов --- это представление базы данных, связанной с набором пространственных объектов. База функционирует по общим правилам реляционной базы данных: каждый объект представляется одной «строкой», в каждом столбце (поле) одному объекту соответствует одно значение. Атрибуты играют важную роль в геоинформационных системах. На их основе происходит визуализация данных, также они участвуют в большинстве операций пространственного анализа. В этом упражнении вы используете атрибуты, чтобы присвоить различные стили объектам в одном слое.
\item
  Закройте таблицу атрибутов или пристыкуйте её к нижней части окна.
\item
  Откройте свойства слоя на вкладке \emph{Стиль}.
\item
  Измените тип визуализации с \emph{Обычный знак} на \emph{Уникальные значения}. Эта настройка позволяет присваивать объектам различные стили в соответствии со значениями определённого атрибута.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style6.png}
  \caption{Настройки стиля 6}
  \end{figure}
\item
  В выпадающем списке \textbf{Поле} выберите столбец \texttt{L\_TYPE}, по которому будет происходить классификация, и нажмите кнопку \textbf{Классифицировать} внизу формы.

  В форму добавились три записи. Две из них представляют фактически имеющиеся значения атрибутов, третья --- «пустая» --- предназначена для визуализации всех остальных значений (которых фактически нет в таблице на настоящий момент, но которые могут появиться позже в результате редактирования)

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style7.png}
  \caption{Настройки стиля 7}
  \end{figure}

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/Classes.png}
  \caption{Классы}
  \end{figure}
\item
  Дважды щёлкните на значке, соответствующем классу \emph{Границы государственные}. Откроется уже знакомый вам интерфейс настройки условных знаков. Обратите внимание на форму в левом верхнем углу: вы можете задать несколько слоёв для одного условного знака, используя опцию добавления слоёв (\includegraphics{images/Ex01/plus.png}).

  \begin{quote}
  Слои в таблице слоёв и слои условного знака --- это две разные, не связанные между собой сущности
  \end{quote}
\item
  Создайте для государственных границ двухслойный знак. Нижний слой: линия серого цвета (75 \% светлоты) шириной 1 мм, с плоскими концами (чтобы концы линии не «свешивались» в воду). Верхний слой: линия тёмно-серого цвета (светлота 20 \%) толщиной 0,26 мм, штрихпунктирная, с плоскими концами.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/style8.png}
  \caption{Настройки стиля 8}
  \end{figure}
\item
  Создайте аналогичный знак для границ субъектов РФ. Нижний слой: линия серого цвета (75 \% светлоты) шириной 0,8 мм, с плоскими концами. Верхний слой: линия тёмно-серого цвета (светлота 20 \%) толщиной 0,26 мм, штриховая, с плоскими концами.
\item
  Для прочих границ используйте однослойный условный знак: пунктирная линия тёмно-серого цвета
\end{enumerate}

\textbf{Сохраните проект.}

\hypertarget{map-design-general-labels}{%
\section{Подписи}\label{map-design-general-labels}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту набор данных \texttt{elevation\_points.shp}, расположите слой на самом верху списка и переименуйте его в \emph{Вершины}. Настройте отображение единым знаком в виде чёрного треугольника, аналогично тому, как показываются отметки высот в школьных атласах.
\item
  Откройте таблицу атрибутов слоя. Какие поля можно использовать для подписей?

  \begin{quote}
  На общегеографических картах обычно приводятся высоты и названия горных вершин. В этом упражнении мы ограничимся названиями.
  \end{quote}
\item
  Закройте таблицу атрибутов и откройте свойства слоя. Перейдите на вкладку «Подписи». Переключите режим подписей на \emph{Обычные подписи} (подписывать объекты значением атрибута). В открывшемся меню в выпадающем списке «Подписывать значениями» выберите поле \texttt{NAME} --- тексты подписей будут «считываться» из него.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/text1.png}
  \caption{Настройки текста 1}
  \end{figure}
\item
  В поле \textbf{Text sample} отображается пример подписи с теми настройками, которые заданы по умолчанию. Если вы будете менять настройки подписей (шрифт, форматирование, «гало» и др.), этот пример будет меняться. Сейчас мы последовательно пройдём по вкладкам настройки подписей, исправив необходимые параметры.

  \begin{itemize}
  \tightlist
  \item
    На вкладке \emph{Текст} установите гарнитуру («шрифт») Times New Roman, начертание («стиль») полужирный курсив, кегль («размер») 8.
  \item
    На вкладке \emph{Буфер} включите опцию «Буферизовать подписи» и задайте буферизацию размером 0,6 мм. Это повысит читаемость подписей на карте.
  \item
    На вкладке \emph{Размещение} выберите опцию «Картографическое», расстояние 0,1 мм от границ символа (\emph{from symbol bounds})
  \end{itemize}

  Примените настройки подписей и закройте свойства слоя
\item
  В каталоге \texttt{vector\_data} остался незадействованный слой --- \texttt{population\_points}. Добавьте его в проект, переименуйте и самостоятельно настройте условные знаки и подписи. Используйте параметр \emph{уникальные значения} для того, чтобы отобразить города с разной численностью населения разными условными знаками.
\end{enumerate}

\textbf{Снимок экрана №4.} Окно QGIS после завершения настройки символов

\textbf{Сохраните проект.}

\hypertarget{map-design-general-layout}{%
\section{Настройка компоновки карты}\label{map-design-general-layout}}

\protect\hyperlink{map-design-general}{В начало упражнения ⇡}

Изображение, которое вы видите во фрейме данных, можно экспортировать в отдельный графический файл «как есть» (с помощью опции \textbf{Проекты --- Импорт/экспорт --- Экспортировать карту как изображение\ldots{}}). Однако для картографических целей, как правило, формируется \textbf{компоновка карты}. На листе заданного формата размещается картографическое изображение, добавляется название, легенда, масштабная линейка и элементы зарамочного оформления.

Сейчас мы создадим макет компоновки с расчётом на то, что итоговая карта будет вставлена в отчёт.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте новый макет компоновки (\textbf{Проект --- Создать Макет\ldots{}}) или \texttt{Ctrl+P}.
\item
  Введите название макета: Ex01\_\%Фамилия\%, где \%Фамилия\% --- ваша фамилия на любом языке.

  После ввода названия откроется окно компоновки (\emph{Layout})\\
  \includegraphics{images/Ex01/Layout.png}
\item
  Добавьте на лист картографическое изображение. Для этого используется инструмент \textbf{Добавить карту} из панели инструментов. Выберите инструмент и «растяните» прямоугольник карты на листе.

  \begin{figure}
  \centering
  \includegraphics{images/Ex01/button_AddMap.png}
  \caption{Add Map}
  \end{figure}
\item
  После добавления элемента откроется панель его свойств. Изучите настройки, доступные в этой панели, а затем установите для карты знаменатель масштаба \emph{4 000 000} и размеры \(237\times130\) мм. В том же разделе, где устанавливаются размеры элемента, задайте для элемента карты положение по \(X = 30\) мм и положение по \(Y = 30\) мм.

  \begin{quote}
  Положение элемента на листе отсчитывается от верхнего левого угла листа до точки привязки элемента.
  \end{quote}
\item
  Добавьте к карте градусную сетку. Для этого в свойствах элемента найдите раздел \textbf{Сетки}, нажмите на кнопку \emph{Добавить новую сетку}, а затем \emph{Modify Grid}. Откроется меню настройки сетки. Задайте для сетки проекцию WGS84, интервал по долготе --- \(4°\), интервал по широте --- \(2°\). Также уменьшите толщину линий сетки до \(0.1\) мм. Для этого щёлкните левой кнокой мыши по элементу \emph{Стиль линии} и выполните необходимые настройки в уже привычном для вас интерфейсе. Вернуться обратно к настройкам сетки можно, нажав на кнопку \emph{Назад} в левом верхнем углу интерфейса.
\item
  Добавьте рамку сетки в виде простой линии. Для этого в свойствах элемента активируйте раздел \textbf{Рамка}.
\item
  Включите отображение подписей координатной сетки. Для этого в разделе \textbf{Сетки} выберите в списке созданную сетку, нажмите кнопку \textbf{Modify Grid\ldots{}} и отметьте флажок \emph{Draw Coordinates}. Настройте отображение подписей так, чтобы широта подписывалась только вдоль западной и восточной рамки, а долгота --- только вдоль северной и южной. Используйте формат координат \emph{Десятичные с окончанием} и нулевое число знаков после запятой (этот параметр в QGIS называется \emph{Точность координат}).
\item
  Вернитесь к макету и передвиньте картографическое изображение внутри элемента таким образом, чтобы вместилась вся основная часть Главного Кавказского хребта. Можно ориентироваться на города: в северо-западном углу карты должен отображаться Краснодар, в юго-восточном --- Баку.

  \begin{quote}
  Для перемещения карты внутри фрейма используется инструмент \textbf{Перемещение содержимого элемента}.
  \end{quote}
\item
  Добавьте на лист название карты. Для этого \textbf{вставьте новую надпись} и разместите её над элементом карты. Введите название карты «Кавказские горы», используйте выключку (горизонтальное выравнивание) по центру, настройте параметры шрифта на своё усмотрение (заголовки обычно набираются прописными буквами с разреженным кернингом).
\item
  Добавьте на лист масштабную линейку. Переместите линейку в юго-западный угол карты, установите для неё отображение фона и границы, исправьте обозначение единиц измерения. Уменьшите высоту линейки, кегль шрифта и отступы подписей, чтобы линейка смотрелась более компактно.
\item
  Добавьте на лист легенду. Легенда будет собрана автоматически на основе тех настроек визуализации, которые применены для слоёв карты.
\item
  Отредактируйте легенду. Для этого сначала выключите автообновление (\emph{Auto update}) элементов легенды, чтобы сделать список элементов доступным для редактирования. Удалите из легенды те условные знаки, которые не встречаются на карте, и переименуйте неинформативные или пустые подписи.
\item
  Добавьте обводку для элемента легенды и разместите элемент в северо-восточном углу карты.
\item
  Добавьте ещё один текстовый элемент и впишите в него сведения об авторстве.
\item
  Экспортируйте получившуюся карту в изображение формата PNG («Макет» --- «Экспорт в изображение\ldots» или специальная кнопка на главной панели инструментов макета).
\end{enumerate}

\textbf{Сохраните проект.}

\begin{longtable}[]{@{}l@{}}
\toprule()
\endhead
\emph{Энтин А.Л., Самсонов Т.Е.} \textbf{Основы геоинформатики: практикум в QGIS}. М.: Географический факультет МГУ, 2022. \\
\bottomrule()
\end{longtable}

\hypertarget{map-design-world}{%
\chapter{Создание политической карты мира}\label{map-design-world}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex02_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{map-design-world-intro}{%
\section{Введение}\label{map-design-world-intro}}

\textbf{Цель задания} --- закрепление навыков загрузки и визуализации данных в QGIS.

\textbf{Необходимая теоретическая подготовка:} модели пространственных данных, модели пространственных объектов, базы пространственных объектов, картографические проекции.

\textbf{Необходимая практическая подготовка:} не требуется.

\textbf{Исходные данные:} \href{https://www.naturalearthdata.com/}{Natural Earth}.

\textbf{Ожидаемый результат:} политическая карта мира М 1:130 000 000

\hypertarget{map-design-world-checklist}{%
\subsection{Контольный лист}\label{map-design-world-checklist}}

\begin{itemize}
\tightlist
\item
  Добавить на карту источники пространственных данных
\item
  Создать определение проекции
\item
  Настроить отображение объектов на карте различными цветами в соответствии с данными в таблице атрибутов
\item
  Скомпоновать картографическое изображение
\item
  Экспортировать результат в графический файл
\end{itemize}

\hypertarget{map-design-world-begin}{%
\section{Начало работы}\label{map-design-world-begin}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

Работа с пространственными данными обычно подразумевает одновременное использование множества файлов и баз данных, которые могут располагаться как на вашем локальном компьютере, так и в локальной сети или в Интернете. Хотя в реальной практике использования ГИС обычно применяется сетевое размещение ресурсов, в этом упражнении и далее в курсе геоинформатики вы, как правило, будете организовывать все ресурсы ваших ГИС-проекты в локальных директориях.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте или выберите директорию (папку) для упражнений по геоинформатике на вашем рабочем компьютере. Например, для компьютеров под управлением ОС Windows: \texttt{D:\textbackslash{}GIS\textbackslash{}207\_CAR\textbackslash{}Ivanov}. Мы настоятельно рекомендуем, чтобы полный путь к рабочей директории не содержал символов русского алфавита, диакритики или других специальных символов.
\item
  В рабочей директории создайте папку для текущего упражнения, например, \texttt{Ex02}. Все данные, относящиеся к этому упражнению, будут находиться здесь.
\item
  В папке для текущего упражнения создайте ещё одну вложенную папку. Назовите её \texttt{data}. В эту папку вы будете помещать пространственные данные, которые получите на последующих этапах.
\end{enumerate}

\hypertarget{map-design-world-input-data}{%
\section{Загрузка исходных данных}\label{map-design-world-input-data}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

Работа в ГИС --- это в первую очередь работа с пространственными данными. Пространственные данные могут иметь различную форму представления, уровень детализации, назначение и лицензионные ограничения на использование. В этом упражнении мы воспользуемся данными ресурса \href{https://www.naturalearthdata.com/}{Natural Earth}. Это наборы пространственных данных низкой детализации, предназначенные для создания карт мелкого масштаба (1:10 000 000, 1:50 000 000, 1:110 000 000). Важно, что все данные находятся в свободном доступе --- вы можете использовать их без ограничений как в учебных и научных задачах, так и в коммерческих проектах. Посмотрите вкладку \emph{About}, чтобы узнать больше о Natural Earth.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Перейдите на страницу загрузок Natural Earth (\url{https://www.naturalearthdata.com/downloads/}). На этой странице перейдите в раздел Cultural, соответствующий самому мелкому масштабу.

  \includegraphics{images/Ex01_WorldMap/NaturalEarthDownloadPage.png}
\item
  Скачайте набор данных \texttt{Admin\ 0\ –\ Countries}. На ваш компьютер будет загружен архив в формате \href{https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT}{ZIP}. Этот формат поддерживается большинством современных программ для архивирования и разархивирования файлов.
\item
  Распакуйте содержимое архива в папку \texttt{data}, созданную на предыдущем шаге. Сам архив можно удалить.

  Содержимое архива составляют пространственные данные в виде \protect\hyperlink{manual-dataformats-shapefile}{шейп-файла ESRI}, а также несколько сопроводительных файлов

  \includegraphics{images/Ex01_WorldMap/Shapefile.png}

  \begin{quote}
  Шейп-файлы были базовым форматом ГИС-пакета ArcView и за счёт этого получили очень широкое распространение. Шейп-файлы не такие функциональные, как базы геоданных ESRI (современный базовый формат для продуктов линейки ArcGIS) или GeoPackage, но тем не менее их продолжают активно использовать. Многие особенности шейп-файлов обусловлены спецификой и возможностями компьютеров начала 90-х гг. В частности, геометрия набора данных хранится отдельно (в файле \texttt{.shp}), семантика --- отдельно (в формате \href{https://en.wikipedia.org/wiki/DBase}{dBase}, \texttt{.dbf}), а для быстрого поиска по пространственным данным используется индекс-файл (\texttt{.shx}). Эти три файла --- обязательные компоненты шейп-файла. Помимо них, отдельно могут быть записаны сведения о проекции (\texttt{.prj}), кодировке (\texttt{.cpg}) и многое другое. Основным файлом, тем не менее, считается \texttt{.shp}, а все остальные на компьютерном сленге называются \href{https://en.wikipedia.org/wiki/Sidecar_file}{\emph{sidecar}-файлами}. Все файлы в составе шейп-файла имеют одинаковые имена, но разные расширения.
  \end{quote}
\item
  Изучите содержимое папки после разархивирования. Удалите файлы, которые не входят в состав шейп-файла. Определите назначение остальных файлов.
\end{enumerate}

\hypertarget{map-design-world-qgis-project}{%
\section{Создание ГИС-проекта и загрузка данных в проект}\label{map-design-world-qgis-project}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите QGIS.

  \begin{quote}
  Для запуска можно воспользоваться ярлыком QGIS Desktop \textless\ldots\textgreater{} или QGIS Desktop \textless\ldots\textgreater{} with GRASS \textless\ldots\textgreater. Второй ярлык одновременно с QGIS запускает сессию GRASS, что позволяет задействовать инструменты GRASS изнутри QGIS. В этом упражнении вы не будете использовать инструменты GRASS, поэтому можно воспользоваться любым ярлыком для запуска.
  \end{quote}
\item
  Сохраните проект в папку с материалами текущего упражнения (в нашем примере --- \texttt{Ex02}) под именем \texttt{Ex02\_*Surname*} (вместо surname вставьте вашу фамилию в латинской транслитерации). Чтобы сохранить проект, воспользуйтесь опцией «Сохранить» из меню «Проект» или кнопкой \includegraphics{images/Ex01_WorldMap/save.png} на панели инструментов проекта. Проект QGIS версии 3 имеет расширение \texttt{*.qgz}.

  \begin{quote}
  Для самопроверки: проект QGIS (файл \texttt{*.qgz}) должен располагаться в том же каталоге, что и папка \texttt{data}.
  \end{quote}
\item
  Откройте \textbf{Менеджер источников данных}. Это можно сделать из меню «Слой», с помощью кнопки \includegraphics{images/Ex01_WorldMap/dataSourceManagerButton.png} на специальной панели (которая так и называется --- панель менеджера источников данных) или нажав комбинацию клавиш \texttt{Ctlr}+\texttt{L}. Откроется окно Менеджера источников данных
\item
  Если вы впервые пользуетесь QGIS, то окно Менеджера откроется на вкладке «Обозреватель», вид которого аналогичен проводнику файловой системы. Если Менеджер источников данных открылся на другой вкладке, перейдите на вкладку «Обозреватель»
\item
  Найдите в списке папок «Размещение по умолчанию для проекта» и раскройте его.
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/dataSourceManagerWindowDefault.png}

\begin{verbatim}
«Размещение по умолчанию для проекта» — это каталог, в котором находится ваш файл проекта. Если бы мы не сохранили проект на предыдущем шаге, этого пункта в проводнике не было бы. Размещение по умолчанию облегчает доступ к файлам проекта, если вы поддерживаете структуру ГИС-проекта в порядке.
\end{verbatim}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\item
  Разверните содержимое папки \texttt{data}. Сколько наборов пространственных данных находится в этой папке?
\item
  Добавьте набор \texttt{ne\_110m\_admin\_0\_countries.shp} в проект. Для этого дважды щёлкните по его названию левой клавишей мыши или воспользуйтесь опцией «Добавить слой в проект» из контекстного меню.
\item
  Закройте Менеджер источников данных. Окно QGIS примет вид, аналогичный представленному ниже.
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/Stage1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{8}
\tightlist
\item
  Сохраните проект QGIS.
\end{enumerate}

\textbf{Снимок экрана №1.} Окно QGIS после загрузки набора данных

\hypertarget{map-design-world-crs}{%
\section{Настройка системы координат проекта}\label{map-design-world-crs}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

В правом нижнем углу окна QGIS вы видите надпись \includegraphics{images/Ex01_WorldMap/EPSG4326.png}. Нажмите на эту надпись, чтобы открыть интерфейс выбора системы координат проекта.

\begin{quote}
Примечание: в тот же интерфейс можно попасть, выбрав «Проект» --- «Свойства», и в открывшемся окне перейдя на вкладку «Система координат».
\end{quote}

В открывшемся окне вы видите более подробную информацию об используемой системе координат. Код \texttt{EPSG:4326} соответствует системе географических координат \textbf{WGS 84}. Термин «географическая система координат» (\emph{geographic coordinate systems}) в ГИС означает, что координаты объектов и линейные параметры растров хранятся в виде широты и долготы. Альтернативный подход --- проецированные системы координат (\emph{projected coordinate systems}), где плановые координаты измеряются в метрических единицах.

Система координат проекта была импортирована из первого (в нашем случае --- пока единственного) загруженного источника пространственных данных. Система координат WGS 84, как правило, не используется для картографирования, поэтому мы изменим систему координат проекта. Поскольку проект предназначен для создания карты мира, мы выберем систему координат, использующую подходящую проекцию --- например, \href{https://en.wikipedia.org/wiki/Robinson_projection}{проекцию Робинсона}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  В строке «Фильтр» в верхней части интерфейса выбора системы координат проекта начните вводить \texttt{robinson}, чтобы отфильтровать доступные системы координат по названию. Ниже, в блоке «Предустановленные системы координат», будет выведен список систем координат, в название которых входит введённая совокупность символов.
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/Robinson_presets.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Выберите ту из систем координат, где в качестве вспомогательной поверхности используется эллипсоид вращения

  \begin{quote}
  Примечание: на карте общемирового охвата различия между системами координат, использующих одну проекцию, но разные геодезические даты (датумов), несущестенно. Но в общем случае использование разных геодезических дат (датумов) может приводить к изменению положений контуров на сотни метров.
  \end{quote}
\item
  Примените изменения и закройте окно свойств проекта
\end{enumerate}

Сейчас ваша карта выглядит приблизительно так, как показано на иллюстрации ниже:

\includegraphics{images/Ex01_WorldMap/map_robinson0.png}

Это изображение уже больше похоже на «приличную» карту мира, но у него есть ряд заметных недостатков. Главный из них --- разрыв вдоль 180-го меридиана, из-за которого Чукотка оказывается «оторванной» от основной территории Российской Федерации и переносится в северо-западный угол карты.

Чтобы избавиться от этого эффекта, мы изменим один из параметров системы координат --- центральный меридиан проекции. Изменение центрального меридиана приведёт к тому, что картографическое изображение «сдвинется», как лента конвейера. В результате Чукотка окажется в восточной части карты и не будет оторвана от Евразии. Но сначала нам нужно определить, на какую величину нужно сдвинуть центральный меридиан.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Верните проекту исходную систему координат (\texttt{WGS\ 84}) и увеличьте изображение Берингова пролива. Обратите внимание, что воображаемые линии меридианов в некотором диапазоне не пересекают сушу
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/bering.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Подводя курсор узлам полигонов, ближайшим к «разрыву», определите диапазон долгот более точно, до десятых долей градуса.
\item
  В найденном диапазоне выберите меридиан, долгота которого будет кратна 0,5°
\item
  Теперь вычислите разность между 180° и найденной долготой. Это и будет искомое смещение центрального меридиана проекции. Запомните или запишите его.
\item
  Вернитесь в интерфейс выбора системы координат и снова выберите систему координат с проекцией Робинсона.
\item
  В блоке определений системы координат скопируйте описание системы координат в формате WKT. Копируйте строки, показанные ниже:

  \includegraphics{images/Ex01_WorldMap/Robinson_WKT.png}

  Для удобства можете сохранить скопированные строки в отдельный текстовый файл
\item
  Закройте интерфейс выбора системы координат.
\item
  Откройте меню настройки новых систем координат («Установки» --- «Пользовательские проекции\ldots»).
\item
  Нажмите зелёную клавишу с изображением знака «+», чтобы начать добавление новой системы координат.
\item
  В строке «Параметр» введите имя для вашей новой системы координат. Для удобства дальнейшей работы имя должно быть коротким и информативным, например \texttt{Robinson\_shift}. Можно также вписать в имя конкретное значение параметра, которое вы собираетесь изменить.
\item
  Убедитесь, что опция «Формат» установлена в значение \texttt{WKT\ (Recommended)}. Вы скопировали параметры системы координат в формате WKT, поэтому данная опция вам подходит.
\item
  В блок «Параметры» вставьте определение системы координат, скопированный ранее на шаге 9.
\item
  Измените параметры системы координат следующим образом:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Параметр \emph{Longitude of natural origin}: вместо 0 установите значение, найденное на шаге 7. В качестве разделителя целой и дробной части используйте точку!
\item
  Параметр \emph{ID} в самом конце списка: удалите запись \texttt{ID{[}"ESRI",54030{]}}, а также запятую, которая находится перед ней в строке выше. Обратите внимание, что удалить нужно только одну квадратную скобку --- вторая относится к более крупному блоку описания! Если вы всё сделали правильно, описание системы координат будет оканчиваться \textbf{тремя} квадратными скобками.
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{16}
\item
  Нажмите кнопку «Validate», чтобы проверить синтаксическую корректность введённого определения координат. Если система выдаст сообщеине «The WKT projection definition is valid», то вы всё сделали правильно. В противном случае вернитесь на шаг 15.
\item
  Если определение успешно прошло валидацию, нажмите ОК, чтобы сохранить введённые параметры. На этом этапе система также может выдать ошибку, если введённые параметры совпадают с определением, которое уже есть в базе. В этом случае вернитесь на шаг 16.
\item
  Теперь снова откройте окно выбора системы координат. Задайте проекту систему координат, которую вы только что ввели.
\end{enumerate}

Увеличьте изображение так, чтобы видеть северо-восточную оконечность Евразии. Ваше изображение должно выглядеть аналогично показанному ниже:

\includegraphics{images/Ex01_WorldMap/Chukotka.png}

Также обратите внимание на изображение Антарктиды. \textbf{Из-за смещения центрального меридиана этот континет отрисовывается с ошибками}, но в рамках данного упражнения мы их проигнорируем.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{19}
\tightlist
\item
  Отобразите набор данных в полном охвате (\texttt{Ctrl+Shift+F} или кнопка \includegraphics{images/Ex01_WorldMap/fullExtentButton.png} на панели навигации) и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №2.} Окно QGIS после настройки системы координат

Вы настроили систему координат проекта (проекцию для будущей карты). Теперь вы начнёте работать с визуализацией слоя государств.

\hypertarget{map-design-world-colorbrewer}{%
\section{Окраска стран в разные цвета}\label{map-design-world-colorbrewer}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Переименуйте слой \texttt{ne\_110m\_admin\_0\_countries}. Назовите его \texttt{Страны}.
\item
  Откройте таблицу атрибутов слоя \texttt{Страны}. Для этого нажмите правой кнопкой мыши на название слоя в таблице слоёв и выберите пункт «Открыть таблицу атрибутов».
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/attributetable.png}

Таблица атрибутов является представлением базы данных, сопоставленной набору пространственных данных. Каждый объект на карте имеет массу семантической (атрибутивной) информации. Например, в том наборе, который вы сейчас используете, есть названия стран на различных языках, текстовые характеристики уровня экономического развития и многое другое. Но сейчас нас интересуют столбцы с названием \texttt{MAPCOLOR}.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Изучите столбец \texttt{MAPCOLOR7}. Сколько различных уникальных значений присвоено объектам в полях этого столбца?
\end{enumerate}

В настоящий момент все страны обозначены в окне проекта при помощи одного и того же условного знака. На политических картах различные территории обычно отображаются различными цветами, причём цвета могут повторяться. Столбец \texttt{MAPCOLOR7} (и соседние с ним столбцы) специально созданы разработчиками Natural Earth, чтобы закодировать отображение стран разными цветами. При этом цифры в столбце не означают какой-то конкретный цвет --- это просто условные «коды», которыми ГИС-специалист может пользоваться для присвоения различных условных знаков. Мы изменим способ визуализации слоя таким образом, чтобы каждому уникальному значению поля \texttt{MAPCOLOR7} соответствовал свой цвет. Но сначала подберём нужную палитру цветов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Перейдите на сайт \href{https://colorbrewer2.org/}{ColorBrewer}. Выясните, для чего он предназначен, каким функционалом обладает.

  \begin{quote}
  Примечание: ColorBrewer --- это палитры цветов, широко применяемые в картографии и смежных задачах. Палитры ColorBrewer интегрированы в различное популярное программное обеспечение, в том числе в QGIS. Сайт \href{https://colorbrewer2.org/}{ColorBrewer} предоставляет удобный интерфейс для выбора нужной палитры.
  \end{quote}

  \includegraphics{images/Ex01_WorldMap/colorbrewer.png}
\item
  Подберите палитру, исходя из следующих соображений:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Число цветов: по числу уникальных значений в поле \texttt{MAPCOLOR7};
\item
  Тип данных, к которым применяется палитра: качественные (\emph{qualitative});
\item
  Из доступных вариантов выберите палитру мягких, так называемых «пастельных» цветов.
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Запомните или запишите название выбранной палитры. Сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №3.} Окно браузера с выбранной палитрой ColorBrewer

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Вернитесь в QGIS. Откройте окно свойств слоя \texttt{Страны}. Для этого дважды щёлкните левой кнопкой мыши по названию слоя или нажмите на него правой кнопкой мыши, а в контекстном меню выберите «Свойства\ldots»
\item
  Основная вкладка для настройки визуализации слоя --- это вкладка «Оформление». Как видите, сейчас для слоя применён стиль «Обычный знак». Это значит, что все объекты слоя изображаются на карте при помощи одного и того же условного знака.
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/style.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Измените способ визуализации с «Обычный знак» на «Уникальные значения». Внешний вид окна сильно изменится.
\item
  Ниже, в поле «Значение», выберите из выпадающего списка поле \texttt{MAPCOLOR7}. Мы возьмём значения из этого поля и каждому из них присвоим свой условный знак.
\item
  Найдите кнопку «Классифицировать» в нижней части окна и нажмите на неё. QGIS автоматически выберет все уникальные значения из столбца и присвоит им случайные цвета. Окно настройки примет вид, аналогичный этому:
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/Map_classes.png}

Обратите внимание, что в таблице значений больше записей, чем уникальных значений в поле \texttt{MAPCOLOR7}. QGIS автоматически добавляет строку «\emph{все другие значения}» на случай, если после редактирования слоя в столбец добавляют новые, не встречавшиеся ранее значения. Без специального знака «\emph{все другие значения}» объекты с новыми значениями прост не будут отображаться на карте.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\tightlist
\item
  Примените изменения, закройте окно свойств слоя, сохраните проект и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №4.} Окно QGIS с визуализацией стран с помощью случайно заданных цветов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\item
  Вновь откройте окно свойст слоя на вкладке «Оформление».
\item
  В таблице значений удалите запись «\emph{все другие значения}». Мы не будем редактировать слой, а значит, можем быть уверены, что никаких новых значений не появится.
\item
  Измените палитру цветов. Для этого щёлкните правой кнопкой мыши на выпадающем меню «Градиент» и выберите пункт «Создать новый градиент»
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/gradient.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{13}
\item
  В открывшемся окне выберите тип градиента: «Каталог: ColorBrewer» и нажмите OK.
\item
  В новом открывшемся окне введите два параметра:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Имя схемы: название палитры, которое вы запомнили на шаге 4;
\item
  Цвета: необходимое число цветов
\end{itemize}

Выбранные настройки палитры будут автоматически применены к слою. Картографическое изображение примет вид, аналогичный представленному ниже:

\includegraphics{images/Ex01_WorldMap/Stage2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{15}
\tightlist
\item
  Последний штрих к изображению стран --- удаление обводки. На следующих шагах мы добавим другие слои, с помощью которых изобразим береговую линию и границы государств, поэтому обводка полигонов слоя государств будет нам только мешать. Чтобы удалить обводку, вернитесь в свойства слоя на вкладку «Оформление», нажмите на поле «Знак», выберите слой \emph{Simple Fill} в перечне слоёв знака и установите для параметра «Стиль обводки» значение «Без обводки».
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/outline.gif}

\textbf{Снимок экрана №5.} Окно QGIS с визуализацией стран с помощью специально заданной палитры.

\hypertarget{map-design-world-other-layers}{%
\section{Добавление других слоёв на карту}\label{map-design-world-other-layers}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Загрузите с сайта Natural Earth следующие наборы данных, соответствующие детальности вашей карты:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  береговую линию (\emph{Coastline})
\item
  сухопутные границы (\emph{Boundary Lines})
\item
  Населённые пункты (\emph{Populated Places})
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Распакуйте содержимое архивов в ту же директорию, где находится шейп-файл государств. Удалите лишние файлы.
\item
  Добавьте загруженные наборы данных в ваш проект QGIS. Переименуйте их следующим образом: «Береговая линия», «Границы», «Населённые пункты».
\item
  Расставьте слои в следующем порядке:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Населённые пункты
\item
  Береговая линия
\item
  Границы
\item
  Страны
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Примените следующие настройки визуализации слоёв линейной геометрии
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Береговая линия: линии синего цвета толщиной 0,26 мм
\item
  Границы государств: линии серого цвета толщиной 0,26 мм
\end{itemize}

Самостоятельно изучите интерфейс настройки цвета в QGIS

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\item
  Примените следующие настройки для слоя населённых пунктов: условный знак \texttt{city} из библиотеки QGIS, размер 1,2 мм.
\item
  Помимо добавленных слоёв, нам необходим слой для изображения океанов. К сожалению, из-за несовершенства QGIS вы не можете воспользоваться для этой цели набором данных с Natural Earth. Загрузите шейп-файл океанов по \href{https://1drv.ms/u/s!AmtmZDq3JgxHgZswh2sFnErE-JEmGw?e=xoZW4c}{этой ссылке}. Распакуйте шейп-файл в папку с другими шей-файлами и добавьте его в проект.
\item
  Переименуйте добавленный слой в «Океан» и расположите его в самом низу таблицы слоёв.
\item
  Задайте для слоя «Океан» условный знак в виде заливки светло-голубого цвета без обводки.
\item
  Сохраните проект и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №6.} Окно QGIS с оформленным картографическим изображением.

\hypertarget{map-design-world-layout}{%
\section{Создание компоновки карты}\label{map-design-world-layout}}

\protect\hyperlink{map-design-world}{В начало упражнения ⇡}

Изображение, которое вы создали --- ещё не карта. Нужно создать компоновку карты --- разместить картографическое изображение на листе бумаги, добавить название, масштабную линейку и другие элементы зарамочного оформления.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте новый макет (\texttt{Ctrl+P} или «Проект» --- «Создать макет\ldots»). В небольшом диалоговом окне, появляющемся при создании макета, введите его название --- свою фамилию на русском языке. Нажмите ОК.
\item
  На экране откроется отдельное окно настройки компоновки. В центре его --- белый прямоугольник, имитирующий лист бумаги. Панели по краям экрана предназначены для добавления и настройки элементов макета.
\item
  Найдите и активируйте инструмент добавления карты к макету \includegraphics{images/Ex01_WorldMap/addMapTool.png}.
\item
  Продумайте, как будет расположена карта на вашем листе. Обязательно запланируйте отступ 2--2,5 см от края листа с каждой стороны.
\item
  Переместите курсор на лист в положение, соответствующее планируемому положению северо-западного угла карты.
\item
  Зажав левую кнопку мыши, ведите курсор к планируемому положению юго-восточного угла карты.
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/addMap.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Пока элемент карты выбран, в правой части окна компоновки отображается панель свойств элемента. Найдите в нём раздел «Положение и размер» и установите размер карты равным 260×130 мм
\item
  В той же панели задайте знаменатель масштаба картографического изображения равным 130 000 000.
\item
  Пользуясь инструментом перемещения содержимого элемента (\includegraphics{images/Ex01_WorldMap/moveElementButton.png}), измените положение изображения карты так, чтобы вписать её в рамки
\end{enumerate}

\includegraphics{images/Ex01_WorldMap/moveMap.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\item
  Добавьте к макету текст и напишите в нём название карты. Подберите форму и размер шрифта. Расположите название над картой.
\item
  Добавьте к карте масштабную линейку.
\item
  Добавьте к карте текст и укажите в нём автора карты.
\item
  Экспортируйте изображение в формат PNG
\end{enumerate}

\hypertarget{map-design-quaternary}{%
\chapter{Создание карты четвертичных отложений}\label{map-design-quaternary}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex03.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex03_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{map-design-quaternary-intro}{%
\section{Введение}\label{map-design-quaternary-intro}}

\textbf{Цель задания} --- закрепление навыков загрузки и визуализации данных в QGIS.

\textbf{Необходимая теоретическая подготовка:} модели пространственных данных, модели пространственных объектов, базы пространственных объектов, картографические проекции.

\textbf{Необходимая практическая подготовка:} в объёме упражнения 1.

\textbf{Исходные данные:} база геоданных ESRI на территорию Сатинского учебного полигона, Калужская область.

\textbf{Ожидаемый результат:} карта четвертичных отложений Сатинского полигона М 1:30 000

\hypertarget{map-design-quaternary-checklist}{%
\subsection{Контольный лист}\label{map-design-quaternary-checklist}}

\begin{itemize}
\tightlist
\item
  Добавить на карту источники пространственных данных
\item
  Импортировать символику
\item
  Настроить подписи объектов
\item
  Создать набор пространственных данных из текстового файла
\item
  Создать компоновку карты и легенду
\item
  Экспортировать результат в графический файл
\end{itemize}

\hypertarget{map-design-quaternary-begin}{%
\section{Начало работы}\label{map-design-quaternary-begin}}

\protect\hyperlink{map-design-quaternary}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скачайте архив с исходными данными для упражнения и распакуйте его в свою рабочую директорию.

  В вашей рабочей директории появилась «папка» \texttt{Satino.gdb}. Зайдя в неё с помощью проводника или Finder'a, вы увидите множество файлов с различными расширениями (\emph{.spx, }.gdbtable, *.gdbtablx и др.). Ничего не редактируйте в этой «папке».
\item
  Запустите \textbf{QGIS} и сразу сохраните проект в своей рабочей директории, на одном иерархическом уровне с \texttt{Satino.gdb}. Назовите его по шаблону \texttt{Ex02\_\%Фамилия.qgz\%}.

  \begin{quote}
  Примечание: не забывайте периодически сохранять проект QGIS!
  \end{quote}
\item
  Откройте Менеджер источников данных и разверните содержимое базы \texttt{Satino.gdb}

  \includegraphics{images/Ex02/ArcGIS_GDB.png}

  Вы видите список наборов пространственных данных, хранящихся в базе \texttt{Satino.gdb}. Это векторные наборы различной геометрии (точечной, линейной и полигональной).

  \begin{quote}
  База геоданных ESRI (*.gdb) --- основной формат, используемый линейкой программных продуктов ArcGIS. В базах геоданных могут храниться как векторные, так и растровые данные. Кроме того, базы геоданных поддерживают специальные возможности (подтипы, доменты) и структуры данных (топологические и сетевые наборы).
  \end{quote}

  \begin{quote}
  QGIS способен получать доступ к базам геоданных ESRI в режиме чтения, но не в режиме редактирования. И даже эти возможности ограничены: QGIS «видит» векторные наборы пространственных данных, но «не считывает» структуру базы (классы и наборы пространственных объектов), растровые наборы, топологию и другие элементы, специфические для ArcGIS. В частности, набор DEM, который отображается в браузере как векторный полигональный набор данных, на самом деле является растровым набором.
  \end{quote}
\end{enumerate}

\hypertarget{map-design-quaternary-data}{%
\section{Добавление данных в проект}\label{map-design-quaternary-data}}

\protect\hyperlink{map-design-quaternary}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту наборы \texttt{WaterLine}, \texttt{WaterPolygon} и \texttt{QDeposit}.

  \textbf{Вопрос 1:} какая система координат присвоена для каждого набора данных? Какая проекция используется для этой системы координат? К какому виду относится эта проекция по характеру искажений? Для чего она применяется?\\
  \textbf{Вопрос 2:} какая система координат присвоена проекту QGIS после добавления набора данных?
\item
  Настройте визуализацию слоёв \texttt{WaterLine} и \texttt{WaterPolygon}, используя условные знаки из библиотеки QGIS. Окно QGIS должно принять вид, аналогичный рисунку ниже:

  \includegraphics{images/Ex02/Example1.png}
\item
  Откройте таблицу атрибутов слоя \texttt{QDeposit} и изучите её.

  \includegraphics{images/Ex02/AttributeTable.png}

  Вы видите индексы и текстовые описания четвертичных отложений. Далее вы визуализируете слой QDeposit таким образом, что каждому типу отложений (\texttt{Deposit}) будет сопоставлен уникальный условный знак.
\end{enumerate}

\hypertarget{map-design-quaternary-classification}{%
\section{Применение готового стиля к слою}\label{map-design-quaternary-classification}}

\protect\hyperlink{map-design-quaternary}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя \texttt{QDeposit}.
\item
  На вкладке «Стиль» измените тип отображения на \emph{Уникальные значения} и настройте классификацию по полю \texttt{Index} c использованием случайных цветов (\emph{Random colors}). Закройте свойства слоя и оцените результат.

  \textbf{Скриншот 1:} результат классификации --- отображение каждого типа отложений уникальным цветом.
\item
  Изображение стало более «пёстрым», но не стало более читаемым. Человеческому глазу трудно распознать два десятка уникальных оттенков цвета. Кроме того, исходя из географической логики, родственным категориям должны быть присвоены схожие цвета.

  Разработка цветовых решений для сложных, комплексных карт является отдельной научной задачей. В этом упражнении вы будете использовать готовые наборы стилей.
\item
  В левом нижнем углу вкладки «Стиль» найдите кнопку «Стиль». Нажмите на неё и выберите опцию «Загрузить стиль». В открывшемся окне в строчке «Файл» найдите стилевой файл \texttt{QDeposit.qml}. Загрузите из этого файла всю доступную символику.

  \begin{quote}
  QGIS, как и другое геоинформационное ПО, позволяет сохранять настройки отображения слоя в отдельный стилевой файл. Поддерживаются два формата: QGIS Layer Style File (\emph{.qml) и Styled Layer Descriptor (}.sld). В проприетарном ПО (ArcGIS, MapInfo) используются другие форматы описания стилей. Как правило, они несовместимы друг с другом.
  \end{quote}

  \textbf{Скриншот 2:} изображение готового слоя после импорта символики
\item
  Изучите условные знаки, применённые для слоя, и ответьте на вопросы:

  \textbf{Вопрос 3}: чем отличается условный знак, применённый для биогенных отложений, от всех прочих условных знаков? Каким образом это осуществлено?

  \textbf{Вопрос 4}: как соотносятся записи в таблице атрибутов (поле Deposit) и записи в поле «Легенда» в настройках стиля условных знаков?
\item
  Настройте подписи для слоя. Для подписывания используйте поле Index. Настройки подписей определите самостоятельно.
\end{enumerate}

\hypertarget{map-design-quaternary-csv}{%
\section{Создание набора пространственных данных из таблицы с координатами}\label{map-design-quaternary-csv}}

\protect\hyperlink{map-design-quaternary}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Найдите в проводнике файл \texttt{geol\_points.csv} и откройте его с помощью простого текстового редактора (Блокнот или аналогичный). Изучите содержимое файла.

  \includegraphics{images/Ex02/csv.png}

  \begin{quote}
  Comma-Separated Values (CSV) --- простой текстовый формат, предназначенный для хранения табличных данных. Каждая строка представляет строку таблицы, а ячейки, соответствующие столбцам, разделяются специальными символами. В качестве такого символа может быть использована запятая, точка с запятой, знак табуляции или сочетание из нескольких символов.
  \end{quote}

  В представленном файле вы видите два столбца --- X и Y. Это представление координат точек. Система координат, которая использовалась при создании файла, совпадает с системой координат вашего проекта. На следующих шагах вы загрузите эту таблицу в QGIS как набор пространственных данных.
\item
  Откройте панель менеджера источников данных и перейдите на вкладку \emph{Delimited Text}. Поскольку текстовый файл не содержит сведений, необходимых для корректного импорта и визуализации, мы будем настраивать параметры импорта вручную.
\item
  Нажмите значок с символом \texttt{...} справа от первого поля и в окне Проводника откройте файл \texttt{geol\_points.csv}. Не меняйте имя слоя и кодировку.

  \begin{quote}
  Примечание: в дальнейшем в вашей практике будут встречаться CSV-файлы, созданные в различных кодировках. В таких случаях нужно будет выбрать (или подобрать) правильную кодировку. Проверить себя можно по образцу загружаемой таблицы, который отображается в нижней части интерфейса загрузчика.
  \end{quote}
\item
  В первом блоке настроек («Формат файла») установите корректный разделитель столбцов.
\item
  Во втором блоке настроек («Настройки полей и записей») установите нужные параметры самостоятельно.
\item
  В третьем блоке настроек («Геометрия») определите, какие поля содержат координаты точек, и установите целевую систему координат --- такую же, как система координат проекта.
\item
  В блоке «Настройки слоя» не меняйте значения, определённые по умолчанию.
\item
  Проверьте себя, посмотрев блок «Примеры данных». Если настройки заданы правильно, в этом блоке будут корректно отображены первые 20 строк таблицы (не считая заголовков).

  \textbf{Скриншот 3:} Окно настроек импорта CSV-файла
\item
  Нажмите кнопку «Добавить», чтобы добавить слой на карту.
\item
  Настройте условные знаки для добавленного слоя. Отобразите все разрезы чёрными кругами диаметром 1,4 мм без обводки.
\end{enumerate}

\hypertarget{map-design-quaternary-final}{%
\section{Оформление карты}\label{map-design-quaternary-final}}

\protect\hyperlink{map-design-quaternary}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Создайте макет карты в портретной ориентировке и добавьте на него картографическое изображение.
\item
  Установите следующие параметры элемента карты: ширина 170 мм, высота 140 мм, масштаб картографического изображения 1:30 000.
\item
  Разместите элемент карты в верхней половине листа
\item
  Настройте сетку \textbf{прямоугольных} координат для карты в виде перекрестий.

  \begin{quote}
  \emph{Подсказка: используйте для сетки ту же систему координат, которая применена для проекта QGIS в целом}
  \end{quote}
\item
  Добавьте зарамочное оформление: название карты, легенду, масштабную линейку.
\item
  Экспортируйте карту в формат PNG и вставьте её в отчётный документ.

  \begin{quote}
  \emph{Подсказка: используйте опцию «Обрезать по содержимому», чтобы сохранить размеры изображения в отчётном документе}
  \end{quote}
\end{enumerate}

\hypertarget{map-design-population}{%
\chapter{Создание социально-экономической карты}\label{map-design-population}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex04.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex04_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{map-design-population-intro}{%
\section{Введение}\label{map-design-population-intro}}

\textbf{Цель задания} --- закрепление навыков загрузки и визуализации данных в QGIS.

\textbf{Необходимая теоретическая подготовка:} модели пространственных данных, модели пространственных объектов, базы пространственных объектов, картографические проекции.

\textbf{Необходимая практическая подготовка:} в объёме упражнения 1.

\textbf{Исходные данные:} база пространственных данных на территорию Российской Федерации

\textbf{Ожидаемый результат:} тематическая карта «Население России» масштаба 1:35 000 000

В этом упражнении вы закрепите базовые навыки визуализации с использованием программных средств ГИС, составив карту населения Российской Федерации в разрезе субъектов фередации и крупных населённых пунктов. На картах населения, как правило, изображается людность городов (способом значков) и плотность населения (способом количественного фона). В рамках упражнения мы не будем пытаться выполнить «объективное» районирование территории по естественным градациям плотности населения; вместо этого воспользуемся обобщённой статистикой по плотности населения субъектов РФ.

\hypertarget{map-design-population-checklist}{%
\subsection{Контольный лист}\label{map-design-population-checklist}}

\begin{itemize}
\tightlist
\item
  Добавить на карту источники пространственных данных
\item
  Импортировать символику
\item
  Настроить подписи объектов
\item
  Создать набор пространственных данных из текстового файла
\item
  Создать компоновку карты и легенду
\item
  Экспортировать результат в графический файл
\end{itemize}

\hypertarget{map-design-population-begin}{%
\section{Начало работы}\label{map-design-population-begin}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скачайте архив с исходными данными для упражнения и распакуйте его в свою рабочую директорию.
\item
  Запустите \textbf{QGIS}. Нажмите кнопку \textbf{Сохранить} и сохраните проект QGIS (файл формата \texttt{.qgz}) в распакованную папку (\emph{Ex03\_PopulationMap}) под именем \texttt{Ex03\_\%Фамилия\%}. Папка \emph{Ex03\_PopulationMap} теперь является расположением по умолчанию для проекта.
\item
  Откройте \textbf{Менеджер источников данных}, на вкладке \textbf{Браузер} найдите и разверните \textbf{Размещение по умолчанию для проекта}. Вы видите там файл проекта, который вы только что сохранили, и базу данных \texttt{RussiaPopulationMap.gpkg}.
\item
  Разверните содержимое базы \texttt{RussiaPopulationMap.gpkg}.

  \includegraphics{images/Ex03/GeoPackageStructure.png}

  \begin{quote}
  Файл формата GeoPackage (*.gpkg) представляет собой базу данных SQLite, внутри которой содержатся таблицы с данными и таблицы с метаданными. В отличие от шейп-файлов, GeoPackage хранит всю необходимую информацию в одном файле. Это позиционируется как одно из главных преимуществ формата.
  \end{quote}

  Один файл формата GeoPackage может хранить один или несколько наборов пространственных данных. В терминологии разработчиков формата разные наборы данных внутри базы называются \emph{слоями} (\emph{layers}) или \emph{таблицами данных} (\emph{data tables}). В браузере менеджера источников данных они отображаются с использованием разных значков в зависимости от типа геометрии:

  \begin{itemize}
  \tightlist
  \item
    \includegraphics{images/Ex03/points.png} точки;
  \item
    \includegraphics{images/Ex03/polylines.png} линии;
  \item
    \includegraphics{images/Ex03/polygons.png} полигоны.
  \end{itemize}

  Как и в случае с шейп-файлами, один набор данных может содержать объекты только одного типа геометрии.
\item
  Добавьте на карту все наборы из базы \texttt{RussiaPopulationMap.gpkg}. Для добавления набора дважды щёлкните по его названию левой кнопкой мыши.
\item
  В панели \textbf{Слои} основного окна QGIS расположите слои в следующем порядке:

  \begin{itemize}
  \tightlist
  \item
    cities (города)
  \item
    coastline (береговая линия)
  \item
    boundaries (государственные границы)
  \item
    lakes (озера)
  \item
    regions (регионы РФ)
  \item
    neighbouring countries (соседние страны)
  \end{itemize}
\item
  Используя кнопку \includegraphics{images/Ex03/full_extent.png} \textbf{Полный охват} или комбинацию клавиш \texttt{Ctrl+Shift+F}, измените охват изображения, чтобы во фрейме карты отобразились все объекты из добавленных слоёв.

  \includegraphics{images/Ex03/FullExtent_WGS84.png}

  Как видите, изображение выглядит немного странно и мало похоже на карту России. Поскольку Чукотский автономный округ расположен одновременно в западном и восточном полушариях, его изображение разрывается, если в проекте используется географическая система координат (что соответствует цилиндрической равнопромежуточной по меридианам проекции). Для карт России обычно применяются конические проекции, причём многих из них нет в международных базах данных. На следующем шаге мы выберем для карты подходящую проекцию и систему координат.
\end{enumerate}

\hypertarget{map-design-population-change-crs}{%
\section{Изменение системы координат проекта}\label{map-design-population-change-crs}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте \textbf{Свойства проекта}, а в них --- вкладку \textbf{Система координат}

  \begin{quote}
  Это можно сделать одним из следующих способов: из меню \textbf{Проект} --- \textbf{Свойства\ldots{}}, при помощи сочетания клавиш \texttt{Ctrl+Shift+P} или нажатием на надпись \texttt{EPSG:4326} в правом нижнем углу окна QGIS. Рекомендуем пользоваться последним способом, поскольку он сразу открывает нужную вкладку.
  \end{quote}
\item
  В строке поиска введите \texttt{Asia\_North}, чтобы отфильтровать список доступных систем координат. Теперь в списке предустановленных систем координат (\emph{Predefined coordinate systems}) отображаются только системы координат, название которых включает символы \texttt{Asia\_North}.

  \includegraphics{images/Ex03/CoordinateSystem.png}
\item
  Выберите из списка систему координат в конической равновеликой проекции (\emph{Equal Area Conic}).
\item
  Нажмите \textbf{ОК}.
\item
  Установите масштаб карты равным \textbf{1:35 000 000}.
\end{enumerate}

\textbf{Снимок экрана №1.} Окно QGIS после изменения системы координат проекта

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Сохраните проект QGIS. Запишите файл проекта (\texttt{*.qgz}) в папку с исходными данными и назовите его по шаблону \texttt{Ex03\_\%Фамилия\%}.
\end{enumerate}

\begin{quote}
Примечание: в дальнейшем мы не будем напоминать вам о необходимости сохранять
\end{quote}

\hypertarget{map-design-population-fill-color}{%
\section{Создание картограмм}\label{map-design-population-fill-color}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

Для отображения относительных показателей по единицам административно-территориального деления используется способ изображения, который в русской картографической традиции называется \textbf{картограммой}. Картограмму очень просто сделать в ГИС, если у вас есть набор пространственных данных, пригодный для картографирования.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте таблицу атрибутов слоя \textbf{regions}. Найдите в этой таблице поле \texttt{population\_density}. Это поле таблицы хранит значения плотности населения по субъектам РФ.

  \includegraphics{images/Ex03/attribute_table.png}
\item
  Закройте таблицу атрибутов. Откройте свойства слоя \textbf{regions} и перейдите на вкладку \textbf{Стиль}.
\item
  В верхней части окна выберите из выпадающего списка метод визуализации \emph{Градуированный знак}

  \includegraphics{images/Ex03/graduated_colors.png}
\item
  Во втором поле выберите столбец таблицы атрибутов, значения которого будут использованы для создания визуализации. Вам нужно выбрать из выпадающего списка поле, хранящее информцию о значениях плотности населения.

  \includegraphics{images/Ex03/field.png}

  \begin{quote}
  Значения, взятые из выбранного поля, будут классифицированы, то есть разделены на диапазоны, с использованием одного из доступных в QGIS метода классификации. Каждому диапазону сопоставляется уникальный условный знак. Все пространственные объекты, значения выбранного атрибута которых попадают в один и тот же диапазон, будут изображены на карте с использованием этого условного знака. Метод визуализации \emph{Градуированный знак} предполагает, что условные знаки будут отличаться цветом фона, и эти цвета определяются на основе заданного градиента цветов.
  \end{quote}
\item
  Нажмите \textbf{правой кнопкой мыши} на содержимое параметра \textbf{Градиент}. В открывшемся меню перейдите к пункту \textbf{Все градиенты} и выберите градиент \textbf{Oranges}

  \includegraphics{images/Ex03/gradient.png}
\item
  После всех применённых настроек блок классов (\emph{Classes}) остаётся пустым. Чтобы классифицировать имеющееся множество значений, нажмите кнопку \textbf{Классифицировать}. Классификация будет выполнена с использованием метода естественных разрывов (\emph{Natural Breaks}), который используется в QGIS по умолчанию.
\item
  Нажмите \textbf{ОК}, чтобы применить изменения и закрыть окно свойств слоя. Изображение должно принять вид, аналогичный рисунку ниже.

  \includegraphics{images/Ex03/jenks.png}

  \begin{quote}
  Существует множество методов классификаций: равных интервалов, квантилей, стандартных отклонений и т.д. По умолчанию в большинстве геоинформационных продуктов используется метод естественных интервалов: считается, что он в среднем неплохо отражает особенности распределения. Следует знать, однако, что этот метод классификации плохо справляется с распределениями, обладающими значительной асимметрией и эксцессом (\emph{heavy-tail distribution}). Кроме того, интервалы, генерируемые этим методом, не обладают свойством наглядности. На следующем шаге мы отредактируем применяемую классификацию.
  \end{quote}
\item
  Снова откройте окно свойств слоя на вкладке \textbf{Стиль}. Проверьте, что опция \textbf{Связать границы классов} (ниже кнопки \textbf{Классифицировать}) включена.
\item
  Используя поле ввода в правой части окна, измените число классов на 7.

  \includegraphics{images/Ex03/classes.png}
\item
  Теперь мы отредактируем вручную границы классов. Дважды щёлкните левой кнопкой мыши по значениям первого класса в списке. Откроется окно редактирования границ классов

  \includegraphics{images/Ex03/classes_editing.png}
\item
  Введение следующие параметры:

  \begin{itemize}
  \tightlist
  \item
    нижнее значение: \textbf{0}
  \item
    верхнее значение: \textbf{1}
  \end{itemize}
\item
  Нажмите \textbf{ОК} в окне редактирования границ классов. Вы выделили в отдельный класс регионы РФ со средней плотностью менее 1 человека на квадратный километр. Обратите внимание, что нижняя граница следующего класса тоже изменилась. Это произошло потому, что исполььзуется опция \textbf{Связать границы классов}. Это ускорит для вас процесс редактирования границ других классов
\item
  Измените границы следующих классов в соответствии со следующим списком:

  \begin{itemize}
  \tightlist
  \item
    1 -- 5;
  \item
    5 -- 10;
  \item
    10 -- 20;
  \item
    20 -- 50;
  \item
    50 -- 100;
  \item
    100 -- 5000
  \end{itemize}
\item
  Нажмите \textbf{OK}, чтобы применить новые настройки и закрыть окно свойств слоя.
\end{enumerate}

\textbf{Снимок экрана №2.} Окно QGIS после настройки визуализации слоя регионов РФ

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{14}
\item
  Вы настроили визуализацию слоя, но прежде чем переходить к другим слоям, необходимо сделать ряд косметических изменений. Начните с переименования слоя. В таблице слоёв щёлкните правой кнопкой мыши по названию слоя \textbf{regions}, выберите пункт меню \textbf{Переименовать} и введите для слоя новое название: \textbf{Плотность населения, чел/км²}.
\item
  Теперь измените отображение некоторых классов в легенде. Снова откройте свойства слоя на вкладке \textbf{Стиль}. В таблице классов в колонке \textbf{Легенда} отображаются названия классов в таком виде, в котором они будут показаны в легенде. Дважды щёлкните на подписи легенды класса «0 -- 1». Введите вручную новую подпись для легенды: \textbf{менее 1}.
\item
  Аналогичным образом измените запись в легенде для класса «100 -- 5000»: \textbf{более 100}.
\item
  Примените изменения и закройте окно свойств слоя.
\item
  Зажимая левой кнопкой мыши и перетаскивая записи в таблице, измените их порядок так, чтобы они были отсортированы по убыванию:

  \includegraphics{images/Ex03/descending_order.png}
\end{enumerate}

Вы закончили настраивать отображение слоя картограммы и можете перейти к настройке следующего слоя.

\hypertarget{map-design-population-symbols}{%
\section{Создание шкалы значков}\label{map-design-population-symbols}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

Плотность населения на картах обычно отображается с помощью шкалы значков. Вы создадите такую шкалу, используя положения населённых пунктов и данные из таблицы атрибутов соответствующего набора данных.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте таблицу атрибутов слоя \textbf{cities}. Найдите в этой таблице поле \texttt{population\_2020}. Это поле таблицы хранит значения численности населения по городам РФ (в тысячах человек).
\item
  Закройте таблицу атрибутов. Откройте свойства слоя \textbf{cities} и перейдите на вкладку \textbf{Стиль}.
\item
  В верхней части окна выберите из выпадающего списка метод визуализации \emph{Градуированный знак}
\item
  Во втором поле выберите столбец таблицы атрибутов, значения которого будут использованы для создания визуализации. Вам нужно выбрать из выпадающего списка поле, хранящее информцию о значениях численности населения.
\item
  Нажмите на кнопку \textbf{Значок}. В открывшемся меню выберите новый символ для значка --- \emph{Dot Purple}

  \includegraphics{images/Ex03/dot_purple.png}
\item
  В поле \textbf{Метод} поменяйте вариант \emph{Цвет} на вариант \emph{Размер}. Для отображения различных классов будут использоваться значки разных размеров.
\item
  Настройки поля \textbf{Размер} (\emph{Size from \ldots{} to \ldots{}}) служат для изменения размера значков. Оставьте значения, предложенные QGIS по умолчанию.
\item
  Нажмите кнопку \textbf{Классифицировать}. В списке классов появится пять записей.
\item
  Измените границы классов в соответствии со следующим списком:

  \begin{itemize}
  \tightlist
  \item
    100 -- 200;
  \item
    200 -- 500;
  \item
    500 -- 1000;
  \item
    1000 -- 5000;
  \item
    5000 -- 15000;
  \end{itemize}
\item
  Переименуйте элемент легенды, соответствующей классу с самыми большими значениями. Установите новую подпись \textbf{более 5000}
\item
  Измените порядок строк в таблице таким образом, чтобы значения располагались по убыванию (аналогично тому, как вы делали для легенды картограммы)

  \includegraphics{images/Ex03/diagram.png}
\item
  Примените изменения и закройте окно свойств слоя.
\item
  Переименуйте слой \textbf{cities}. Задайте этому слою имя \textbf{Людность городов, тыс. чел.}
\end{enumerate}

Результат будет выглядеть приблизительно так, как показано на рисунке:

\includegraphics{images/Ex03/diagramResult.png}

\textbf{Снимок экрана №3.} Окно QGIS после настройки визуализации слоя населённых пунктов РФ

\hypertarget{map-design-population-labels}{%
\section{Добавление подписей значков}\label{map-design-population-labels}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя \textbf{cities}, вкладку \textbf{Подписи}. Эта вкладка используется для настройки подписей и содержит ряд вложенных вкладок, позволяющих настраивать параметры размещения и отображения подписей. Прямо сейчас все вложенные опции отключены, поскольку используется режим \textbf{Не показывать подписи} (\emph{No labels}).
\item
  В выпадающем списке в верхней части окна измените \textbf{No labels} (\textbf{Не показывать подписи}) на \textbf{Single labels} (\textbf{Подписи по значениям одного поля}). Сразу после изменения этой настройки на вкладке откроется множество других параметров.

  \includegraphics{images/Ex03/labels01.png}
\item
  В опции \textbf{Значение} выберите поле, из которого будут взяты тексты подписей. Это поле \textbf{name\_map}
\item
  На вкладке \textbf{Текст} измените \textbf{размер} на \textbf{7}.

  \includegraphics{images/Ex03/labels02.png}

  \begin{quote}
  «Размер текста» в QGIS --- это кегль, или высота шрифта. Традиционно она измеряется в типографских пунктах (пт, \emph{pt}), так же, как в текстовых редакторах типа Microsoft Word.
  \end{quote}
\item
  Перейдите на вкладку «Буфер». Включите опцию \textbf{Показывать текстовый буфер} (\emph{Draw text buffer}). Установите для буфера размер \textbf{0,6 миллиметра}.

  \includegraphics{images/Ex03/labels03.png}
\item
  На вкладке \textbf{Размещение} установите способ размещения значков \textbf{Картографический} (\emph{Cartographic}) и расстояние \textbf{0,1 миллиметра} от границ символа (\emph{From Symbol Bounds})

  \includegraphics{images/Ex03/labels04.png}
\item
  Примените изменения и закройте окно свойств слоя.
\end{enumerate}

Результат будет выглядеть приблизительно так, как показано на рисунке ниже. Заметьте, что QGIS отрисовывает не все подписи, доступные в таблице атрибутов --- например, с высокой вероятностью не показывается подпись Москвы. Опции размещения подписей можно настраивать более детально, но это не входит в задачи этого упражнения.

\includegraphics{images/Ex03/LabelResult.png}

\textbf{Снимок экрана №4.} Окно QGIS после добавления подписей

\hypertarget{map-design-population-basemap}{%
\section{Настройка условных знаков географической основы}\label{map-design-population-basemap}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

Мы задали оформление слоям, отвечающим за тематическую нагрузку создаваемой карты. Теперь нам необходимо задать символику для всех остальных слоёв и расположить их в правильном порядке.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Переименуйте оставшиеся слои:

  \begin{itemize}
  \tightlist
  \item
    boundaries: \textbf{государственные границы}
  \item
    coastline: \textbf{береговая линия}
  \item
    lakes: \textbf{озёра}
  \item
    neighbouring\_countries: \textbf{соседние страны}
  \end{itemize}
\item
  Расположите слои в следующем порядке:

  \begin{itemize}
  \tightlist
  \item
    Людность городов
  \item
    береговая линия
  \item
    государственные границы
  \item
    озёра
  \item
    Плотность населения
  \item
    соседние страны
  \end{itemize}
\item
  Задайте для слоя береговой линии символ \textbf{simple blue line} и толщину \textbf{0,36}

  \includegraphics{images/Ex03/symbol_coastline.png}
\item
  Задайте для слоя государственных границ символ \textbf{Residental road}

  \includegraphics{images/Ex03/symbol_boundaries.png}
\item
  Задайте для слоя озёр символ \textbf{topo water}
\item
  Задайте для слоя соседних стран символ \textbf{gray 2 fill}
\end{enumerate}

Результат обновления символики слоёв будет выглядеть приблизительно так:

\includegraphics{images/Ex03/LabelResult.png}

\hypertarget{map-design-population-layout}{%
\section{Создание макета карты}\label{map-design-population-layout}}

\protect\hyperlink{map-design-population}{В начало упражнения ⇡}

Макет (\emph{Layout}) в QGIS -- это основной способ создания картографических изображений на основе визуализированных пространственных данных. Вы размещаете картографическое изображение на листе, добавляете зарамочное оформление (название, легенду, подпись масштаба и др.), и в заключение экспортируете результат в виде растровой или векторной графики.

\begin{quote}
\emph{Примечание:} в одном проекте QGIS может быть создано несколько макетов, использующих разные наборы слоёв.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Измените охват картографического изображения в основном окне QGIS так, чтобы территория России умещалась в нём целиком.
\item
  Создайте новый макет компоновки. Для этого нажмите \texttt{Ctrl+P}, воспользуйтесь пунктом меню \textbf{Проект} --- \textbf{Создать макет} или кнопкой \includegraphics{images/Ex03/LayoutButton.png} \textbf{Создать макет} на главной панели
\item
  QGIS попросит вас ввести название макета. Никаких ограничений на название не накладывается, вы можете использовать любое имя. Например, \texttt{\%Фамилия\%\_карта\_России}
\item
  Когда вы введёте название макета и нажмёте ОК, откроется новое окно --- окно вёрстки макета:

  \includegraphics{images/Ex03/LayoutBlank.png}

  Белый прямоугольник, который вы видите в центре окна, обозначает страницу бумаги, на которой вы размещаете ваше изображение. Для добавления и редактирования элементов макета используется \textbf{Панель инструментов} (см. рисунок ниже). Она может быть размещена горизонтально или вертикально.

  \includegraphics{images/Ex03/LayoutToolbar.png}
\item
  Добавьте картографическое изображение на макет. Нажмите кнопку \textbf{Добавить Карта} на Панели инструментов или выберите аналогичную опцию из меню \textbf{Добавить объект}. Затем установите курсор на то место страницы, где вы хотите поместить северо-западный (верхний левый) угол карты. Зажмите левую кнопку мыши и ведите курсор к месту, где должен располагаться юго-восточный (нижний правый) угол карты. Доведя курсор до этого места, отпустите левую кнопку мыши. Результат должен выглядеть приблизительно так, как показано на рисунке ниже:

  \includegraphics{images/Ex03/Layout01.png}

  Обратите внимание, что размер картографического изображения меньше размера страницы. Это сделано специально: мы оставляем поля для печати. Несколько позже вы ещё немного уменьшите размер изображения, чтобы разместить на листе название карты, легенду, масштабную линейку и другую необходимую информацию.

  \begin{quote}
  Примечание: перевод QGIS на русский язык всё ещё оставляет желать лучшего. В некоторых случаях ошибки незначительны (как, например, с названием опции «Добавить Карта»), но иногда неправильный перевод может сбить с толку.
  \end{quote}
\item
  Следущие несколько шагов будут посвящены настройке сетки координат для карты. Чтобы начать настройку, найдите панель \textbf{Свойства элемента}, а в ней --- вкладку \textbf{Сетки}

  \includegraphics{images/Ex03/Layout02.png}
\item
  Разверните вкладку \textbf{Сетки} и нажмите на кнопку \textbf{Добавить сетку}. Обратите внимание, что к одному картографическому изображению можно добавить несколько сеток, присвоив им разные имена. Сейчас мы этого делать не будем, нам достаточно одной сетки географических координат.

  \includegraphics{images/Ex03/Layout03.png}
\item
  Нажмите на кнопку \textbf{Modify Grid\ldots{}}, чтобы перейти к настройкам сетки
\item
  В открывшейся панели измените значения следующих параметров:

  Внешний вид:

  \begin{itemize}
  \tightlist
  \item
    \textbf{Система координат:} установите систему координат WGS 1984 (EPSG:4326)
  \item
    \textbf{Интервал по X (долготе):} 30
  \item
    \textbf{Интервал по Y (широте):} 15
  \item
    \textbf{Стиль линии:} используйте существующий стиль, но уменьшите толщину линии до 0,15 мм
  \end{itemize}

  Рамка:

  \begin{itemize}
  \tightlist
  \item
    \textbf{Вид рамки:} Exterior ticks (внешние метки)
  \item
    Отображать слева и справа только широту (latitude only)
  \item
    Отображать сверху и снизу только метки долготы (longitude only)
  \end{itemize}

  Координаты:

  \begin{itemize}
  \tightlist
  \item
    Включить опцию \textbf{Draw Coordinates} (\textbf{Показывать координаты})
  \item
    \textbf{Формат:} Decimal with Suffix (десятичные дроби с меткой направления)
  \item
    Показывать слева и справа только подписи широты
  \item
    Показывать снизу и сверху только подписи долготы
  \item
    \textbf{Точность координат:} 0 (\emph{эта настройка отвечает за число знаков после запятой})
  \end{itemize}
\item
  Вернитесь в «Свойства элемента» и найдите настройку «Фон» (англ. \emph{Background}, неправиильно переведено как «история»). Измените фон картографического изображения на светло-голубой. Таким образом вы сымитируете цветной фон морей и океанов.

  Результат будет выглядеть приблизительно так, как показано на рисунке ниже:

  \includegraphics{images/Ex03/Layout04.png}
\item
  Добавьте легенду на макет. Нажмите кнопку \textbf{Добавить Легенда}, а затем щёлкните левой кнопкой мыши возле северо-восточного угла карты. Нажмите ОК в появившемся окне настройки размера элемента. После добавления легенды макет будет выглядеть примерно так, как показано на рисунке ниже:

  \includegraphics{images/Ex03/Layout05.png}
\item
  Выберите элемент легенды и перейдите в «Свойства элемента». Найдите пункт \textbf{Элементы легенды} (Legend Items). Этот пункт позволяет вам настраивать содержимое автоматически собираемой легенды.
\item
  Отключите опцию Auto Update. Выключая эту опцию, вы «разрываете связь» между основным окном QGIS и легендой. Теперь при любых изменениях в основной карте легенда не будет обновляться автоматически. С другой стороны, это даёт вам возможность редактировать содержимое легенды.
\item
  Удалите из легенды все элементы, кроме «Людность городов» и «Плотность населения».
\item
  Измените размер и положение элементов макета таким образом, чтобы и карта, и легенда помещались на листе и не перекрывали друг друга. Результат должен выглядеть приблизительно так, как показано на рисунке ниже:

  \includegraphics{images/Ex03/Layout06.png}
\item
  Добавьте масштабную линейку на макет. Нажмите кнопку \textbf{Добавить Масштабная линейка} или воспользуйтесь аналогичной опцией из меню \textbf{Добавить Объект}. Разместите его под основным картографическим изображением.
\item
  Измените подпись единиц измерения масштабной линейки: вместо варианта «km», который используется по умолчанию, впишите «км»
\item
  Вставьте текстовые блоки: название карты и информацию об авторстве карты.
\item
  Если необходимо, измените размеры или взаимное расположение элементов, чтобы все они умещались на листе и не «прилипали» к его краям. Результат должен выглядеть приблизительно так, как показано на рисунке ниже:

  \includegraphics{images/Ex03/Layout07.png}
\item
  Экспортируйте изображение в графический файл формата PNG. Для этого используйте кнопку \includegraphics{images/Ex03/ExportButton.png} \textbf{Экспорт в изображение} или опцию меню \textbf{Макет}, имеющую такое же название. В настройках экспорта укажите целевое разрешение 300 точек на дюйм (dots per inch, dpi).
\end{enumerate}

\hypertarget{part-ux440ux435ux434ux430ux43aux442ux438ux440ux43eux432ux430ux43dux438ux435-ux434ux430ux43dux43dux44bux445-ux432-ux433ux438ux441}{%
\part{Редактирование данных в ГИС}\label{part-ux440ux435ux434ux430ux43aux442ux438ux440ux43eux432ux430ux43dux438ux435-ux434ux430ux43dux43dux44bux445-ux432-ux433ux438ux441}}

\hypertarget{raster-reference}{%
\chapter{Привязка графических материалов}\label{raster-reference}}

\href{https://github.com/aentin/qgis-course/raw/a65b77c3a8f3f122015846502ec8d0c76615f945/files/Ex05.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/a65b77c3a8f3f122015846502ec8d0c76615f945/files/Ex05_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\textbf{Внимание! Ваш преподаватель может предоставить вам другие исходные данные для выполнения этого упражнения!} При возникновении противоречий следуйте указаниям преподавателя!

\hypertarget{raster-reference-intro}{%
\section{Введение}\label{raster-reference-intro}}

\textbf{Цель задания} --- знакомство с привязкой и трансформированием растровых геоизображений.

\textbf{Необходимая теоретическая подготовка:} Системы координат и проекции карт, привязка геоизображений, трансформирование геоизображений. Разграфка, номенклатура и проекция топографических карт. Методы трансформации: аффинное, проективное, полиномиальное, метод резинового листа.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, панель слоёв, фрейм карты), умение выполнять масштабирование и перемещение по карте, определять координаты курсора.

\textbf{Исходные данные:} Растровые изображения листов топографических карт и тематических карт, сканированные космические снимки.

\textbf{Результат:} Привязанные и трансформированные растровые изображения, пригодные для непосредственно использования в ГИС.

\textbf{Аннотация:} Положение точки в пределах растрового изображения может быть определено во внутренней системе координат растра. В этой системе координаты отсчитываются от верхнего левого угла растра по направлению отсчёта строк и столбцов и измеряются, соответственно, в пикселах. Для работы в геоинформационных системах (ГИС) необходимо установить соответствие между внутренней системой координат растра и внешней (целевой) системой координат, применяемой в ГИС-проекте --- иными словами, выполнить \emph{привязку} растра. С точки зрения пользователя ГИС, привязка заключается в определении для некоторого числа точек двух пар координат: 1) пары координат во внутренней системе координат растра и 2) пары координат в целевой системе координат ГИС-проекта. Но если «внутренние» координаты могут быть легко определены, поскольку они непосредственно связаны непосредственно с растром, то целевые координаты необходимо узнавать отдельно. У некоторых видов растров --- например, у топографических карт, --- координатные метки с их численными значениями нанесены на само изображение (сетки координат). У других --- например, у космических снимков, --- эту информацию нужно определять с привлечением дополнительных источников.

Точки, используемые для привязки, должны равномерно покрывать всю площадь изображения (или по крайней мере ту его часть, которая будет использоваться в исследовании), а также ни в коем случае не находиться на одной линии.

Привязка часто сопровождается \emph{трансформацией}. В ходе трансформации растр пересчитывается в новую систему координат таким образом, что направления отсчёта строк и столбцов становятся параллельными осям координат целевой системы.

\hypertarget{raster-reference-control}{%
\subsection{Контрольный лист}\label{raster-reference-control}}

\begin{itemize}
\tightlist
\item
  Определить систему координат для привязки
\item
  Привязать растровую карту по известным координатам точек
\item
  Оценить точность привязки карты
\item
  Привязать изображение путём интерактивного определения положения точек привязки
\item
  Использовать базовые карты из сети Интернет для привязки
\end{itemize}

\hypertarget{raster-reference-input}{%
\section{Привязка растра по меткам координат}\label{raster-reference-input}}

\protect\hyperlink{raster-reference}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скачайте архив с исходными данными и распакуйте его в свою рабочую директорию.
\item
  Найдите в папке \texttt{raw\_images} изображение \texttt{o38-085.tif}. Это отсканированный лист топографической карты масштаба 1:100 000 на город Кинешма и его окрестности.
\end{enumerate}

\begin{quote}
Топографические карты на территорию СССР составлялись в проекции Гаусса-Крюгера. Задание проекции позволяет ввести систему плоских прямоугольных координат --- соответствующая сетка наносится на лист карты. Когда вы работаете с листом карты в бумажном виде, вы можете определить координаты любой точки, проведя несложные измерения относительно линий сетки, измерить расстояния, углы и площади. Использование ГИС значительно упрощает рутинные операции, поскольку все объекты в ГИС-проекте помещены в некоторую систему координат. Но простые растровые изображения таким функционалом не обладают.
Чтобы использовать растр в геоинформационной среде, необходимо выполнить его привязку --- то есть задать соотношение между внутренней системой координат растра (связанной с его строками и столбцами) и «внешней» проецированной системой координат.
\end{quote}

Для выполнения привязки нам нужно определить несколько пар точек, для которых известны и внутренние, и целевые координаты. Точки пересечения линий сетки прямоугольных координат идеально подходят в этом качестве, поскольку их целевые координаты подписаны вдоль рамок карты.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Определите прямоугольные координаты пересечений линий сетки, ближайших к углам карты. Если какое-то из пересечений читается нечётко, возьмите одно из соседних.
\item
  Запустите QGIS
\item
  В QGIS запустите инструмент для привязки растров («Слой» --- «Привязка растров»)
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference0.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Добавьте файл \texttt{o38-085.tif} в окно инструмента привязки. Можно перетащить файл из проводника или воспользоваться кнопкой \includegraphics{images/Ex05_Reference/addRasterButton.png} на панели инструментов
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\tightlist
\item
  В окне привязки по умолчанию активен инструмент добавления опорных точек \includegraphics{images/Ex05_Reference/addPointButton.png}. С помощью мыши увеличьте изображение северо-западного угла карты, а затем щёлкните левой кнопкой мыши по пересечению линий сетки, координаты которого вы определили раньше. В появившемся окне введите координаты. Обратите внимание на следующие моменты:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  В проекции Гаусса-Крюгера ось X считается направленной на север, ось Y --- на восток. В QGIS и большинстве других геоинформационных программ ось X направлена на восток, ось Y --- на север. Поменяйте местами координаты при необходимости
\item
  Координаты, подписанные вдоль рамки карты, измеряются в километрах. Координаты, которые вам нужно ввести для привязки, должны быть измерены в метрах.
\end{itemize}

Сверьтесь с изображением ниже, чтобы убедиться, что вы всё делаете правильно:

\includegraphics{images/Ex05_Reference/FirstPoint.gif}

Чтобы включить подписи идентификаторов точек, зайдите в «Параметры» --- «Настройки привязки растров»

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{7}
\item
  Аналогичным образом добавьте остальные контрольные точки по углам карты.
\item
  Добавьте ещё одну опорную точку в центре карты. Координаты определите самостоятельно

  После добавления пяти опорных точек окно привязки примет вид, аналогичный представленному на рисунке ниже:
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\item
  Изучите информацию, которая отображается в таблице внизу. «X источника» и «Y источника» --- это координаты точек привязки на исходном растре, измеренные в пикселях растра от левого верхнего угла. «X назначения» и «Y назначения» --- координаты на местности. В столбцах «dX», «dY» и «Невязка» будут отображаться несхождения в определении координат. Сейчас там отображаются нули, поскольку мы не задали настройки трансформации.
\item
  Откройте интерфейс настроек трансформации растра, нажав на кнопку \includegraphics{images/Ex05_Reference/parametersButton.png}. Изучите доступные параметры.
\item
  Самостоятельно определите значение параметра «Тип трансформации».
\item
  Параметр «Метод интерполяции» установите в значение «Линейная»
\item
  Чтобы установить целевую систему координат, нажмите кнопку \includegraphics{images/Ex05_Reference/crsButton.png}
\end{enumerate}

\includegraphics{images/Ex05_Reference/CoordinateSystem.png}

Нам необходимо выбрать целевую систему координат. Мы помним, что топографические карты составляются в проекции Гаусса-Крюгера, однако для задания системы координат этого недостаточно. Система координат состоит из двух основных элементов: геодезической основы и параметров проектирования. В геодезическую основу входят параметры вспомогательной поверхности, аппроксимирующей земной шар (для эллипсоида: большая полуось и эксцентриситет), а также ряд параметров, определяющих положение этой фигуры в теле Земли. В параметры проектирования входит вид проекции (например, равноугольная поперечно-цилиндрическая) и конкретные параметры проектирования (например, средний меридиан или широта начала отсчёта долгот).

Существуют десятки эллипсоидов и сотни проекций, что в сочетании с конкретными значениями параметров даёт тысячи возможных систем координат. Чтобы систематизировать это множество, существуют базы данных о системах координат. Крупнейшая из открытых баз создана под эгидой European Petroleum Survey Group (EPSG). Системы координат, соответствующие отечественным топографическим картам, также включены в эту базу (причём в нескольких вариантах)

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{14}
\item
  Найдите в списке систем координат две записи: \texttt{Pulkovo\ 1942\ /\ Gauss-Kruger\ zone\ 8} и \texttt{Pulkovo\ 1942\ /\ Gauss-Kruger\ 8N}. Сравните их параметры. В чём различие между двумя этими системами координат? Какую из них следует использовать в нашем упражнении? Выберите нужную систему координат и закройте окно выбора проекции
\item
  Теперь, когда вы задали параметры привязки, нужно указать, куда будет сохранён привязанный файл. Это задаётся настройкой «Целевой растр». Укажите, что растр нужно сохранить в папку \texttt{referenced\_images} под именем \texttt{o38-085\_modified.tif}. Также нужно отметить опции «Сохранить контрольные точки» (чтобы сохранить пары координат в отдельный файл) и «Открыть результат в QGIS» (чтобы резульат привязки был автоматически прикреплён к открытому проекту). Остальные параметры оставьте по умолчанию.
\item
  Закройте окно настроек привязки. Привязка не запустится автоматически: чтобы запустить процедуру, нужно нажать кнопку \includegraphics{images/Ex05_Reference/beginButton.png}. Но пока не делайте этого.
\item
  Изучите величины ошибок, которые отображаются в таблице внизу. Величины ошибок отображаются в пикселах исходного растра. Обычно в практике привязки стараются добиться, чтобы ошибка не превышала 0,5 пиксела (с рядом оговорок). В нашем же случае исходный картографический материал отсканирован с невысоким разрешением, и такой точности достичь не получится. Для учебного упражнения достаточно добиться точности порядка 1,5 пиксела. Если точность привязки какой-либо из ваших точек значительно превышает это пороговое значение, удалите точку и установите её заново.
\item
  Когда вам удастся добиться точной привязки, нажмите кнопку \includegraphics{images/Ex05_Reference/beginButton.png}. QGIS выполнит привязку и попытается добавить изображение к карте. Если при этом появится всплывающее окно выбора параметров трансформации, нажмите ОК.
\item
  Закройте окно привязки растров. Окно QGIS примет вид, аналогичный представленному ниже:

  \includegraphics{images/Ex05_Reference/QGIS1.png}

  \begin{quote}
  Примечание: в новых версиях QGIS в момент добавления нового растра в проект может появиться всплывающее окно с запросом выбора параметров трансформации. Оно появляется, если система координат проекта и система координат добавляемого набора данных основаны на разных геодезических датумах (и если этот запрос не отключён в настройках QGIS). Обсуждение точности преобразований датумов выходит за рамки нашего курса. Если вы студент-картограф, обратитесь к преподавателю за более подробными разъяснениями; остальным же достаточночно принять настройки, предагаемые по умолчанию (нажать OK).
  \end{quote}

  \includegraphics{images/Ex05_Reference/Warning.png}
\item
  Сохраните проект QGIS в рабочую директорию (\texttt{Ex05}).

  \begin{quote}
  Примечание: в дальнейшем мы не будем напоминать вам о необходимости сохранения проекта. Делайте это самостоятельно и, по возможности, чаще.
  \end{quote}
\end{enumerate}

\hypertarget{raster-reference-basemap}{%
\section{Добавление базовой карты}\label{raster-reference-basemap}}

\protect\hyperlink{raster-reference}{В начало упражнения ⇡}

Мы успешно привязали растровое изображение топографической карты, и теперь можем определять координаты, измерять расстояния и площади по карте при помощи простого ГИС-инструментария. Однако наша карта пока «висит в воздухе». Давайте сравним её с изображением какой-нибудь популярной Интернет-карты, например, Яндекс.Карт или OpenStreetMap.

Базовые карты из сети интернет могут быть загружены в настольный ГИС-пакет с использованием протокола WMS, WFS или аналогичных. На базовом уровне знакомства с ГИС нас не интересуют технические подробности реализации, поэтому мы воспользуемся простым инструментом загрузки --- подключаемым модулем (плагином) QuickMapService. Он позволяет добавлять многие карты из сети интернет «в один клик».

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Модуль QuickMapService не включается в базовую поставку QGIS, его нужно установить отдельно. Для этого откройте меню «Модули» --- «Управление и установка модулей\ldots». Дождитесь, пока сведения о модулях загрузятся.
\end{enumerate}

\includegraphics{images/Ex05_Reference/modules01.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  В открывшемся окне управления модулями начните вводить \texttt{QuickMap} в строке поиска. Модули будут отфильтрованы по названию.
\item
  Выберите модуль QuickMapServices в списке и нажмите кнопку «Установить» внизу окна. Дождитесь, пока модуль загрузится и установится.
\end{enumerate}

\includegraphics{images/Ex05_Reference/modules02.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  После установки модуля его инструменты появляются в меню «Интернет» --- «QuickMapServices». По умолчанию доступно небольшое число источников, но его можно увеличить. Для этого перейдите в настройки модуля и на вкладке «Загрузить сервисы» нажмите «Получить дополнительные источники данных». Подождите, пока дополнительные источники будут добавлены к модулю, и закройте настройки
\end{enumerate}

\includegraphics{images/Ex05_Reference/AddSources.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Теперь вы можете добавить какую-нибудь базовую карту из сети Интернет, просто выбрав её в списке. Добавьте карты Google в проект.
\item
  Включая и отключая изображение топографической карты в панели слоёв, оцените, насколько хорошо она ложится на базовую карту Google.
\end{enumerate}

\includegraphics{images/Ex05_Reference/Overlay.gif}

\begin{quote}
Для любознательных: обратите внимание на настройки прозрачности слоёв, а также на подключаемый модуль MapSwipe Tool.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Удалите из проекта карту Google и загрузите любую другую базовую карту на ваш выбор.
\item
  Уберите чёрные рамки вокруг привязанного изображения. Чтобы это сделать, можно воспользоваться следующим способом. Откройте настройки слоя привязанного снимка, перейдите на вкладку «Прозрачность» и введите дополнительное значение «нет данных», равное 0. QGIS будет воспринимать пиксели изображения, имеющие нулевую яркость, как «нет данных», и скроет их при визуализации.
\item
  Сохраните проект и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №1.} Привязанная топографическая карта на фоне базовой карты из Интернета.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\tightlist
\item
  Закройте проект QGIS.
\end{enumerate}

\hypertarget{raster-reference-frommap}{%
\section{Использование координат с базовой карты}\label{raster-reference-frommap}}

\protect\hyperlink{raster-reference}{В начало упражнения ⇡}

Топографические карты --- удобный материал для привязки, поскольку нужные системы координат известны, а точные значения координат нанесены непосредственно на карту. Однако в большинстве случаев привязка требуется таким материалам, у которых ни система координат, ни точные их значения не известны заранее --- например, архивные аэрофотоснимки и космические снимки. В таком случае придётся не вводить координаты вручную, а считывать их значения из окна карты, используя в качестве опоры какой-либо материал, уже представленный в целевой системе координат.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте новый проект QGIS и добавьте к нему в качестве базовой карты любое покрытие космических снимков (например, Google Satellite).
\item
  Переместитесь по карте на юг Российской Федерации, в окрестности города Махачкала
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference5.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Откройте модуль привязки и загрузите в него изображение \texttt{DS1023-2087DF131\_b\_crop.tif}. Это фрагмент космического снимка, полученного в середине 1960-х со спутника программы CORONA.

  \begin{quote}
  Примечание: подробнее о программе CORONA вы можете прочитать по \href{https://www.usgs.gov/centers/eros/science/usgs-eros-archive-declassified-data-declassified-satellite-imagery-1}{этой ссылке}.
  \end{quote}
\item
  Изображение на космическом снимке повёрнуто относительно изображения базовой карты. Чтобы облегчить опознавание опорных точек, мы можем повернуть изображение в основном окне QIGS. Для этого найдите в нижней правой части окна QGIS настройку «Угол поворота» и введите значение \texttt{30}.
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference7.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Начните расстановку контрольных точек. Установите первую точку нажатием левой кнопки мыши. Затем, когда появится окно ввода координат, не вводите координаты вручную, а нажмите кнопку «С карты». Окна привязки и ввода координат будут свёрнуты, давая возможность найти соответственную точку на карте. Найдя точку, кликните по ней левой кнопкой мыши. Координаты точки (в системе координат проекта) будут считаны с карты и подставлены в интерфейс ввода.
\end{enumerate}

\includegraphics{images/Ex05_Reference/PointsFromMap.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Введите таким образом координаты 15-20 точек. Следите, чтобы точки были равномерно распределены по площади снимка и не выстраивались в одну линию.
\item
  Настройте параметры привязки. Используйте полиномиальное преобразование 2-й степени. Такое преобразование иногда используется для космических снимков с сильно искажённой геометрией.
\item
  Проверьте ошибки положения точек. Поскольку исходное изображение характеризуется высокой зашумленностью и «зернитостью», в этом упражнении не нужно добиваться высокой точности привязки. Ошибка порядка 10 пикселов может считатсья приемлемой.

  \includegraphics{images/Ex05_Reference/RasterReference7a.png}
\item
  Запустите привязку. Когда привязанное изображение добавится в проект, сравните его с базовой картой.
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference8.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\item
  Если привязанное изображение хорошо «ложится» на базовую карту, закройте окно привязки. Если вы видите заметные смещения каких-либо элементов на привязанном изображении относительно базовой карты, вернитесь в окно привязки и отредактируйте опорные точки, а затем снова выполните трансформацию изображения.
\item
  Верните угол поворота окна карты в исходное значение (0°) и увеличьте изображение до охвата космического снимка.
\item
  Сохраните проект QGIS в вашу рабочую директорию и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №2.} Привязанный космический снимок на фоне базовой карты из Интернета.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{13}
\tightlist
\item
  Закройте проект QGIS
\end{enumerate}

\hypertarget{raster-reference-accuracy}{%
\section{Оценка точности привязки}\label{raster-reference-accuracy}}

\protect\hyperlink{raster-reference}{В начало упражнения ⇡}

В реальных задачах бывает необходимо не только привязать растр, но и оценить точность привязки. Для этого часть опорных точек переводятся в класс контрольных. Эти точки не участвуют в вычислении параметров преобразования, поэтому по ним можно проверять абсолютную точность привязки.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте проект, в котором вы работали с топографической картой.
\item
  Откройте окно привязки и снова загрузите в него исходное изображение топографической карты.
\item
  Загрузите опорные точки, которые вы использовали ранее для привязки этого листа карты (файл с расширением \texttt{*.points} в папке \texttt{referenced\_images}).
\item
  Настройте параметры привязки: алгоритм привязки, алгоритм трансформации, систему координат и т.д.
\item
  Теперь добавьте ещё четыре опорные точки между «угловыми» и «центральной».
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference3.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Когда вы добавите дополнительные точки, отключите их: снимите галочки в таблице возле их названий.
\end{enumerate}

\includegraphics{images/Ex05_Reference/RasterReference4.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Найдите максимальную ошибку привязки по контрольным точкам. Запишите её с точность до второго знака после запятой в отчётный файл.
\end{enumerate}

Обратите внимание, что величина ошибки измеряется в пикселах. Чтобы получить абсолютное значение, нам нужно умножить эту величину на размер пиксела на местности

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Запустите привязку растра. Добавьте привязанный растр в проект QGIS, если это не произошло автоматически.
\item
  Откройте свойства добавленного растра и выясните (на вкладке «Информация»), каков размер его пикселя в целевой системе координат
\item
  Рассчитайте максимальное значение абсолютной ошибки привязки (в метрах) и впишите это значение в отчётный файл.
\item
  Сохраните контрольные точки в новый файл и закройте проект QGIS.
\end{enumerate}

\hypertarget{raster-reference-linear}{%
\section{Интерактивная привязка растров на основе аффинного преобразования}\label{raster-reference-linear}}

\protect\hyperlink{raster-reference}{В начало упражнения ⇡}

В предыдущих разделах упражнения мы рассматривали привязку при помощи опорных точек. Но есть и другой способ, менее точный, но в ряде случаев более быстрый и удобный --- интерактивная привязка (\emph{freehand georeferencing}). Этот способ годится в следующих случаях: когда необходимо ввести в ГИС-проект эскизные материалы, выполненные с невысокой точностью («традиционная» привязка в этом сценарии практически неприменима), или если нужно привязать современные картографические материалы, для которых заранее известна система координат (например, схемы и планы, составленные на основе изображений из картографических веб-сервисов). В этом упражнении мы рассмотрим второй сценарий.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Изучите изображение \texttt{20\_okrugov\_27-04-2020\_13-32-09.png}. На какой основе оно составлено?
\item
  Создайте новый проект QGIS.
\item
  Добавьте из набора QuickMapServices ту базовую карту, на основе которой составлено изображение из п. 1

  \begin{quote}
  Примечание: по техническим причинам эта базовая карта может быть недоступна через QuickMapServices. Если она не загружается, воспользуйтесь любой другой картой общегеографического содержания (например, 2GIS Map, Bing Map, Google Road и др.)
  \end{quote}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Установите модуль \textbf{Freehand raster georeferencer}.
\end{enumerate}

\includegraphics{images/Ex05_Reference/Freehand1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Увеличьте изображение в окне QGIS таким образом, чтобы охват базовой карты, отображающейся в окне QGIS, примерно соответствовал охвату схемы избирательных округов.

  \includegraphics{images/Ex05_Reference/Freehand2.png}
\item
  Нажмите кнопку «Add Raster for Interactive Georeferencing» \includegraphics{images/Ex05_Reference/Freehand3.png}. В открывшемся диалоговом окне с помощью кнопки «Browse\ldots» укажите путь к файлу \texttt{20\_okrugov\_27-04-2020\_13-32-09.png}, а затем нажмите «Add New». Полупрозрачное изображнение отобразится поверх базовой карты.

  \includegraphics{images/Ex05_Reference/Freehand4.png}.
\item
  Изучите опции преобразования растра, доступные на панели привязки. Попробуйте двигать, масштабировать и увеличивать/уменьшать изображение. Чтобы отменить последнее действие, нажмите кнопку Undo \includegraphics{images/Ex05_Reference/Freehand4a.png}.
\item
  Верните растр в исходное положение и активируйте кнопку «Georeference raster with 2 points» \includegraphics{images/Ex05_Reference/Freehand5.png} на панели инструментов интерактивной привязки. Будет активирован режим интерактивной привязки по двум точкам.
\item
  Опознайте на привязываемом растре и на основе какую-либо общую точку (например, характерный перекрёсток). Затем подведите курсор к этой точке на привязываемом растре, зажмите левую кнопку мыши и передвиньте курсор к той же точке на основе, как показано на изображении ниже:

  \includegraphics{images/Ex05_Reference/Freehand6.gif}.
\item
  Найдите ещё одну аналогичную пару точек и повторите действия, описанные в предыдущем пункте. Если всё сделано правильно, растр должен, насколько это возможно, совпасть с основой. Если этого не произошло, воспользуйтесь кнопкой Undo \includegraphics{images/Ex05_Reference/Freehand4a.png}, а затем попробуйте ещё раз.

  \includegraphics{images/Ex05_Reference/Freehand7.png}.
\item
  Чтобы сохранить результат привязки, нажмите кнопку «Export Raster with World File» \includegraphics{images/Ex05_Reference/Freehand8.png}. Сохраните результат привязки в папку \texttt{georeferenced\_images}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{11}
\tightlist
\item
  Сохраните проект и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №3.} Привязанное изображение схемы избирательных округов..

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{12}
\tightlist
\item
  Ответьте на вопросы в контрольном листе.
\end{enumerate}

\hypertarget{digitizing-districts}{%
\chapter{Векторизация карты-схемы из сети Интернет}\label{digitizing-districts}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex06.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex06_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{digitizing-intro}{%
\section{Введение}\label{digitizing-intro}}

\textbf{Цель задания} --- знакомство с редактированием векторных пространственных данных, элементами базовых технологий ГИС (оверлей, пространственный запрос, атрибутивный запрос).

\textbf{Необходимая теоретическая подготовка:} Системы координат и проекции карт, привязка геоизображений, трансформирование геоизображений. Пространственные запросы, атрибутивные запросы, оверлей.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, панель слоёв, фрейм карты). Добавление источников пространственных данных в проект. Настройка символики и подписей объектов. Привязка растра. Создание макета, добавление карты и зарамочного оформления, экспорт макета.

\textbf{Исходные данные:} Схема районов города с сайта \href{https://neagent.info/}{НЕАГЕНТ} по состоянию на 2021 г.; набор пространственных данных о зданиях и сооружениях, созданный на основе базы OpenStreetMap

\textbf{Результат:} Набор пространственных данных с вернакулярными районами г. Новосибирск и статистикой по застройке в пределах округов. Картодиаграммы по количеству домов и степени застроенности. Картографическое изображение.

\hypertarget{digitizing-control}{%
\subsection{Контрольный лист}\label{digitizing-control}}

\begin{itemize}
\tightlist
\item
  Привязать растровую схему районов города
\item
  Создать набор пространственных данных о районах путем цифрования растровой карты
\item
  Добавить семантическую информацию о районах
\item
  Выполнить серию пространственных и атрибутивных запросов для определения структуры застройки в пределах районов
\item
  Построить картодиаграммы по полученным значениям
\item
  Подготовить проект карты с компоновкой
\end{itemize}

\hypertarget{digitizing-basedata}{%
\section{Подготовка исходных данных}\label{digitizing-basedata}}

\protect\hyperlink{digitizingf-districts}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Загрузите архив с исходными данными и распакуйте его в вашу рабочую директорию.
\item
  Создайте новый проект QGIS и загрузите любую картографическую основу с веб-сервиса. Сохраните проект в ту же директорию, где находятся исходные данные.
\item
  Привяжите схему избирательных округов. Если вы не знаете, как привязать схему, сверьтесь с \protect\hypertarget{raster-reference}{}{упражнением 5}
\end{enumerate}

\textbf{Снимок экрана №1.} Окно QGIS с привязанным растровым изображением.

\hypertarget{digitizing-new-geopackage}{%
\section{Создание набора пространственных данных}\label{digitizing-new-geopackage}}

\protect\hyperlink{digitizingf-districts}{В начало упражнения ⇡}

На этом этапе мы создадим новый векторный набор пространственных данных, в котором будут храниться контура районов. QGIS поддерживает множество форматов пространственных данных, выбор конкретного формата в каждом случае определяется задачами, требованиями и ограничениями проекта. В качестве формата по умолчанию в QGIS 3 используется \href{https://www.geopackage.org/}{GeoPackage}.

Файл GeoPackage представляет собой базу данных SQLite с дополнительными функциями для хранения наборов пространственных данных. Вся необходимая информация хранится в единственном файле \texttt{*.gpkg}; в процессе работы создаются временные файлы. В одном файле может быть сохранено несколько наборов пространственных данных (иногда их также называют «таблицами», \emph{tables}, или «слоями», \emph{layers})

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите процедуру создания нового набора данных GeoPackage. Для этого нажмите кнопку \includegraphics{images/Ex05_Vectorization/new_geopackage.png} на панели менеджера источников данных или сочетание клавиш \texttt{Ctrl+Shift+N}.
\item
  В открывшемся окне введите следующие параметры:

  \begin{itemize}
  \tightlist
  \item
    \textbf{База данных:} сохраните файл \texttt{*.gpkg} в директорию вашего проекта. Назовите его по шаблону \texttt{Districts\_\%Фамилия\%.gpkg};
  \item
    \textbf{Имя таблицы:} примите значение, предлагаемое по умолчанию после указания пути к базе;
  \item
    \textbf{Тип геометрии:} полигон (площадная)
  \item
    Чекбоксы «Include Z dimension» и «Include M values» оставьте выключенными;
  \item
    \textbf{Система координат}: такая же, как система координат проекта.
  \end{itemize}
\item
  Помимо геометрии объектов, нам нужно будет хранить семантическую информацию --- номера районов. Создайте новое поле целочисленного типа с названием \texttt{district\_id}, как показано на рисунке ниже.
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/new_field.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Проверьте правильность заполнения параметров. Если всё заполнено правильно, нажмите ОК. Новый слой будет добавлен в проект.
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/new_layer.png}

\hypertarget{digitizing-drawing}{%
\section{Векторизация районов}\label{digitizing-drawing}}

\protect\hyperlink{digitizingf-districts}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Измените стиль слоя на \texttt{pattern\ dot\ blue}. Эта символика будет удобна для цифрования, поскольку позволит не «скрывать» растровый слой под создаваемыми объектами и в то же время будет контрастно выделяться на их фоне.
\item
  Теперь всё готово к редактированию слоя. Режим редактирования запускается при помощи кнопки \includegraphics{images/Ex05_Vectorization/button_editing.png} или из контекстного меню слоя. Запустите режим редактирования.
\item
  Когда режим редактирования запущен, нажмите кнопку \includegraphics{images/Ex05_Vectorization/button_new.png}, чтобы начать добавление нового объекта
\item
  Увеличьте изображение до района, обозначенного цифрой «1». Вы начнёте векторизацию с него. По нажатию левой кнопки мыши устанавливается положение первого узла создаваемого контура. «Обходите» контур по часовой стрелке или против часовой стрелки, устанавливая новые узлы нажатием левой кнопки мыши, как показано на изображении ниже
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/new_object.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Чтобы завершить редактирование объекта, нажмите правую кнопку мыши.
\item
  Когда вы завершаете создание объекта в QGIS, появляется окно ввода значений атрибутов. Введите номер избирательного участка, как показано ниже
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/new_attribute.gif}

Когда вы создаёте пространственные объекты в ГИС, важно соблюдать топологию объектов. Координаты узлов соседних объектов должны совпадать, между объектами не должно быть пробелов и перекрытий. Чтобы добиться такого соответствия, вам необходимо активировать опцию прилипания (снеппинга).

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\tightlist
\item
  Найдите панель инструментов прилипания
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/snapping_toolbar.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{7}
\item
  Включите режим прилипания, нажав на иконку с изображением магнита
\item
  Нажимая на соседние иконки в панели, включите прилипание к объектам во всех слоях, но только к вершинам объектов
\item
  Установите порог прилипания равным 12 пикселей экрана.
\end{enumerate}

Теперь, если вы будете подводить курсор к существующим объектам, его положение будет автоматически «притягиваться» к ближайшим узлам

\includegraphics{images/Ex05_Vectorization/snapping_in_action.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\item
  Прилипание позволяет реализовать создание новых объектов путём трассировки по существующим объектам. Включите режим трассировки, нажав на кнопку \includegraphics{images/Ex05_Vectorization/button_tracing.png}
\item
  Оцифруйте соседний объект с помощью трассировки. Для этого подведите курсор к углу существующего объекта и установите первый узел. Затем переместите курсор вдоль общей границы и установите следующий узел. Промежуточные узлы будут добавлены автоматически. После оцифровки общей границы продолжайте векторизацию обычным способом. После добавления нового объекта не забудьте внести его атрибуты во всплывающем окне.
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/tracing_vectorization.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{13}
\tightlist
\item
  Используя полученные навыки, оцифруйте все районы города.
\end{enumerate}

\textbf{Важно!} Время от времени сохраняйте ваши правки при помощи кнопки \includegraphics{images/Ex05_Vectorization/save_edits.png} на панели редактирования. В QGIS, как и во всех ГИС-пакетах, сохранение правок в данных выполняется отдельно от сохранения проекта.

\begin{quote}
Несколько советов по редактированию данных:
\end{quote}

\begin{quote}
Чтобы отменить последний установленный узел, нажмите \texttt{Backspace};
\end{quote}

\begin{quote}
Чтобы полностью удалить последнюю оцифрованную фигуру, нажмите \texttt{Ctrl+Z}.
\end{quote}

\begin{quote}
Чтобы изменить положение отдельного узла уже созданного объекта, можно воспользоваться инструментом редактирования узлов \includegraphics{images/Ex05_Vectorization/button_editvertices.png}.
\end{quote}

\begin{quote}
Трассировка в QGIS работает только тогда, когда весь путь трассировки отображается на экране. Если часть сегмента вылезла за пределы фрейма, трассировка не сработает.
\end{quote}

\begin{quote}
Изучите панель «Дополнительные инструменты оцифровки» --- она может вам пригодиться
\end{quote}

\begin{quote}
Плавные кривые линии (берега, реки и т.п.) при цифровании обычно аппроксимируются ломаными линиями с относительно большим числом узлов --- так, чтобы отличия не были визуально заметны. Хотя многие форматы данных позволяют создавать криволинейные объекты, этот подход не являются общепринятым.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{17}
\tightlist
\item
  По окончании цифрования объектов отключите растровый слой и отобразите данные в полном охвате. Сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №2.} Окно QGIS с оцифрованными границами районов.

\hypertarget{digitizing-query}{%
\section{Пространственные и атрибутивные запросы}\label{digitizing-query}}

\protect\hyperlink{digitizingf-districts}{В начало упражнения ⇡}

В этой части работы вы оцените число жилых домов, оцифрованных пользователями ресурса \href{https://www.openstreetmap.org/}{OpenStreetMap}, в пределах вычерченных вами районов. Волонтёрская географическая информация, к которой относится и OpenStreetMap, является важным источником данных для географических исследований благодаря своей детальности и относительной оперативности обновления, однако имеет ряд недостатков: неравномерное покрытие территории данными, низкая согласованность, структурированность и надёжность данных.

Для подсчёта числа зданий вы воспользуетесь следующим алгоритмом:

\begin{itemize}
\item
  Выбрать район на карте
\item
  Выбрать здания, попадающие в его пределы (\emph{пространственный запрос}).
\item
  Из полученной выборки оставить только здания, принадлежащие к определённому типу (\emph{атрибутивный запрос}).
\item
  Записать число отобранных зданий в соответствующий атрибут текущего района.
\end{itemize}

Операции повторяются для каждого района.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту набор данных о зданиях, который вы загрузили в начале занятия.
\item
  Откройте \textbf{таблицу атрибутов} слоя зданий. Для этого нажмите правой кнопкой мыши на слой в панели слоёв и выберите опцию «Открыть таблицу атрибутов» в контекстном меню.
\end{enumerate}

\begin{quote}
Таблица атрибутов --- это представление базы данных в виде таблицы. В большинстве случаев работа с семантической информацией в ГИС выполняется через таблицу атрибутов.
\end{quote}

Определите, какие атрибуты есть у набора пространственных данных о зданиях. Установите, какие значения атрибутов могут соответствовать жилым домам.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Закройте таблицу атрибутов слоя зданий и откройте таблицу атрибутов слоя избирательных округов.
\item
  Убедитесь, что для слоя избирательных участков включён режим редактирования.
\item
  В окне таблицы атрибутов слоя избирательных округов нажмите кнопку \includegraphics{images/Ex05_Vectorization/button_addfield.png} или \texttt{Ctrl+W}, чтобы добавить новое поле, в которое будет записано число жилых домов для каждого избирательного участка.
\item
  Добавьте поле с именем \texttt{number\_of\_houses} целочисленного типа.
\end{enumerate}

На этом подготовительные операции закончены, мы переходим к запросам.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  \textbf{Выберите} любой из округов: выделите строку в таблице атрибутов или воспользуйтесь инструментом выборки в окне карты \includegraphics{images/Ex05/selection1.png}. Выделенный объект будет подсвечен жёлтым цветом на карте и синим цветом в таблице атрибутов.
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/select1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Теперь выберите те объекты из слоя зданий, которые находятся внутри выбранного округа. Для этого запустите инструмент «Вектор» --- «Выбор» --- «Выбрать по расположению\ldots». Используйте условие «находятся внутри» (\emph{are within}). Включите опцию «Использовать только выделенные объекты» для выбирающего слоя.
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/select_by_location.png}

\includegraphics{images/Ex05_Vectorization/selection2.png}

Нажмите «Выполнить», чтобы выбрать объекты в слое зданий.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Имея выборку в слое зданий и не закрывая окно пространственного запроса («Выбрать по расположению\ldots»), осуществите выборку по атрибутам. Для этого выберите в таблице слоёв слой зданий и нажмите кнопку «Выделить объекты, удовлетворяющие условию» \includegraphics{images/Ex05/selection3.png} (или нажмите \texttt{Ctrl+F3}. Откроется форма ввода атрибутивного запроса.
\end{enumerate}

\begin{quote}
Атрибутивные запросы в ГИС, как правило, создаются с использованием диалектов языка \href{https://ru.wikipedia.org/wiki/SQL}{SQL}. Само выражение представляет собой только условие (\emph{where clause}) и часто использует значения атрибутов. В QGIS можно выполнить запрос и без составления выражения на языке SQL, но поскольку SQL более функционален, мы призываем вас сразу начать пользоваться им.
\end{quote}

Форма ввода атрибутивного запроса состоит из трёх частей. В левой части конструируется собственно запрос, средняя содержит список доступных переменных и функций, в правой отображается справочная и служебная информация. Сейчас вам нужно будет составить атрибутивный запрос, который позволит выбрать здания, являющиеся (с некоторой вероятностью) жилыми домами.

\includegraphics{images/Ex05_Vectorization/query_interface.png}

Атрибутивный запрос представляет собой логическое выражение, которое применяется к кортежу базы данных (строке таблицы). Результатом вычисления логического выражения является либо логическая 1 (ИСТИНА), либо логический 0 (ЛОЖЬ). В выборку попадают объекты, для которых при вычислении выражения получено значение 1.

В простейшем случае выражение состоит из проверки равенства. Например, выражение \texttt{"type"\ =\ \textquotesingle{}house\textquotesingle{}} будет истинным для всех объектов, у которых в поле \texttt{type} записано значение \texttt{house}. Можно конструировать более сложные логические выражения с использованием операторов AND (И), OR (ИЛИ) и других. Например, выражение \texttt{"type"\ =\ \textquotesingle{}apartments\textquotesingle{}\ AND\ "name"\ IS\ NOT\ NULL} будет истинным для объектов, у которых в поле \texttt{type} записано значение \texttt{apartments} (т.е. многоэтажные жилые дома) и одновременно в поле \texttt{name} записано какое-либо значение, отличное от пустого (\texttt{NULL}) (т.е. имеющие название). А запрос \texttt{"type"\ =\ \textquotesingle{}garage\textquotesingle{}\ OR\ "type"\ =\ \textquotesingle{}garages\textquotesingle{}} выберет из слоя зданий объекты, у которых в поле \texttt{type} записано либо значение \texttt{garage}, либо значение \texttt{garages}.

\begin{quote}
Примечание 1: в интерфейсе атрибутивного запроса и во всех остальных инструментах QGIS, использующих тот же интерфейс, названия полей обрамляются двойными кавычками (``), а строковые переменные --- одинарными кавычками (')
Примечание 2: в QGIS и в большинстве систем управления базами данных (СУБД) для работы с пустыми значениями (NULL) используются отдельные операторы. Например, выражение \texttt{"type"\ =\ NULL} будет воспринято как некорректное, вместо него следует писать \texttt{"type"\ IS\ NULL}
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\tightlist
\item
  Составьте выражение, реализующее следующее условие:
\end{enumerate}

\textbf{Выбрать объекты, у которых атрибуту \texttt{type} присвоено значение \texttt{apartments} или \texttt{house}}

Вводить выражение можно, пользуясь списком функций и полей в правой части окна. Двойной клик по полю или функции добавляет соответствующую запись в окно выражения

\includegraphics{images/Ex05_Vectorization/query.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\tightlist
\item
  Мы сформулировали условие для выборки, однако нам нужно выбрать объекты не просто из слоя, а из уже существующей выборки. Для этого откройте выпадающий список кнопки «Выбрать объекты» и выберите функцию «Фильтровать текущее выделение»:
\end{enumerate}

\includegraphics{images/Ex05/selection5.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{11}
\tightlist
\item
  После применения фильтра появится всплывающее сообщение с числом выбранных объектов. Эта информация будет продублирована внизу окна QGIS:
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/select_from_selection.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{12}
\item
  Введите полученную цифру в таблицу атрибутов слоя избирательных округов в строке, соответствующей выбранному объекту (подсвечена синим).
\item
  Теперь, не закрывая окна пространственного и атрибутивного запроса, выбирайте по очереди каждый следующий объект в слое границ избирательных округов и повторяйте для них шаги 3-13. Таким образом вы заполните весь столбец \texttt{number\_of\_houses} в таблице атрибутов. В процессе выполнения не забывайте периодически сохранять правки.
\item
  Скопируйте таблицу атрибутов в любой табличный процессор (Microsoft Excel, Google Sheets, LibreOffice Calc). Для этого при помощи сочетания клавиш \texttt{Ctrl+A} выделите все записи в таблице, скопируйте при помощи \texttt{Ctrl+C} и вставьте записи без форматирования в табличный процессор при помощи \texttt{Ctrl+Shift+V}.
\item
  Удалите столбец \texttt{wkt\_geometry}, если он есть в вашей таблице. Скопируйте остальные столбцы и вставьте их в отчётный файл.
\end{enumerate}

\textbf{Таблица №1.} Таблица атрибутов слоя избирательных округов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{17}
\item
  Завершите редактирование слоя избирательных округов.
\item
  Отключите отображение слоя зданий.
\end{enumerate}

\hypertarget{digitizing-diagrams}{%
\section{Визуализация слоя при помощи картодиаграмм}\label{digitizing-diagrams}}

\protect\hyperlink{digitizing-districts}{В начало упражнения ⇡}

Как вы уже знаете из курса картографии, не существует прямого взаимно-однозначного соответствия между способами изображения, принятыми в картографии, и способами визуализации данных в ГИС. Чтобы отобразить абсолютную величину в пределах единиц статистического учёта (или аналогичных контуров), в картографии применяют способ картодиаграмм. Для создания условных знаков, соответствующих способу картодиаграмм, в QGIS применяется вкладка «Диаграммы» в свойствах слоя.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя районов и перейдите на вкладку «Диаграммы». По умолчанию отображение диаграмм отключено. Включите отображение круговых диаграмм, выбрав опцию Pie Chart из выпадающего списка вверху.
\item
  В настройках диаграмм перейдите на вкладку «Атрибуты». Добавьте атрибут \texttt{number\_of\_houses} к диаграмме. Задайте для него мягкий оттенок оранжевого или жёлтого цвета.

  \begin{quote}
  Примечание: вкладка «Атрибуты» нужна для настройки секторов круговых диаграмм. Если вы добавляете несколько атрибутов к диаграмме, программа автоматически рассчитывает размеры секторов для каждого объекта. Сейчас перед нами не стоит такая задача, так что, фактически, можно было не добавлять атрибуты или добавить любой другой.
  \end{quote}
\item
  На вкладке «Отрисовка» («Рендеринг») установите для диаграмм настройку прозрачности (70 \%)
\item
  На вкладке «Размер» измените способ задания размера с фиксированного на изменяющийся («масштабируемый»).

  \begin{quote}
  Изменение размера диаграмм в QGIS работает следующим образом. Пользователь задаёт максимальное значение показателя, который будет управлять размером диаграммы, и соответствующий ему максимальный диаметр диаграммы. Размер круга масштабируется пропорционально величине показателя. Из картографических соображений следует всегда выбирать масштабирование площади (в новых версиях QGIS некорректно переведено как «к поверхности»), а не линейного размера (диаметра).
  \end{quote}
\item
  В выпадающем списке «Атрибут» выберите нужный атрибут и нажмите кнопку «Найти, чтобы отобразить его максимальное значение. Оно будет отражено во вкладке «Макс. значение».
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/diagrams1.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\item
  Округлите полученное максимальное значение в большую сторону до величины, кратной 100.
\item
  Установите максимальный размер диаграмм равным 14 (мм). Диаграмма такого диаметра будет соответстовать объекту с указанным максимальным значением атрибута.

  \begin{quote}
  В QGIS есть ещё одна полезная опция --- увеличение размера диаграмм. Она применяется, если при масштабировании некоторые диаграммы становятся слишком малы. В таком случае их размер увеличивается до минимального (задаваемого пользователем) порогового значения. В этом упражнении она нам не требуется
  \end{quote}
\item
  Перейдите на вкладку «Размещение» и проверьте, что для ваших диаграмм указана опция размещения над центроидом.
\item
  Перейдите на вкладку «Легенда». Здесь вы настроите комбинацию условных знаков для отображения в легенде. Нажмите кнопку «Условные обозначения для размеров диаграмм» (\emph{Show Legend Entries for Diagram Size}).
\item
  Настройте отображение значков следующим образом:

  \begin{itemize}
  \tightlist
  \item
    «Коллапсируйте» значки легенды;
  \item
    В качестве символа используйте белый маркер круглой формы с тёмно-серой обводкой;
  \item
    Задайте заголовок («Число домов»);
  \end{itemize}
\end{enumerate}

Интерфейс настройки диаграммы должен принять приблизительно следующий вид:

\includegraphics{images/Ex05_Vectorization/diagram2.png}

\textbf{Важное замечание:} такой набор значков не является картографически корректным для легенды к абсолютной непрерывной шкале значков. По состоянию на февраль 2022 г. ни один широко используемый ГИС-пакет не может сделать легенду к размерам кругов картодиаграммы согласно принятым картографическим правилам. Легенды к таким картам следует составлять или исправлять вручную.

По окончании настройки символов окно QGIS будет выглядеть следующим образом:

\includegraphics{images/Ex05_Vectorization/map_diagrams.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\tightlist
\item
  Самостоятельно измените настройки отображения слоёв так, чтобы базовая карта не «доминировала» над тематическим содержанием, и сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №3.} Окно QGIS с настроенной символикой.

\hypertarget{digitizing-layout}{%
\section{Создание и экспорт макета компоновки}\label{digitizing-layout}}

\protect\hyperlink{digitizing-districts}{В начало упражнения ⇡}

Изображение, которое вы видите во фрейме данных, можно экспортировать «как есть» (с помощью опции «Проекты» --- «Импорт/экспорт» --- «Экспортировать карту как изображение\ldots»). Однако для картографических целей, как правило, формируется \textbf{компоновка карты}. На листе заданного формата размещается картографическое изображение, добавляется название, легенда, масштабная линейка и элементы зарамочного оформления.

Сейчас мы создадим макет компоновки с расчётом на то, что итоговая карта-схема будет вставлена в отчёт.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте новый макет компоновки («Проект» --- «Создать Макет\ldots») или \texttt{Ctrl+P}.
\item
  В качестве названия макета введите свою фамилию.
\end{enumerate}

\begin{quote}
В отличие от проектов QGIS и наборов пространственных данных, на названия макетов компоновки в QGIS не накладывается ограничений.
\end{quote}

После ввода названия откроется окно компоновки (\emph{Layout})

\begin{figure}
\centering
\includegraphics{images/Ex01/Layout.png}
\caption{Layout}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Измените ориентацию страницы с альбомной, предлагаемой по умолчанию, на портретную, соответствующую ориентации страниц отчёта. На изображении ниже показано, как это сделать.
\end{enumerate}

\begin{figure}
\centering
\includegraphics{images/Ex05_Vectorization/album_portrait.gif}
\caption{Layout}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Добавьте картографическое изображение (фрейм карты) на макет
\end{enumerate}

\begin{figure}
\centering
\includegraphics{images/Ex05_Vectorization/add_map.gif}
\caption{Add map}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Измените положение и размер фрейма карты таким образом, чтобы на листе оставались поля: левое: 3 см, правое: 1,5 см.
\item
  Изменяя высоту фрейма, масштаб изображения, а также перемещая картографическое изображение внутри фрейма при помощи кнопки «Переместить содержимое элемента» \includegraphics{images/Ex05_Vectorization/button_moveelement.png}, добейтесь вида фрейма, аналогичного рисунку ниже:
\end{enumerate}

\begin{figure}
\centering
\includegraphics{images/Ex05_Vectorization/map_frame.png}
\caption{Map layout}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Не закрывая окно макета, вернитесь в основное окно QGIS и переименуйте слой районов. Назовите его «Районы Новосибирска».
\item
  Добавьте на макет легенду с помощью кнопки \includegraphics{images/Ex05_Vectorization/button_addlegend.png}. Поместите легенду в наиболее свободное место в пределах карты.
\item
  Отключите автообновление легенды и удалите ненужные записи, как показано на рисунке ниже:
\end{enumerate}

\includegraphics{images/Ex05_Vectorization/legend_deleteelements.gif}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\item
  В свойствах элемента легенды найдите вкладку отступ и удалите (установите равным нулю) отступ под заголовком легенды.
\item
  Добавьте масштабную линейку с помощью кнопки \includegraphics{images/Ex05_Vectorization/button_addscalebar.png}. Разместите масштабную линейку в юго-западном углу изображения. При необходимости измените обозначение единиц измерения.
\item
  Добавьте название карты (текстовый элемент) с помощью кнопки \includegraphics{images/Ex05_Vectorization/button_addtext.png}. Самостоятельно выберите оптимальное место для размещения названия.
\item
  Экспортируйте карту-схему («Макет» --- «Экспорт в Изображение» или кнопка \includegraphics{images/Ex05_Vectorization/button_exporttoraster.png}) с разрешением 96 точек на дюйм (dpi). Используйте опцию «Кадрировать по содержимому» (\emph{Crop to Content}).

  \begin{quote}
  Примечание: разрешение 96 точек на дюйм считается довольно низким для картографических целей. Изображения с таким разрешением не годятся для печати, но иногда могут быть пригодны для размещения в Интернете. ВЫ снижаете разрешение для того, чтобы сохранить читаемость базовой карты.
  \end{quote}
\item
  Вставьте полученное изображение в отчётный файл.
\end{enumerate}

\textbf{Итоговое картографическое изобаржение}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{13}
\tightlist
\item
  Ответьте на контрольные вопросы в конце отчётного файла
\end{enumerate}

\hypertarget{part-ux432ux435ux43aux442ux43eux440ux43dux44bux439-ux430ux43dux430ux43bux438ux437}{%
\part{Векторный анализ}\label{part-ux432ux435ux43aux442ux43eux440ux43dux44bux439-ux430ux43dux430ux43bux438ux437}}

\hypertarget{overlay}{%
\chapter{Анализ пространственных взаимосвязей}\label{overlay}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex07.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex07_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{overlay-intro}{%
\section{Введение}\label{overlay-intro}}

\textbf{Цель задания} --- научиться определять пространственную приуроченность двух явлений на основе процента взаимного покрытия их площадей (методом оверлея).

\textbf{Необходимая теоретическая подготовка:} Оверлей пространственных объектов, геометрическое определение вероятности как отношения мер (площадей), соединение таблиц в реляционных базах данных, внешний и внутренний ключ соединения.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных . Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

\textbf{Исходные данные:} База данных ГИС «Сатино».

\textbf{Результат:} Таблица взаимного покрытия площадей типов рельефа и подтипов почв.

\hypertarget{overlay-control}{%
\subsection{Контрольный лист}\label{overlay-control}}

\begin{itemize}
\tightlist
\item
  Добавить на карту слои типов почв и рельефа, оформить их
\item
  Произвести оверлей слоев
\item
  Произвести слияние данных и соединение таблиц
\item
  Подсчитать процент покрытия площадей
\end{itemize}

\hypertarget{overlay-annotation}{%
\subsection{Аннотация}\label{overlay-annotation}}

Задание посвящено знакомству с пространственным анализом на основе векторных данных. Векторная модель представляет объекты в виде отдельных геометрических фигур с набором атрибутов. Она является объектно-ориентированной и удобна для анализа формы, размеров объектов, их взаимной конфигурации в пространстве. Одним из широко используемых методов анализа на основе векторных данных является оверлей.

\begin{quote}
При \emph{оверлее} происходит наложение двух или более слоев, в результате чего образуется их графическая композиция. Полученные участки наследуют атрибуты от каждого слоя. Эта операция базируется на стандартных отношениях множеств, таких как пересечение, объединение и симметрическая разность.
\end{quote}

С помощью оверлея можно, например, установить, к каким генетическим типам рельефа приурочены различные типы и подтипы почв. В общем случае оверлей позволяет установить, какие комбинации объектов встречаются в пространстве. В задании предлагается исследовать методом оверлея взаимосвязь типов рельефа и типов и подтипов почв.

\hypertarget{overlay-vectors}{%
\section{Визуальный анализ векторных слоев}\label{overlay-vectors}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

В первую очередь при анализе данных следует провести их визуальную оценку, которая может натолкнуть на отыскание закономерностей во взаимном расположении объектов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Распакуйте архив с материалами упражнения в свою рабочую директорию. Создайте проект QGIS в папке с распакованными материалами.
\item
  Добавьте на карту слой \emph{RelTypes} из базы геоданных \texttt{Satino.gdb}. Примените к нему стиль из файла \texttt{RelTypes.qml}.

  \includegraphics{images/Ex06/AppliedStyle1.png}
\item
  Добавьте на карту слой \emph{SoilTypes} из той же базы. Изобразите его в виде полигонов без заливки с обводкой красного цвета.

  \includegraphics{images/Ex06/AppliedStyle2.png}
\item
  Выберите инструмент идентификации \includegraphics{images/Ex06/icon_identify.png} и щелкните в пределах карты на любом полигоне. Откроется форма идентификации (отображения) атрибутов объекта

  \includegraphics{images/Ex06/identify1.png}

  По умолчанию QGIS идентифицирует объекты либо из самого верхнего слоя (\emph{Сверху вниз, до первого найденного}, в порядке перечисления в панели слоёв), либо из того слоя, который выбран в панели слоёв (\emph{Текущий слой}). Можно настроить инструмент идентификации таким образом, чтобы отображать атрибуты объектов из всех доступных слоёв. Для этого в нижней части панели идентификации нужно установить режим \emph{Сверху вниз}.

  \includegraphics{images/Ex06/identify2.png}

  \includegraphics{images/Ex06/identify3.png}

  Пользуясь инструментом идентификации, проанализируйте совмещенное изображение границ типов почв и рельефа.
\end{enumerate}

\textbf{Вопрос 1:} Есть ли какие-то совпадения или подобия рисунков контуров типов рельефа и подтипов почв в пределах речных долин, междуречий, малых эрозионных форм?

Когда данные исследованы визуально и путем идентификации, можно перейти к их анализу с помощью оверлея.

\hypertarget{overlay-intersect}{%
\section{Оверлей слоев методом пересечения}\label{overlay-intersect}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

Инструменты векторного оверлея, а также некоторые родственные им инструменты в QGIS размещаются в меню «Вектор --- Геообработка». Также эти инструменты доступны из панели инструментов анализа.

\emph{Изучите, как работают инструменты геообработки}. Для этого сохраните и закройте свой проект QGIS, затем создайте новый проект, а в нём --- два временных полигональных слоя.

\begin{quote}
Временный слой в QGIS хранится в выделенной директории среди системных файлов. Если не сохранять временные файлы, они будут удалены после закрытия окна QGIS.
\end{quote}

\begin{quote}
Чтобы создать временный слой, нажмите кнопку \emph{Новый временный слой} в панели менеджера источников данных. Используйте для создаваемых слоёв проецированную систему координат!
\end{quote}

\textbf{поочерёдно примените к вашим слоям следующие инструменты геообработки: Обрезать (Clip), Разность (Erase), пересечение (Intersect), Симметрическая разность (Symmetrical Difference), Объединение (Union)} и ответьте на вопросы:

\textbf{Вопрос 2}: опишите словесно, как будет выглядеть результат применения каждого из инструментов геообработки к произвольной паре наборов данных?

\textbf{Вопрос 3}: какие из изученных инструментов геообработки будут выдавать одинаковый результат независимо от порядка исходных слоёв, а для каких этот результат будет различен? Учитывайте не только геометрические, но и атрибутивные свойства результата.

\textbf{Вопрос 4}: чем отличаются результаты обработки с помощью инструментов Обрезать (Clip) и Пересечение (Intersect)?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Вернитесь в основной рабочий проект.
\item
  Запустите инструмент \emph{Пересечение (Intersect)}. Настройте параметры следующим образом:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Используйте слой \texttt{SoilTypes} в качестве исходного и слой \texttt{RelTypes} в качестве оверлейного.\\
  \item
    Сохраните выходной набор данных как GeoPackage в вашу рабочую директорию. Назовите выходной файл \texttt{\%фамилия\%\_geoprocessing.gpkg}, а в открывшемся окне задания имени слоя введите \texttt{Soil\_Relief\_Intersect}.
  \end{enumerate}

  \includegraphics{images/Ex06/overlay2.png}
\item
  Нажмите «Выполнить», чтобы запустить вычисления.

  Результат вычислений добавится на карту и в таблицу слоёв под именем \texttt{Пересечение}.
\item
  Переименуйте добавленный слой в \texttt{Комбинации\ почвы-рельеф}.
\item
  Поместите полученный оверлеем слой между слоями типов почв и рельефа, и настройте его отображение в виде полигона без заливки с черной обводкой. Там, где границы совпадают с контурами типов рельефа, они будут черного цвета, а там где они совпадают с контурами типов почв, будет красная линия с черной обводкой.

  \includegraphics{images/Ex06/overlay3.png}
\item
  Раскройте атрибутивную таблицу слоя \emph{Комбинации почвы-рельеф}.
\end{enumerate}

\textbf{Вопрос 5}: Какие поля содержатся в атрибутивной таблице полученного слоя?

\hypertarget{overlay-merge}{%
\section{Слияние результатов пересечения с целью получения показателя пространственной связи}\label{overlay-merge}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

Поскольку каждый полигон в оверлейном слое содержит значение типа/подтипа почвы и типа рельефа, появляется возможность установить приуроченность типов и подтипов почв к определенным типам рельефа.

Чтобы подсчитать долю каждого типа рельефа в площади каждого подтипа почв, необходимо просуммировать площади каждой их уникальной комбинации. Например, дерново-карбонатные выщелоченные почвы (\emph{Д-в-к}) на крутых эрозионных склонах встречаются в пределах Сатинского полигона в виде 6 разрозненных участков, имеющих некоторую суммарную площадь. Эта площадь, деленная на суммарную площадь почв подтипа \emph{Д-в-к} даст вероятностный критерий приуроченности почв \emph{Д-в-к} к крутым эрозионным склонам. То же самое касается остальных комбинаций подтипов почв и типов рельефа.

С точки зрения рабочих процессов ГИС, операцию следует разбить на 5 шагов:

\begin{itemize}
\item
  подсчет суммарной площади каждой комбинации подтипа почв и типа рельефа;
\item
  подсчет суммарной площади каждого подтипа почв;
\item
  добавление поля, в которое будет записана процентная доля;
\item
  соединение таблиц комбинаций и подтипов почв по названию подтипа почв;
\item
  деление площади комбинации на площадь подтипа почв и запись результата в соответствующее поле.
\end{itemize}

\begin{quote}
Объединение разрозненных объектов, обладающих одинаковым набором атрибутов, осуществляется с помощью \emph{операции объединения по признаку} (Dissolve). Причем, если объекты примыкают друг к другу, граница между ними будет стерта, а если объекты разнесены в пространстве, на выходе получится составной объект (Multipart feature), состоящий из нескольких полигонов. Объединение по признаку --- это один из методов генерализации, он очень часто используется в геоинформационном анализе и картографировании.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте инструмент геообработки «Объединение по признаку».
\item
  Выберите в качестве исходного слоя \emph{Комбинации почвы-рельеф}.
\item
  Нажмите на кнопку с изображением многоточия в строке \emph{Dissolve fields (optional)}, чтобы задать поля, по которым будет производиться слияние. В открывшемся списке отметьте поля \emph{SoilType}, \emph{SoilSubtype} и \emph{RelType}. Тем самым можно будет найти все уникальные комбинации подтипов почв и типов рельефа.

  \begin{quote}
  Поле \emph{SoilType} необходимо отметить для того, чтобы в таблице результирующего слоя сохранилась информация о типах почв. Это не повлияет на сам результат, поскольку количество комбинаций типа и подтипа почв равно количеству самих подтипов.
  \end{quote}
\item
  Укажите путь для сохранения результата объединения по признаку. Сохраните результат в тот же GeoPackage, что и результат пересечения, а слой назовите \texttt{Soil\_Relief\_Intersect\_Dissolve}.
\item
  Запустите выполнение инструмента.
\item
  После того, как результат появится в таблице содержания, закройте окно инструмента. Переименуйте полученный слой в \emph{Слияние комбинаций почвы-рельеф}.
\item
  Отключите этот слой в таблице содержания.
\end{enumerate}

\hypertarget{overlay-sumarea-subtypes}{%
\section{Объединение подтипов почв для подсчёта суммарной площади}\label{overlay-sumarea-subtypes}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите инструмент объединения по признаку еще раз.
\item
  Выберите в качестве входных данных слой \emph{SoilTypes}.
\item
  В списке полей для объединения выберите поля \emph{SoilType} и \emph{SoilSubtype}.
\item
  Выходной набор данных сохраните в тот же GeoPackage с именем слоя \emph{SoilTypes\_Dissolve}.
\item
  Остальные параметры оставьте по умолчанию и запустите инструмент.
\item
  Назовите полученный слой \emph{Слияние подтипов почв}. В данном слое в результате операции слияния каждый подтип почв будет представлен единственным объектом.
\item
  Отключите этот слой в таблице содержания.
\end{enumerate}

\hypertarget{overlay-fieldcalc}{%
\section{Расчёт площадей объектов}\label{overlay-fieldcalc}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

В отличие от ArcGIS, QGIS не умеет автоматически пересчитывать площади объектов при изменении их геометрии. А изменения, которые мы произвели в процессе объединения по признаку, достаточно велики. Далее мы рассчитаем площади каждого объекта в «объединённых» слоях, затем выполним соединение атрибутивных таблиц и рассчитаем показатель связи на основе соотношения площадей.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте таблицу атрибутов слоя \emph{Слияние комбинаций почвы-рельеф}.
\item
  В заголовке таблицы найдите \textbf{Открыть калькулятор полей} (\includegraphics{images/Ex06/fieldcalc1.png}) или нажмите \texttt{Ctrl+I}.

  В QGIS, в отличие от ArcGIS и многих СУБД, не требуется отдельно создавать новое поле перед выполнением расчёта. Мы создадим новое поле, в котором будет записана площадь объекта в гектарах, и одновременно заполним его значениями с помощью калькулятора полей.
\item
  Введите имя поля \texttt{AREA\_HA\_INTERSECT} и установите тип данных «Десятичное число (real)».
\item
  Введите выражение \texttt{\$area\ /\ 10000} в поле «Выражение».

  \includegraphics{images/Ex06/fieldcalc2.png}

  Пояснение: \texttt{area()} --- системная функция QGIS, возвращающая площадь объекта. Значок \texttt{\$} означает, что функция будет применена к текущему объекту. Площадь вычисляется в единицах измерения площади, предусмотренных для системы координат источника данных. Для проецированных систем координат это, как правило, метры (реже футы). Назначение выражения \texttt{/\ 10000} постарайтесь определить самостоятельно.
\item
  Нажмите ОК. Слой перейдёт в режим редактирования, а в таблице атрибутов появится новый столбец.
\item
  Сохраните правки и выключите режим редактирования для слоя \emph{Слияние комбинаций почвы-рельеф}. Кнопка включения/выключения режима редактирования доступна не только в панели редактирования, но и в окне таблицы атрибутов.
\item
  Проделайте аналогичную операцию для слоя \emph{Слияние подтипов почв}. \textbf{Важно:} используйте другое имя для поля площади, например, \texttt{AREA\_HA\_SOILS}, чтобы избежать ошибки на следующем шаге.
\end{enumerate}

\hypertarget{overlay-join}{%
\section{Соединение таблиц по названию подтипа почв}\label{overlay-join}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

Для расчета пространственной взаимосвязи необходимо поделить площадь каждой комбинации на площадь соответствующего подтипа почв. Эти площади находятся сейчас в разных таблицах --- \emph{Слияние подтипов почв} и \emph{Слияние комбинаций почвы-рельеф}. Их можно соединить по полю подтипа почв.

\begin{quote}
\emph{Соединение таблиц} (table join) --- операция, в результате которой к одной таблице временно добавляются столбцы из другой таблицы. Чтобы установить соответствие между строками исходной и присоединяемой таблицы, необходимо иметь в каждой таблице поле с общими для них значениями. Например, это может быть числовой код объекта или, как в нашем случае, подтип почв (строковый тип данных).
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя \emph{Слияние комбинаций почвы-рельеф} и перейдите на вкладку \emph{Связи}.
\item
  Нажмите на кнопку с изображением знака «+» внизу, чтобы добавить новую связь.
\item
  Настройте параметры соединения, как показано на рисунке ниже:

  \includegraphics{images/Ex06/tablejoin1.png}

  \textbf{Вопрос 6}: Что такое «поле для объединения» и «целевое поле» в QGIS? К каким слоям относится каждое из них?
\item
  Примените изменения, закройте свойства слоя и откройте таблицу атрибутов.

  \textbf{Вопрос 7}: Что изменилось в таблице атрибутов после создания связи?
\end{enumerate}

\hypertarget{overlay-resulting}{%
\section{Вычисление результирующих значений показателя связи}\label{overlay-resulting}}

\protect\hyperlink{overlay}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте таблицу атрибутов слоя \emph{Слияние комбинаций почвы-рельеф}, а затем вызовите калькулятор полей.
\item
  Укажите, что результат вычисления будет сохраняться в новое поле вещественного (real) типа, имя поля --- \texttt{Percent}
\item
  В окне ввода выражения составьте следующее выражение:

  \textbf{Площадь сочетания подтипа почв и типа рельефа / Площадь подтипа почв × 100 }

  \begin{quote}
  Подсказка: чтобы использовать значения полей в выражении, найдите в средней панели группу «Поля и значения». Добавляйте поля в выражение, кликая по их названиям дважды левой кнопкой мыши.
  \end{quote}
\item
  Запустите расчёт. После окончания расчёта посмотрите получившиеся значения в поле \emph{Percent}.
\item
  Удалите соединение таблиц через свойства слоя \emph{Слияние комбинаций почвы-рельеф} (вкладка «Связи», кнопка с изображением знака «минус» внизу).
\item
  Отсортируйте таблицу атрибутов по значению поля \emph{Percent} по убыванию. Выберите объекты, значение показателя связи для которых превышает 75 \%.
\item
  Скройте все столбцы, кроме типа почв, подтипа почв, типа рельефа и поля \emph{Percent.}. Для того, чтобы скрыть столбец в таблице атрибутов, нажмите на его название правой кнопкой мыши и выберите опцию \emph{Hide column}.
\item
  Скомпонуйте окно приложения так, чтобы было видно целиком карту, а также выделенные в таблице строки, а также столбцы, перечисленные в предыдущем пункте.

  \textbf{Скриншот 1:} окно карты и результирующая таблица

  \begin{quote}
  Примечание: если размер вашего экрана не позволяет скомпоновать окно QGIS в запрошенном виде, сделайте два скриншота: отдельно основное окно QGIS, отдельно таблицу атрибутов.
  \end{quote}
\item
  Сохраните документ карты.
\end{enumerate}

\hypertarget{spatrelations}{%
\chapter{Анализ пространственных соотношений}\label{spatrelations}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex08.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex08_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{spatrelations-intro}{%
\section{Введение}\label{spatrelations-intro}}

\textbf{Цель задания} --- научиться рассчитывать соотношение различных явлений на регулярной сетке с использованием векторного оверлея.

\textbf{Необходимая теоретическая подготовка:} Оверлей пространственных объектов, геометрическое определение вероятности как отношения мер (площадей), соединение таблиц в реляционных базах данных, внешний и внутренний ключ соединения.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных . Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

\textbf{Исходные данные:} Векторные контура типов земельного покрова, полученные на основе данных OpenStreetMap.

\textbf{Результат:} карта соотношения различных типов земельного покрова.

\hypertarget{spatrelations-control}{%
\subsection{Контрольный лист}\label{spatrelations-control}}

\begin{itemize}
\tightlist
\item
  Добавить на карту слои типов объектов и регулярную сетку, оформить их
\item
  Произвести оверлей и слияние объектов в пределах ячеек
\item
  Рассчитать площадь объектов
\item
  Присоединить поля площади к таблице регулярной сетки и рассчитать площадь оставшихся объектов
\item
  Визуализировать результат
\end{itemize}

\hypertarget{spatrelations-annotation}{%
\subsection{Аннотация}\label{spatrelations-annotation}}

Задание посвящено знакомству с пространственным анализом на основе векторных данных. Векторная модель представляет объекты в виде отдельных геометрических фигур с набором атрибутов. Она является объектно-ориентированной и удобна для анализа формы, размеров объектов, их взаимной конфигурации в пространстве. Одним из широко используемых методов анализа на основе векторных данных является оверлей.

\begin{quote}
При \emph{оверлее} происходит наложение двух или более слоев, в результате чего образуется их геометрическая (пространственная) композиция. Полученные участки наследуют атрибуты от каждого слоя. Эта операция базируется на стандартных отношениях множеств, таких как пересечение, объединение и симметрическая разность.
\end{quote}

С помощью оверлея можно, например, установить, как соотносятся площади объектов разных типов в пределах ячеек регулярной сетки. Это может быть важно при моделировании, например, локальных климатических зон или анализе экологической ситуации.

\hypertarget{spatrelations-vizual}{%
\section{Визуальный анализ векторных слоев}\label{spatrelations-vizual}}

\protect\hyperlink{spatrelations}{В начало упражнения ⇡}

В первую очередь при анализе данных следует провести их визуальную оценку, которая может натолкнуть на отыскание закономерностей во взаимном расположении объектов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Распакуйте архив с материалами упражнения в свою рабочую директорию. Создайте проект QGIS в папке с распакованными материалами.
\item
  Добавьте на карту слои \emph{Industrial}, \emph{Hydro}, \emph{Green}, \emph{Buildings} из базы данных \texttt{LandCover.gpkg}. Присвойте этим слоям разные цвета для лучшего восприятия данных.

  \includegraphics{images/Ex06_SpatRelations/Layers.png}
\item
  Создайте регулярную сетку квадратов с помощью инструмента \textbf{Вектор -- Анализ -- Создать сетку\ldots{}}. В открывшемся окне параметров инструмента выберите прямоугольный тип сетки, укажите вертикальный и горизонтальный шаг сетки в 1000 м, а в качестве экстента (охвата) слоя укажите существующий слой проекта \emph{Buildings}. Сохраните сетку в отдельный файл Geopackage в вашей рабочей директории.
\item
  Измените стиль слоя сетки таким образом, чтобы отображались только границы полигонов. Установите толщину линии границы равной 0,26 мм. Переместите слой на верх таблицы слоёв. Сделайте снимок экрана.

  \textbf{Скриншот 1:} Визуализация исходных данных

  \includegraphics{images/Ex06_SpatRelations/Grid.png}
\end{enumerate}

\hypertarget{spatrelations-overlay}{%
\section{Расчёт площадей и оверлей}\label{spatrelations-overlay}}

\protect\hyperlink{spatrelations}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Для расчёта доли площади каждого типа объекта в пределах ячейки необходимо знать площадь самой ячейки. Для этого выберите слой в таблице слоёв, а затем нажмите кнопку \textbf{Калькулятор полей} \includegraphics{images/Ex06_SpatRelations/FieldCalculator.png}. Эту кнопку можно найти на панели атрибутов либо непосредственно в таблице атрибутов.
\item
  В интерфейсе калькулятора полей укажите, что вы создаёте новое поле, введите имя поля \texttt{CellArea} и выберите подходящий тип поля.
\item
  Введите в форму выражения функцию \emph{\$area} и выполните расчёт.

  \begin{quote}
  Примечание: \texttt{area()} --- системная функция QGIS, возвращающая площадь объекта. Значок \texttt{\$} означает, что функция будет применена к текущему объекту. Площадь вычисляется в единицах измерения площади, предусмотренных для системы координат источника данных. Для проецированных систем координат это, как правило, метры, реже -- футы.
  \end{quote}
\end{enumerate}

\textbf{Вопрос 1:} Почему площади разных ячеек различаются? Почему рассчитанная площадь не равна 1 000 000?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\item
  При использовании Калькулятора полей автоматически включается режим редактирования. После расчёта площади сохраните изменения и выключите режим редактирования.
\item
  Для того чтобы рассчитать площади каждого типа объекта в пределах ячеек регулярной сетки, необходимо выполнить операцию пересечения (оверлея) слоев. Для этого воспользуйтесь инструментом \textbf{Вектор --- Геообработка --- Пересечение}. В качестве входного набора данных (\emph{Input layer}) укажите регулярную сетку, а в качестве пересекающего набора данных (\emph{Overlay layer}) --- слой с растительностью. Результат сохраните во временный слой.

  \begin{quote}
  Временный слой в QGIS хранится в выделенной директории среди системных файлов. Если не сохранять временные файлы, они будут удалены после закрытия окна QGIS. Временные слои обозначаются значком \includegraphics{images/Ex06_SpatRelations/TempLayer.png} справа от названия в таблице слоёв.
  \end{quote}
\item
  Результирующий слой будет называться \emph{Пересечение} или \emph{Intersect}. Переименуйте его так, чтобы было понятно, в результате пересечения каких именно слоев он получился.
\end{enumerate}

\textbf{Вопрос 2:} Чем отличается (визуально) полученный слой от исходного слоя растительности?

\textbf{Вопрос 3:} Чем отличается (по структуре таблицы атрибутов) полученный слой от исходного слоя растительности?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Повторите аналогичную операцию для оставшихся трёх слоёв.
\item
  Обратите внимание, что в полученных слоях в пределах каждой ячейки мы видим, как правило, не один объект, а несколько. Мы можем рассчитать площадь каждого из них, но нам нужна суммарная площадь всех объектов.

  \includegraphics{images/Ex06_SpatRelations/Separate_polygons.gif}
\end{enumerate}

Для получения общей площади можно объединить все объекты в пределах ячейки в один объект. Этого можно добиться с помощью операциии \textbf{объединения по признаку} (англ. \emph{Dissolve}). Суть этой операции состоит в объединении объектов, имеющих совпадающие значения какого-либо атрибута (или нескольких атрибутов). После оверлея полигонов у каждого объекта растительности появился уникальный идентификатор ячейки регулярной сетки (\texttt{id}), его можно использовать для объединения по признаку.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Запустите инструмент \textbf{Вектор -- Геообработка -- Объединение по признаку\ldots{}}. В качестве параметров инструмента необходимо указать исходный слой (возьмите пересечение сетки и растительности), а также столбец (или столбцы) таблицы атрибутов, по которому будет осуществляться слияние («поле классификации»). Результат сохраните в тот же файл GeoPackage, в который записана регулярная сетка; задайте имя таблицы \texttt{green\_intersect\_dissolve}

  \includegraphics{images/Ex06_SpatRelations/Dissolve1.png}

  \includegraphics{images/Ex06_SpatRelations/Dissolve2.png}

  \includegraphics{images/Ex06_SpatRelations/Dissolve3.png}
\end{enumerate}

Результирующий временный слой будет называться \emph{Объединенный слой} или \emph{Dissolved} -- переименуйте его так, чтобы было понятно, о каком типе объектов идёт речь.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Повторите аналогичную операцию для оставшихся трёх слоёв.

  \begin{quote}
  Подсказка: можно не закрывать интерфейс инструмента объединения по признаку, а просто менять необходимые параметры и нажимать «Выполнить»
  \end{quote}

  \begin{quote}
  Примечание: из-за ошибок в коде QGIS в некоторых случаях объединение по признаку может срабатывать некорректно: в целевой набор не записываются объекты, и таблица атрибутов не содержит записей. Если вы столкнётесь с такой проблемой, сохраните объединенный слой в новый файл GeoPackage или во временный слой.
  \end{quote}
\item
  Рассчитайте площади всех объектов в каждом объединённом слое с помощью калькулятора полей. Используйте осмысленные имена полей, различные для разных наборов данных (например, \texttt{buildings\_area}).
\end{enumerate}

\hypertarget{spatrelations-join}{%
\section{Соединение таблиц по ключевому полю}\label{spatrelations-join}}

\protect\hyperlink{spatrelations}{В начало упражнения ⇡}

На данном этапе у вас должны быть 4 слоя с известными площадями объектов в ячейках и собственно слой ячеек, для которых рассчитана площадь. Для дальнейшего анализа нам необходимо соединить атрибутивные таблицы всех этих слоёв.

\begin{quote}
\textbf{Соединение таблиц} (\emph{table join}) --- операция, в результате которой к одной таблице временно добавляются столбцы из другой таблицы. Чтобы установить соответствие между строками исходной и присоединяемой таблицы, необходимо иметь в каждой таблице поле с общими для них значениями. Например, это может быть числовой код объекта.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте свойства слоя регулярной сетки. Перейдите на вкладку \textbf{Связи} (\emph{Joins}). Чтобы добавить новое соединение, нужно нажать кнопку «+» внизу. Откроется окно, в котором нужно выбрать слой, атрибутивную таблицу которого мы хотим присоединить, а также ключевые поля, хранящие общие значения -- в нашем случае это поля \emph{id}. Установите галочку напротив опции \textbf{Присоединенные поля} (\emph{Joined fields}), чтобы выбрать поля, которые нужно присоединить. Нам нужна только площадь объектов. Кроме того, можно включить \textbf{Пользовательский префикс имени поля} и удалить все символы из формы.

  \includegraphics{images/Ex06_SpatRelations/Add_Vector_Join.png}
\item
  Проделайте аналогичную операцию для остальных трёх слоёв.
\end{enumerate}

\hypertarget{spatrelations-other}{%
\section{Расчёт площадей, не покрытых объектаи}\label{spatrelations-other}}

\protect\hyperlink{spatrelations}{В начало упражнения ⇡}

Четыре типа объектов покрывают далеко не всю территорию, поскольку есть и иные объекты, которые в нашем случае не берутся в расчёт. Для корректного анализа и визуализации необходимо рассчитать оставшуюся площадь для каждой ячейки. Это можно сделать, отняв из площади ячейки площади всех объектов каждого типа. Проще всего для такой задачи воспользоваться калькулятором поля. Однако здесь возникает проблема: в атрибутивной таблице встречаются пустые значения (\texttt{NULL}) в полях площадей, которые обозначают отсутствие данных. Такое значение получается в случае, если в ячейке регулярной сетки отсутствует соответствующий тип объектов. Со значением \texttt{NULL} мы не сможем корректно рассчитать оставшуюся площадь, поэтому необходимо заменить его на \(0\). Для этого воспользуемся запросами к атрибутивной таблице и калькулятором полей.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Сохраните слой регулярной сетки с присоединенными полями как новый набор объектов (GeoPackage), щёлкнув правой кнопкой мыши по нему и выбрав соответствующий пункт меню. Это нужно, чтобы вы могли редактировать присоединённые столбцы и при этом не изменяли данные в исходных слоях.
\item
  Запустите калькулятор полей для вновь созданного слоя.
\item
  В открывшемся окне укажите, что нужно не создавать новое поле, а обновить существующее. Выберите одно из полей, содержащих сведения о площади покрытий (зданиями, растительностью и др.)
\item
  В калькуляторе полей разверните блок \textbf{Условные} и найдите функцию \texttt{if}. Изучите справку к этой функции.
\item
  Составьте выражение, которое будет выдавать значение \texttt{0}, если исходное значение поля --- \texttt{NULL}, и исходное значение во всех остальных случаях. \textbf{Важно}: вы не можете использовать оператор \texttt{=} вместе со значением \texttt{NULL}, вместо \texttt{=} используйте оператор \texttt{IS}. Чтобы использовать названия полей в выражении, найдите в средней панели группу «Поля и значения». Добавляйте поля в выражение, кликая по их названиям дважды левой кнопкой мыши.

  \includegraphics{images/Ex06_SpatRelations/Field_Calculator2.png}
\end{enumerate}

Если выражение составлено корректно, значения \texttt{NULL} будут заменены на \texttt{0}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  Проделайте аналогичную последовательность действий с выборкой и калькулятором полей для оставшихся трёх типов объектов.
\item
  Теперь используйте калькулятор полей, чтобы рассчитать площадь ячейки, не покрытую ни одним из типов объектов. Составьте выражение самостоятельно аналогично представленному на скриншоте ниже.

  \includegraphics{images/Ex06_SpatRelations/Field_Calculator.png}
\end{enumerate}

\hypertarget{spatrelations-symbology}{%
\section{Настройка символики}\label{spatrelations-symbology}}

\protect\hyperlink{spatrelations}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Визуализируйте доли покрытий с помощью картодиаграмм.

  \includegraphics{images/Ex06_SpatRelations/Result.png}
\item
  Оформите фрагмент вашего набора данных в виде картографического изображения. Вставьте полученную карту в отчётный файл.

  \textbf{Скриншот 2:} Визуализация результата
\item
  Сохраните документ карты.
\item
  Ответьте на контрольные вопросы в отчётном файле.
\end{enumerate}

\hypertarget{part-ux440ux430ux441ux442ux440ux43eux432ux44bux439-ux430ux43dux430ux43bux438ux437}{%
\part{Растровый анализ}\label{part-ux440ux430ux441ux442ux440ux43eux432ux44bux439-ux430ux43dux430ux43bux438ux437}}

\hypertarget{weighted-overlay}{%
\chapter{Оптимизация местоположения}\label{weighted-overlay}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex09.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex09_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{weighted-overlay-intro}{%
\section{Введение}\label{weighted-overlay-intro}}

\textbf{Цель задания} --- овладеть основами растрового анализа в ГИС на примере решения задачи поиска оптимального местоположения для размещения объектов.

\textbf{Необходимая теоретическая подготовка:} Растровая модель пространственных данных, вычисление евклидова расстояния на плоскости, методы классификации числовых рядов, оверлей с весовыми коэффициентами (взвешенный оверлей).

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных. Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

\textbf{Исходные данные:} База данных ГИС «Сатино», цифровая модель рельефа Сатинского полигона

\textbf{Результат:} Набор пространственных данных, содержащий участок, оптимальный по совокупности критериев для размещения объектов.

\hypertarget{weighted-overlay-control}{%
\subsection{Контрольный лист}\label{weighted-overlay-control}}

\begin{itemize}
\tightlist
\item
  Конвертировать слой землепользования в растровое представление
\item
  Построить и классифицировать растр углов наклона рельефа
\item
  Построить и классифицировать растры расстояний до водотоков и домов
\item
  Осуществить взвешенный оверлей полученных растров
\item
  Конвертировать класс с максимальной суммой баллов в векторное представление и выбрать участок, удовлетворяющий критерию минимальной площади.
\end{itemize}

\hypertarget{weighted-overlay-annotation}{%
\subsection{Аннотация}\label{weighted-overlay-annotation}}

В предыдущих заданиях вы познакомились с редактированием векторных данных. Для ряда практических задач более удобным оказывается растровое представление. Оно хорошо подходит для анализа географического пространства, которое обладает постоянно меняющимися характеристиками среды. Растровая модель топологически неразрывна, что позволяет моделировать различные поля и перенос вещества в пространстве из одной ячейки в другую. В силу своей регулярности растровая модель проста в обработке, поскольку все операции можно унифицировать, ориентируясь на матрицу ячеек. В частности, к растровым слоям удобно применять операции алгебры карт, такие как сложение, вычитание, суммирование --- что и используется данном задании.

Вам предстоит решить задачу выбора оптимального местоположения участка для строительства производственного объекта. Критерии выбора следующие:

\begin{itemize}
\item
  участок должен располагаться на горизонтальном участке или участе с небольшим уклоном. Площадки с крутизной склона более \emph{18°} запрещены для строительства;
\item
  участок должен располагаться вблизи автомобильных дорог;
\item
  участок должен располагаться вблизи крупных водотоков, поскольку требуется водоснабжение;
\item
  оптимальные зоны для размещения --- открытые пространства, такие как выгоны, пустыри, луга, вырубки и т.д;
\item
  необходимая площадь участка --- не менее \emph{2,5 га}.
\end{itemize}

\hypertarget{weighted-overlay-warning}{%
\subsection{Прежде чем начать\ldots{}}\label{weighted-overlay-warning}}

Инструкция по выполнению этого упражнения предполагает использование инструментов \href{https://gdal.org/}{GDAL}, интегрированных в сборку QGIS. GDAL печально известен трудоёмкостью установки и нестабильной работой при малейших отклонений от «правильных» условий. Поэтому, если инструменты GDAL выдают ошибку при попытке запуска, попробуйте следующие решения:

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\item
  Обновите QGIS до последней стабильной версии;
\item
  Воспользуйтесь альтернативными инструментами GRASS и SAGA, интегрированными в QGIS. Для каждого инструмента GDAL в инструкции указаны альтернативные инструменты GRASS и SAGA.
\end{enumerate}

\hypertarget{weighted-overlay-init}{%
\section{Добавление исходных данных}\label{weighted-overlay-init}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скопируйте папку с исходными данными в вашу рабочую директорию и создайте в ней новый проект QGIS.
\item
  Создайте в этой же папке вложенную папку \texttt{processing}. Вы будете использовать её для хранения промежуточных результатов.
\item
  Добавьте в проект цифровую модель рельефа (ЦМР, файл \texttt{DEM.tif}).

  \includegraphics{images/Ex12/dem.png}
\item
  Откройте свойства слоя ЦМР и перейдите на вкладку «Информация». Изучите характеристики файла ЦМР.
\end{enumerate}

\begin{quote}
Для описания геометрии растрового набора данных обязательно задаются следующие характеристики: число строк, число столбцов, шаг сетки (размер ячейки), начальные координаты. Некоторые форматы хранения растровых данных (в том числе GeoTIFF) поддерживают многоканальность; в этом случае указывается также число каналов. В разном программном обеспечении эти параметры могут называться немного по-разному.
\end{quote}

\textbf{Вопрос 1}: впишите в отчётный файл основные характеристики ЦМР.

\hypertarget{weighted-overlay-slopes}{%
\section{Расчет углов наклона}\label{weighted-overlay-slopes}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

В QGIS имеется ряд инструментов для создания и анализа поверхностей, представленных в растровой форме. Изучите список доступных инструментов в меню «Растр» --- «Анализ».

\begin{quote}
Создание, анализ и визуализация поверхностей (в том числе поверхности рельефа) --- большая область исследований на стыке геоинформатики, физической географии и ряда других наук. В зарубежной традиции её принято называть \emph{геоморфометрией} (англ. \emph{geomorphometry}). Создание и использование алгоритмов расчёта морфометрических характеристик поверхности, таких как крутизна и экспозиция склона --- одна из многих задач, решаемых геоморфометрией.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Откройте интерфейс инструмента «Крутизна\ldots» из группы «Растр» --- «Анализ».
\item
  Задайте DEM в качестве исходного слоя, все остальные параметры сохраните по умолчанию. Сверните блок «Дополнительные параметры» --- в этом упражнении они не требуются.
\item
  Укажите путь к выходному файлу. По умолчанию QGIS предлагает вам сохранять результат во временный файл, но мы запишем результат явно. Для этого нажмите на многоточие \texttt{...} справа от поля «Крутизна» в нижней части формы и выберите опцию «Сохранить в файл». Укажите, что файл следует сохранить в папку \texttt{processing} под именем \texttt{slope.tif}.

  В итоге интерфейс настройки инструмента «Крутизна\ldots» будет выглядеть, как показано на рисунке ниже:

  \includegraphics{images/Ex12/slope_settings.png}
\item
  Убедитесь, что опция «Открыть выходной файл после исполнения алгоритма» включена. Запустите инструмент. Дождитесь, пока результат расчёта добавится в проект. Присвойте добавленному слою имя «Крутизна», слой цифровой модели рельефа отключите.

  \begin{quote}
  Если инструмент GDAL не сработал, альтернативные инструменты для расчёта углов наклона можно найти в Панели инструментов: \texttt{Slope,\ Aspect,\ Curvature} (SAGA), \texttt{r.slope.aspect} (GRASS). В обоих случаях нужно снять отметки «Открыть выходной файл после исполнения алгоритма» для всех результатов, кроме крутизны склона (Slope). Остальные настройки задаются по аналогии или сохраняются по умолчанию.
  \end{quote}

  \textbf{Скриншот 1:} рассчитанный растр крутизны склона
\item
  Изучите свойства рассчитанного набора данных.

  Обратите внимание, что геометрия полученного растра (число строк и столбцов, размер ячейки) полностью совпадает с геометрией исходной ЦМР.

  \begin{quote}
  Для любознательных: если вы увеличите изображение до края полученного растра и одновременно включите обратно слой ЦМР, вам может показаться, что растр ЦМР «шире», чем растр крутизны. Это на самом деле не так: просто краевым ячейкам растра крутизны присвоены значения «нет данных». При желании можно этого избежать, включив опцию «Обрабатывать краевые ячейки» в настройках инструмента расчёта крутизны.
  \end{quote}

  Далее мы получим ещё несколько растровых наборов данных, но уже не на основе ЦМР. Однако нам придётся следить, чтобы все растры имели одинаковую геометрию. В некоторых программных продуктах (GRASS, SAGA) это требование соблюдается автоматически, в других (ArcGIS) можно заранее задать необходимые настройки. QGIS в настоящее время не поддерживает такие опции на уровне проекта, поэтому геометрию растра придётся задавать каждый раз заново.
\item
  Закройте свойства слоя «Крутизна».
\end{enumerate}

\hypertarget{weighted-overlay-distances}{%
\section{Расчет расстояний}\label{weighted-overlay-distances}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

Чтобы определить участки, наиболее подходящие с точки зрения транспортной доступности, можно построить растр, в каждой ячейке которого будет содержится расстояние (евклидово) от центра этой ячейки до ближайшей дороги. Такое представление имитирует непрерывное поле расстояний.

\hypertarget{weighted-overlay-roads}{%
\subsection{Расстояния до дорог}\label{weighted-overlay-roads}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту слой дорог \texttt{Roads} из базы геоданных \texttt{Satino}.
\item
  Изучите таблицу атрибутов слоя.

  \textbf{Вопрос 2}: как соотносятся записи в поле \texttt{Type} и поле \texttt{Description}? Какие значения поля \texttt{Type} имеют асфальтированные и просёлочные дороги?

  Для того, чтобы построить растр расстояний, мы сначала конвертируем данные о дорогах в растровое представление
\item
  Конвертируйте слой дорог в растр. Для этого запустите инструмент «Растр» --- «Преобразование» --- «Растеризация (вектор в растр)\ldots». Настройте параметры инструмента, как описано ниже:

  \begin{enumerate}
  \def\labelenumii{\alph{enumii}.}
  \item
    Исходный набор данных: \texttt{Roads};
  \item
    Поле, содержащее значение для затемнения: \texttt{Type}. Название опции некорректно переведено на русский язык --- на самом деле здесь задаётся столбец таблицы атрибутов, значения из которого будут записаны в результирующий растр. Большинство растровых форматов не поддерживают запись строковых переменных в ячейки растра, поэтому система позволяет использовать только атрибуты «числовых» типов.
  \item
    Единицы измерения выходного растра: единицы, используемые при геопривязке;
  \item
    Ширина/горизонтальное разрешение: 5;
  \item
    Высота/вертикальное разрешение: 5;
  \item
    Целевой охват: нажмите на многоточие справа, выберите опцию «Использовать охват слоя\ldots» и используйте охват слоя DEM;
  \item
    Целевой растр: сохраните растр под названием \texttt{roads.tif} в папку \texttt{processing};
  \end{enumerate}

  Интерфейс настройки инструмента примет вид, как показано на рисунке ниже

  \includegraphics{images/Ex12/distance_settings.png}

  \emph{\textbf{Важное замечание}: настройки c --- f в списке выше отвечают за геометрию растра. Мы задали их таким образом, чтобы конфигурация создаваемого растра соответствовала тем растрам, которые уже есть в проекте.}

  Результат работы инструмента растеризации:

  \includegraphics{images/Ex12/roads_raster.png}

  \begin{quote}
  Альтернативный инструмент: \texttt{Rasterize} (SAGA). Нужно установить целочисленный тип выходных данных. Перед запуском инструмента рекомендуется сделать выборку в исходном векторном слое, для этого изучите следующий пункт инструкции.
  \end{quote}
\item
  Рассчитайте евклидово расстояние до дорог. Для этого запустите инструмент «Растр» --- «Анализ» --- «Близость (расстояния в растре)\ldots».
\item
  Настройте инструмент следующим образом:

  \begin{itemize}
  \item
    Исходный слой: растровый слой дорог;
  \item
    Список значений пикселов в исходном изображении\ldots: перечислите через запятую те значения, которые соответствуют асфальтированным и просёлочным дорогам.
  \item
    Единицы расстояния: координаты геопривязки
  \end{itemize}

  Остальные параметры оставьте по умолчанию. Сохраните результат в папку \texttt{processing} под именем \texttt{distance\_to\_roads.tif}. Убедитесь, что включена настройка добавления результата в проект после окончания расчёта.

  \begin{quote}
  Альтернативный инструмент: \texttt{Proximity} (SAGA), \texttt{r.grow.distance} (GRASS). Эти инструменты не умеют применять условие для выборки значений из исходного растра, поэтому вернитесь на предыдущий шаг и осуществите выборку в векторном слое перед его растеризацией.
  \end{quote}
\item
  Когда слой добавится в проект, переименуйте его в «Расстояние до дорог».
\item
  Измените символику слоя:

  \begin{itemize}
  \tightlist
  \item
    Стиль: одноканальное псевдоцветное»
  \item
    Минимальное значение: 0
  \item
    Максимальное значение: 2500
  \item
    Тип интерполяции: дискретная
  \item
    Градиент: Magma (после установки градиента нажмите на него правой кнопкой мыши и используйте опцию «Инвертировать градиент»)
  \item
    Мода: «равные интервалы»
  \item
    Число классов: 25
  \end{itemize}

  В некоторых версиях QGIS может потребоваться нажать кнопку «Классифицировать», чтобы применить заданные настройки. Итоговый результат должен выглядеть как послойная окраска изолиний. В случае затруднений с настройкой символики обратитесь к преподавателю.
\item
  Разместите растровый слой дорог над слоем расстояний до дорог. Сделайте скриншот окна QGIS.
\end{enumerate}

\textbf{Скриншот 2:} рассчитанный растр расстояний до дорог

\hypertarget{weighted-overlay-streams}{%
\subsection{Водотоки}\label{weighted-overlay-streams}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Отключите все слои.
\item
  Добавьте на карту слой «площадных» объектов гидрографии \texttt{WaterPolygon} из базы геоданных \texttt{Satino}.
\item
  Выберите (любым способом) объекты, соответствующие р. Протве и р. Исьме.
\item
  Растеризуйте выбранные объекты. Самостоятельно установите настройки инструмента растеризации таким образом, чтобы использовать только выделенные объекты. Ячейкам растра, соответствующим объектам гидрографии, должно быть присвоено фиксированное значение 1 (атрибутивные поля не используются). Кроме того, геометрия получаемого растра должна быть аналогична всем остальным растрам в проекте. Сохраните растр в папку \texttt{processing} под именем \texttt{water.tif}.

  \emph{Примечание: в некоторых версиях QGIS после активации опции «Только выделенные объекты» выдаётся сообщение об ошибке, как на рисунке ниже. \textbf{Сообщение об ошибке можно игнорировать.}}

  \includegraphics{images/Ex12/rasterize_problem.png}

  Результат будет выглядеть, как показано на рисунке:

  \includegraphics{images/Ex12/water_raster.png}
\item
  Рассчитайте евклидово расстояние до водотоков аналогично тому, как вы рассчитывали евклидово расстояние до дорог. Назовите выходной файл \texttt{distance\_to\_water.tif}.
\item
  Когда новый слой добавится в проект, переименуйте его в «Расстояние до водотоков».
\item
  Скопируйте символику из слоя «Расстояние до дорог» (контекстное меню слоя --- «Стили» --- «Копировать стиль») в слой «Расстояние до водотоков» (контекстное меню слоя --- «Стили» --- «Вставить стиль»).
\end{enumerate}

Расположите векторный слой объектов гидрографии над растром расстояния до водотоков и отключите все остальные слои. Сделайте скриншот окна QGIS

\textbf{Скриншот 3:} рассчитанный растр расстояний до водотоков

\hypertarget{weighted-overlay-reclass}{%
\section{Переклассификация наборов данных}\label{weighted-overlay-reclass}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

Мы подготовили три набора данных, характеризующих различные критерии пригодности участков для строительства. Два их них измеряются в метрах, ещё один --- в градусах. Для того, чтобы иметь возможность сопоставлять величины, измеренные в разных единицах, можно использовать нормирование или перейти от точных значений к баллам благоприятности. В последнем случае говорят о \textbf{переклассификации} числового ряда. Мы определим балльную оценку на основе имеющихся значений растров.

В большинстве программных средств ГИС существуют специальные инструменты для переклассификации значений растров. Они называются Reclass, Reclassify или другим аналогичным образом. Есть такой инструмент и в QGIS, однако сейчас мы воспользуемся не им, а \emph{Калькулятором растров}. Это инструмент, который позволяет применять алгебраические выражения к значениям исходных растров и получать производные растры с рассчитанными значениями.

\hypertarget{weighted-overlay-reclass-distance}{%
\subsection{Переклассификация растров расстояний}\label{weighted-overlay-reclass-distance}}

Для переклассификации растров расстояний до дорог и расстояний до водотоков мы воспользуемся функцией \textbf{Калькулятора растров}. Калькулятор растров позволяет применять к ячейкам растра алгебраические выражения и простые условные операторы; результат вычислений записывается в новый растр.

В QGIS доступно несколько инструментов, выполняющих функцию калькулятора растров. Один из них разработан непосредственно в рамках QGIS, остальные заимствуются из другого программного обеспечения (\href{https://gdal.org/}{GDAL}, \href{https://grass.osgeo.org/}{GRASS}, \href{http://www.saga-gis.org/en/index.html}{SAGA}). Мы воспользуемся калькулятором растров GDAL.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте панель инструментов анализа, если она не открыта. Это можно сделать при помощи комбинации клавиш \texttt{Ctrl+Alt+T}, из контекстного меню панелей инструментов или через меню «Анализ данных» --- «Панели инструментов»

  \includegraphics{images/Ex12/analysis.png}
\item
  В панели инструментов найдите группу инструментов GDAL, а в ней --- подгруппу Raster Miscellaneous. Запустите инструмент «Калькулятор растров» из этой группы.
\item
  Выберите в качестве исходного слоя A «Расстояние до дорог». Исходные слои B, C, D, E, F не задавайте.

  \includegraphics{images/Ex12/rastercalc_GDAL1.png}
\item
  В поле «Вычисление\ldots» введите формулу:

  \textbf{\texttt{10\ -\ A/100}}

  Здесь A --- значение в ячейке растра. 10 --- максимальное количество баллов, при удалении от дорог на каждые 100 м число баллов будет уменьшаться на 1.
\item
  В поле «Тип целевого растра» установите значение \texttt{Byte}. Это округлит результат расчёта до целых чисел.

  \begin{quote}
  Примечание: «байтовый» тип выходных данных означает, что одно значение ячейки записывается одним байтом. Следовательно, область допустимых значений для такого растра составляет {[}0, 255{]}.
  \end{quote}
\item
  Укажите, что целевой растр должен быть сохранён в папку \texttt{processing} под именем \texttt{distance\_to\_roads\_classes.tif}

  \includegraphics{images/Ex12/rastercalc_GDAL2.png}
\item
  Дождитесь, пока созданный файл добавится в проект. Переименуйте его в «Расстояния до дорог (классы).

  \includegraphics{images/Ex12/distance_to_roads_classes.png}

  \begin{quote}
  В качестве альтернативного инструмента на этом этапе следует воспользоваться \texttt{Raster\ Calculator} (SAGA). Введите формулу \texttt{ifelse((10\ -\ g1\ /\ 100)\ \textgreater{}\ 0,\ (10\ -\ g1\ /\ 100),\ 0)} и установите тип данных беззнаковый целочисленный 2-байтовый (Unsigned 2 byte integer).
  \end{quote}
\item
  Аналогичным образом переклассифицируйте расстояния до водотоков. Назовите выходной файл \texttt{distance\_to\_water\_classes.tif}, а слой в QGIS --- «Расстояния до водотоков (классы)».

  \includegraphics{images/Ex12/distance_to_water_classes.png}
\end{enumerate}

\hypertarget{weighted-overlay-reclass-slope}{%
\subsection{Переклассификация растра крутизны}\label{weighted-overlay-reclass-slope}}

Для оценки пригодности мы заменим точные значения крутизны склона (в градусах) на баллы благоприятности по 10-балльной шкале, где 10 --- наивысшая благоприятность, 0 --- минимальная благоприятность.

\begin{longtable}[]{@{}ll@{}}
\toprule()
Старые значения, ° & Новые значения \\
\midrule()
\endhead
0-3 & 9 \\
3-6 & 10 \\
6-9 & 8 \\
9-18 & 6 \\
\textgreater18 & \emph{NoData} \\
\bottomrule()
\end{longtable}

\emph{Примечание: при значениях крутизны больше 18° строительство, как правило, сопряжено с решением нетривиальных инженерных задач. При переклассификации мы не будем определять новых значений для ячеек с крутизной более 18°. Впоследствии, при суммировании балльных оценок, это приведёт к тому, что соответствующие ячейки получат значение NoData независимо от того, какие значения будут записаны в других слагаемых.}

Для переклассификации крутизны склона мы воспользуемся инструментом QGIS, который называется \emph{Reclassify by Table}. Это основной инструмент для переклассификации растров, хотя по функционалу он уступает аналогам из проприетарного ПО. Найдите этот инструмент в панели инструментов через поиск или в группе «Растр» --- «Анализ»

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите инструмент \emph{Reclassify by Table}. Установите растр крутизны в качестве исходного набора данных

  \includegraphics{images/Ex12/reclassify_qgis.png}
\item
  Нажмите на многоточие в опции \emph{Reclassification table} (таблица переклассификации). В открывшейся таблице нажмите Add Row четыре раза, чтобы добавить четыре строчки. Введите значения из таблицы выше для каждого ранга, кроме NoData. Результат должен получиться таким же, как на рисунке ниже:

  \includegraphics{images/Ex12/reclassify_qgis2.png}

  \emph{Примечание 1: значение -9999 в последней строчке --- это зарезервированное значение, маркирующее отсутствие данных (NoData) в целочисленных растрах.}
\item
  Задайте для выходного слоя имя \texttt{slope\_classes.tif}. Когда слой добавится в проект, переименуйте его в «Крутизна (классы)»

  \includegraphics{images/Ex12/slope_classes.png}
\item
  Измените стиль отображения слоя на \emph{Paletted/Unique values} (отображение по уникальным значениям) и задайте шкалу \texttt{RdYlGr}. Нажмите «Классифицровать, чтобы добавить значения растра в таблицу уникальных значений, и «ОК», чтобы закрыть свойства слоя, применив изменения.

  \includegraphics{images/Ex12/palette.png}
\end{enumerate}

\textbf{Скриншот 4:} классифицированный растр углов наклона

\textbf{Вопрос 3}: почему на получившемся растре есть «белые пятна»? Какие значения присвоены этим ячейкам?

\hypertarget{ux43fux440ux435ux43eux431ux440ux430ux437ux43eux432ux430ux43dux438ux435-ux441ux43bux43eux44f-ux442ux438ux43fux43eux432-ux437ux435ux43cux43bux435ux43fux43eux43bux44cux437ux43eux432ux430ux43dux438ux44f-ux432-ux440ux430ux441ux442ux440ux43eux432ux43eux435-ux43fux440ux435ux434ux441ux442ux430ux432ux43bux435ux43dux438ux435}{%
\subsection{Преобразование слоя типов землепользования в растровое представление}\label{ux43fux440ux435ux43eux431ux440ux430ux437ux43eux432ux430ux43dux438ux435-ux441ux43bux43eux44f-ux442ux438ux43fux43eux432-ux437ux435ux43cux43bux435ux43fux43eux43bux44cux437ux43eux432ux430ux43dux438ux44f-ux432-ux440ux430ux441ux442ux440ux43eux432ux43eux435-ux43fux440ux435ux434ux441ux442ux430ux432ux43bux435ux43dux438ux435}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

Мы успешно создали балльные оценки для следующих факторов: рельефа, транспортной доступности, доступности водных объектов. Ещё один фактор, влияющий на выбор места под строительство --- существующий режим землепользования.

Сведения о землепользовании имеются в базе данных ГИС «Сатино» в виде векторного полигонального набора данных, содержащего качественную классификацию типов землепользования. Мы создадим балльную оценку на основе этой классификации, а затем конвертируем вектор в растр.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Отключите все слои.
\item
  Добавьте в проект набор данных о землепользовании (\texttt{LandUse}) из базы данных \texttt{Satino.gdb}.
\item
  Изучите таблицу атрибутов добавленного слоя. Информация о землепользовании записана в поле \texttt{Land\_Type}.

  Информация о типах землепользования представлена в виде качественной характеристики («леса», «пашни», «фермерские хозяйства» и т.п.). Для анализа нам необходимо создать балльную оценку на основе этой характеристики. Небольшая техническая сложность заключается в том, что исходный набор данных записан в базу геоданных ESRI, а QGIS не умеет редактировать такие наборы данных, он способен только читать их. Мы воспользуемся функцией «виртуального поля» в QGIS, чтобы присвоить балльную оценку, а затем конвертировать вектор в растр.

  \textbf{Виртуально поле} в QGIS --- это динамическая структура данных, создаваемая на основе выражения калькулятора полей. Виртуальное поле не помещается в таблицу атрибутов и хранится на уровне проекта QGIS. При удалении проекта виртуальные поля слоя будут потеряны.
\item
  В таблице атрибутов слоя \texttt{LandUse} откройте калькулятор полей. Задайте для нового слоя имя \texttt{LT\_rank}, тип --- целочисленный (\emph{Integer}).

  Нам предстоит переклассифицировать значения из поля \texttt{Land\_Type} в баллы. Для этого мы воспользуемся функцией \textbf{CASE}, которая позволяет присваивать новые значения в соответствии с условиями, причём условий может быть множество.
\item
  Разверните группу функций «Условия» в среднем столбце и дважды щёлкните по названию функции \textbf{CASE}. В конструктор формул добавится следующая строка:

  \texttt{CASE\ WHEN\ condition\ THEN\ result\ END}

  Это образец синтаксиса функции. Вместо \texttt{condition} подставляется условие, вместо \texttt{result} --- результат вычисления. Инструкция \texttt{CASE} открывает блок условия, инструкция \texttt{END} закрывает его. Можно вынести эти инструкции в отдельные строки, а промежуточную часть скопировать и вставить несколько раз.

\begin{verbatim}
CASE 
WHEN condition THEN result 
WHEN condition THEN result 
WHEN condition THEN result 
WHEN condition THEN result 
WHEN condition THEN result 
END
\end{verbatim}

  Теперь будем заполнять выражение нужными значениями. Самым благоприятным типом участка с точки зрения землепользования являются выгоны. Меняем первую строчку с условием по следующему образцу:

  \texttt{WHEN\ "Land\_Type"\ =\ \textquotesingle{}Выгоны\textquotesingle{}\ THEN\ 10}

  Леса и территории населённых пунктов относительно малопригодны для размещения новой строительной площадки, им будет присвоен балл 3.

  \texttt{WHEN\ "Land\_Type"\ =\ \textquotesingle{}Леса\textquotesingle{}\ OR\ "Land\_Type"\ =\ \textquotesingle{}Территории\ населенных\ пунктов\textquotesingle{}\ THEN\ 3}

  По такому же принципу создайте условия для переклассификации остальных значений в соответствии с таблицей ниже:

  \begin{longtable}[]{@{}ll@{}}
  \toprule()
  Тип землепользования & Баллы благоприятности \\
  \midrule()
  \endhead
  Вырубки & 2 \\
  Гидрологические объекты & 0 \\
  Дороги и тропы & 1 \\
  Заболоченные земли & 0 \\
  Лесные поляны & 5 \\
  Луга & 8 \\
  Нет данных & 0 \\
  Пашни & 4 \\
  Сады & 2 \\
  Фермерские хозяйства & 2 \\
  \bottomrule()
  \end{longtable}

  \emph{Примечание:} для типов с нулевыми баллами можно не делать отдельные условия. Вместо этого в качестве предпоследней инструкции, перед END, можно вписать \texttt{ELSE\ 0}. Она означает, что во всех остальных случаях, не покрываемых перечисленными ранее условиями, полю будет присвоено значение 0.
\item
  Запустите расчёт. Изучите таблицу атрибутов после окончания расчёта --- в ней должен появиться новый столбец.

  К сожалению, инструменты растеризации, доступные в QGIS, не умеют работать с виртуальными полями, поэтому мы сохраним полученный набор данных в более простой формат --- шейп-файл
\item
  Закройте таблицу атрибутов. В панели слоёв щёлкните правой кнопкой мыши на слое \emph{LandUse} и выберите опцию «Экспорт» --- «Сохранить объекты как\ldots». Сохраните слой в формате ESRI Shapefile под именем \texttt{Land\_Type\_Rank} в папку \texttt{processing}.

  \includegraphics{images/Ex12/save_esri_shapefile.png}

  Когда новый набор добавится в проект, старый слой можно будет удалить.
\item
  Преобразуйте векторный набор данных в растровый так же, как вы делали это ранее в этом упражнении. Укажите, что в результирующий растр должны быть записаны значения поля \texttt{LT\_Rank}. Проследите также, чтобы значение NODATA, присвоенное результирующему слою, было равно 0 --- это позволит нам исключить из рассмотрения участки, имеющие нулевой балл благоприятности по землепользованию (аналогично тому, как мы поступили с крутыми склонами).

  \textbf{Вопрос 4}: какие настройки геометрии растра вы введёте для преобразования векторного представления типов землепользования в растровое? Почему?

  Сохраните целевой файл под именем \texttt{landuse\_classes.tif}. Когда он добавится в проект, переименуйте слой в «Землепользование (классы)».

  \includegraphics{images/Ex12/landuse_classes.png}

  Обратите внимание, что из-под полученного растра «просвечивает» исходный векторный набор данных. Те контура, значение балла благоприятности для которых было равно нулю, на результирующем растре интерпретированы как пустые ячейки («нет данных»).
\end{enumerate}

\hypertarget{weighted-overlay-combination}{%
\section{Нахождение мест с наилучшей комбинацией факторов с помощью взвешенного оверлея}\label{weighted-overlay-combination}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

Наилучшие участки соответствуют территориям, где сумма баллов по всем факторам максимальна. Соединение значений (в том числе и сложение) по нескольким слоям, располагающимся друг над другом, осуществляется с помощью растрового оверлея.\\
Растровый оверлей реализуется с помощью различных инструментов. Мы воспользуемся калькулятором растров GDAL, которым вы уже пользовались ранее в этом упражнении.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите Калькулятор растров из наборов инструментов GDAL
\item
  Задайте исходные растры:

  A: Классы крутизны

  B: Классы расстояний до дорог

  C: Классы расстояний до водотоков

  D: Классы благоприятности по землепользованию

  Для каждого растра укажите канал, из которого будут браться значения для расчёта. Во всех случаях это первый канал (\emph{Gray}).
\item
  Задайте формулу для выполнения взвешенного оверлея. Формула будет иметь вид
\end{enumerate}

\[\sum_{i=1}^n A_i \cdot w_i,\]

где \(A_i\) --- фактор, а \(w_i\) --- весовой коэффициент. В качестве факторов используются значения классифицированных растров. Веса задаются таким образом, чтобы их сумма была равна \(1\). Задайте веса в соответствии с таблицей:

\begin{longtable}[]{@{}ll@{}}
\toprule()
Фактор & Вес \\
\midrule()
\endhead
Крутизна склона & 0,15 \\
Расстояние до дорог & 0,35 \\
Расстояние до водотоков & 0,20 \\
Землепользование & 0,30 \\
\bottomrule()
\end{longtable}

\textbf{Вопрос 5}: скопируйте получившуюся формулу и вставьте её в отчётный файл.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\item
  Задайте байтовый тип выходного растра. Это приведёт к округлению результирующих значений до целых чисел.
\item
  Укажите, что растр следует сохранять в папку \texttt{processing} под именем \texttt{overlay}, и запустите расчёт.
\item
  Когда результирующий растр будет добавлен в таблицу слоёв, назовите его «Комбинация факторов».
\item
  Изучите полученный растр. Если необходимо, измените настройки его визуализации.
\end{enumerate}

\textbf{Вопрос 6}: какие значения могут принимать ячейки полученного растра? Каково происхождение «белых пятен» на этом растре?

\hypertarget{weighted-overlay-final-decision}{%
\section{Окончательный выбор участка}\label{weighted-overlay-final-decision}}

\protect\hyperlink{weighted-overlay}{В начало упражнения ⇡}

В качестве потенциальных мест на размещение площадки следует выбрать 10-балльные участки. При этом необходимо выбрать участки, площадь которых превышает 2,5 га. Для применения этого критерия удобнее представить результат взвешенного оверлея в виде векторного полигонального набора данных.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Преобразуйте растр комбинации факторов в векторное представление. Для этого используйте инструмент «Растр» --- «Преобразование» --- «Создание полигонов (растр в вектор)\ldots». Этот инструмент объединит смежные ячейки растра с одинаковыми значениями в единый полигон. Значение растра будет сохранено в поле с названием, которое вы указываете в инструмента. Запишите векторный набор данных в новый GeoPackage, назвав файл по шаблону \%Фамилия\%\_\%№упражнения\%.gpkg, а слой в нём --- \texttt{parcels}.
\item
  Рассчитайте площади полученных полигонов.
\item
  Выберите на карте все участки с благоприятностью 10 баллов и площадью более 2,5 га.

  Поздравляем! Выбранные участки являются результатом вашего анализа.
\item
  Сохраните выбранные участки в отдельный слой того же GeoPackage.
\item
  Представьте результат анализа в виде схемы. Для этого воспользуйтесь возможностями подключаемого модуля QuickMapServices (см. \protect\hyperlink{map-ref-districts-wms}{упражнение 3}). Используйте любую из карт на основе OpenStreetMap в качестве географической основы. Самостоятельно выберите условные знаки, скомпонуйте и экспортируйте макет карты. Размер итогового изображения должен быть таким, чтобы его можно было вставить в отчётный документ без искажений.
\item
  Вставьте экспортированное изображение в отчётный файл.
\end{enumerate}

\textbf{Дополнительный вопрос для картографов.} Это упражнение основано на \href{https://tsamsonov.github.io/arcgis-course/weighted-overlay.html}{аналогичном упражнении для ArcGIS}. Сравните обе инструкции и ответьте, какие возможности обработки и анализа растровых данных отсутствуют в QGIS по сравнению с ArcGIS.

\hypertarget{hydrodem}{%
\chapter{Гидрологическое моделирование на основе ЦМР}\label{hydrodem}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex10.zip}{Архив с исходными данными}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex10_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{hydrodem-intro}{%
\section{Введение}\label{hydrodem-intro}}

\textbf{Цель задания} --- научиться на основе цифровой модели рельефа выделять водотоки и их водосборные бассейны в автоматическом режиме. Осуществлять расчет статистики по высотам в рамках выделенных бассейнов

\textbf{Необходимая теоретическая подготовка:} Растровая модель пространственных данных, цифровые модели рельефа (ЦМР) и их типы, построение ЦМР, построение производных поверхностей (углы наклона, водосборная площадь), гидрологическое моделирование с использованием ЦМР и его принципы.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных. Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями. Создание компоновки карты: название, легенда, масштаб, градусная сетка.

\textbf{Исходные данные:} приблизительный контур бассейна Северского Донца, тайлы глобальной ЦММ SRTM (загружаются в процессе выполнения упражнения)

\textbf{Результат:} Карта водотоков и их водосборных бассейнов, построенная по ЦМР, с указанием морфометрических параметров бассейнов.

\hypertarget{hydrodem-control}{%
\subsection{Контрольный лист}\label{hydrodem-control}}

\begin{itemize}
\item
  Получить тайлы SRTM с ресурса EarthExplorer
\item
  Создать виртуальный растр
\item
  Выполнить перепроецирование ЦМР
\item
  Рассчитать направления стока
\item
  Рассчитать водосборную площадь
\item
  Построить границы бассейна
\item
  Визуализировать результаты расчёта
\end{itemize}

\hypertarget{hydrodem-annotation}{%
\subsection{Аннотация}\label{hydrodem-annotation}}

Цифровые модели рельефа играют важную роль в гидрологическом и геоморфологическом анализе. Одно из основных приложений ЦМР, позволивших значительно упростить анализ речных систем, --- это автоматизированное построение водосборов и расчет их морфометрических характеристик. Большинство современных программных средств ГИС включают те или иные реализации инструментов гидрологического моделирования на основе ЦМР. QGIS в этом смысле является исключением: у него нет собственных инструментов анализа такого рода, но есть возможность использовать наработки других программных продуктов --- например, \href{https://grass.osgeo.org/}{GRASS} и \href{https://saga-gis.sourceforge.io/en/index.html}{SAGA}.

В этом упражнении вы используете инструменты SAGA посредством интерфейса QGIS, чтобы выполнить гидрологический анализ цифровой модели рельефа, а затем визуализируете полученный результат в виде блок-диаграммы (3D-изображения).

\hypertarget{hydrodem-init}{%
\section{Получение и подготовка исходных данных}\label{hydrodem-init}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Зарегистрируйтесь на ресурсе \href{https://earthexplorer.usgs.gov/}{EarthExplorer} Геологической службы США. Этот ресурс предоставляет доступ к массиву данных дистанционного зондирования и наборов данных, созданных на их основе.
\item
  В левой части окна на вкладке \textbf{Search Critera} откройте вкладку \textbf{KML/Shapefile upload} и используйте файл \texttt{oskol.kml} из архива с исходными данными, чтобы указать область поиска материалов. Или самостоятельно установите рамку поиска аналогично изображению на рисунке ниже

  \includegraphics{images/Ex13/earthexplorer1.png}
\item
  Перейдите на вкладку \textbf{Data Sets} и выберите набор \textbf{Digital Elevation -- SRTM -- SRTM 1-arc second global}

  \includegraphics{images/Ex13/earthexplorer2.png}
\item
  Перейдите на вкладку \textbf{Results} и дождитесь, пока система выполнит запрос по заданным вами условиям. В результате запроса должно быть выдано 6 результатов --- тайлов SRTM.

  \includegraphics{images/Ex13/earthexplorer3.png}
\item
  Поочерёдно нажимая на кнопку «Скачать» \includegraphics{images/Ex13/earthexplorer4.png} каждой записи, загрузите все 6 необходимых тайлов в формате GeoTIFF. Создайте в своей рабочей директории папку \texttt{input\_data} и поместите загруженные тайлы в неё. Также создайте в рабочей директории папку \texttt{processing}, чтобы в дальнейшем сохранять в неё промежуточные наборы данных.

  \begin{quote}
  Примечание: при загрузке отдельных файлов EarthExplorer может ограничить число скачиваемых файлов и/или скорость загрузки. Если это происходит, дождитесь загрузки тех файлов, которые уже скачиваются, а затем повторите попытку.
  \end{quote}
\item
  Запустите QGIS и сохраните проект в вашу рабочую директорию.
\item
  Чтобы работать с цифровой моделью рельефа, необходимо объединить все тайлы в единую мозаику, а затем перепроецировать её из географической системы координат в проецированную.

  \begin{quote}
  Создание мозаики, перепроектирование, а также обрезка по маске, которую мы применим чуть позже --- типичные процедуры подготовки растровых тайлов к геоинформационному анализу. Хранить каждый промежуточный результат в виде отдельного файла, как правило, нет необходимости, а при больших объёмах данных и малых объёмах свободного места на диске --- нет и возможности. На помощь здесь приходит виртуальный растр (\href{https://gdal.org/drivers/raster/vrt.html}{VRT}) --- структура, хранящая ссылки на исходные данные и необходимые операции их преобразования.
  \end{quote}
\item
  Соберите мозаику растровых тайлов. Для этого воспользуйтесь инструментом «Создать виртуальный растр» («Растр» --- «Прочее»).

  \begin{itemize}
  \item
    Добавьте тайлы SRTM в качестве исходных данных
  \item
    Если установлена опция \emph{Place each input file into a separate band}, отключите её.
  \item
    Укажите, что виртуальный растр должен быть сохранён в папку \texttt{processing} под именем \texttt{srtm\_mosaic}
  \end{itemize}

  \includegraphics{images/Ex13/mosaic.png}

  Результат будет автоматически добавлен в проект

  \includegraphics{images/Ex13/mosaic_wgs84.png}
\item
  Измените проекцию документа карты на UTM, датум WGS-84. Самостоятельно определите номер зоны и выберите нужную систему координат (СК).
\end{enumerate}

\textbf{Вопрос 1:} укажите EPSG-код выбранной системы координат

\textbf{Скриншот 1:} окно QGIS после изменения системы координат

Из упражнения 1 мы помним, что QGIS умеет перепроецировать наборы данных на лету. Однако для целей морфометрического анализа ЦМР нам необходимо, чтобы набор данных был «физически» сохранён с использованием проецированной системы координат.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\item
  Используйте инструмент «Деформация (перепроецирование\ldots)» («Растр» --- «Проекции»), чтобы конвертировать вашу мозаику в новый набор данных. Укажите исходную и целевую систему координат (целевая СК должна совпадать с СК проекта), установите кубический метод интерполяции и значение «нет данных», равное \(-9999\). Сохраните перепроецированный растр под именем \texttt{DEM} (от англ. \emph{Digital Elevation Model}) в папку \texttt{processing}, формат файла --- GeoTIFF.
\item
  Когда перепроецированный растр добавится в проект, удалите из него «старую» мозаику.

  \includegraphics{images/Ex13/mosaic_reproj.png}
\end{enumerate}

\hypertarget{hydrodem-preprocessing}{%
\section{Гидрологическая коррекция ЦМР}\label{hydrodem-preprocessing}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

Гидрологическое моделирование с использованием ЦМР основывается на следующей идее: моделируемая вода стекает из ячейки с большей высотой в соседнюю ячейку с меньшей высотой. Трассируя поток вниз по склону, можно связывать ячейки ЦМР в так называемые ``сети потока'' (drainage networks) и определять водосборные площади и границы бассейнов.

\includegraphics{images/Ex13/DEM_flow_concept.png}

Если на модели есть замкнутые локальные понижения, то они выступают как препятствие для распространения стока.

\includegraphics{images/Ex13/depression_scheme.png}

Распространённая практика --- удалять замкнутые локальные понижения с ЦМР перед началом собственно гидрологического моделирования. Удалить повышения можно путём увеличения высот внутри них --- таким образом понижение либо исчезает, либо перестаёт быть замкнутым.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Найдите инструмент \emph{Fill Sinks XXL (Wang \& Liu)} через поиск в панели инструментов. Этот инструмент преобразует ЦМР таким образом, что на месте замкнутых понижений будет сформирована наклонная поверхность. Угол наклона задаётся пользователем. Примените этот инструмент к набору DEM с углом наклона 0,01°. Результат сохраните \textbf{в рабочую директорию} под именем \texttt{DEM\_filled}, расширение оставьте таким, какое предлагается по умолчанию (\texttt{*.sdat}).
\end{enumerate}

\begin{quote}
SAGA GRID --- нативный растровый формат SAGA. Он состоит как минимум из двух файлов: заголовка (*.sgrd) и файла с данными (*.sdat). Часто к ним добавляется файл с описанием системы координат (*.prj). Наконец, если набор был создан непосредственно в SAGA (или, что то же самое, в QGIS), он будет сопровождаться файлом *.mgrd, в котором записывается история применения инструментов геообработки.
\end{quote}

\begin{quote}
Примечание: если в вашей версии QGIS появляется сообщение \emph{Версия SAGA 7.8.2 официально не поддерживается - алгоритмы могут вызвать ошибки}, игнорируйте его. Инструмент Fill Sinks XXL (Wang \& Liu) будет работать без проблем.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Сделайте снимок экрана.
\end{enumerate}

\textbf{Скриншот 2:} окно QGIS после заполнения локальных понижений на ЦМР

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Сравните исходную и скорректированную ЦМР.
\end{enumerate}

\textbf{Вопрос 2:} Как изменилась амплитуда высот ЦМР после заполнения замкнутых локальных понижений? Какие формы рельефа изменились наиболее сильно?

\hypertarget{hydrodem-flowacc}{%
\section{Расчёт водосборной площади}\label{hydrodem-flowacc}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

Водосборная площадь (англ. \emph{catchment area}) в геоморфометрии определяется для каждой точки поверхности так, как если бы точка была замыкающим створом. В регулярно-сеточном анализе водосборная площадь определяется для отдельных ячеек ЦМР и равняется суммарной площади всех ячеек, сток из которых проходит через данную ячейку (по принципу, описанному выше). Вместо площадей ячеек можно использовать какой-нибудь весовой коэффициент. Например, если этот коэффициент представляет слой поверхностного стока, то результирующая величина будет являться объёмом стока для данной ячейки.

Водосборную площадь вместе со всеми другими величинами, которые можно рассчитать по аналогичному принципу, часто называют аккумуляцией потока (англ. \emph{flow accumulation}). Именно так называются инструменты расчёта водосборной площади в большинстве современных ГИС-пакетов (в том числе в SAGA).

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Найдите инструмент \textbf{Flow Accumulation (Top-Down)} (для старых версий QGIS и SAGA: \textbf{Catchment Area}) в панели инструментов. Запустите его, используя следующие настройки:

  \begin{itemize}
  \tightlist
  \item
    Исходное поле высот (Elevation): \texttt{DEM\_filled}
  \item
    Метод расчёта (Method): Deterministic 8
  \item
    Выходной растр водосборной площади (Flow Accumulation): сохраните в рабочую директорию и назовите его \texttt{flowacc}. Оставьте включённой опцию «Открыть выходной файл после завершения алгоритма».
  \item
    Все прочие выходные растры: оставьте поля пустыми и отключите опции «Открыть выходной файл после завершения алгоритма».
  \item
    Остальные параметры оставьте по умолчанию.
  \end{itemize}
\item
  Запустите расчёт и дождитесь его завершения (может занимать до 7-8 минут). По окончании расчётов в проект QGIS будет добавлен новый растровый слой:

  \includegraphics{images/Ex13/FlowAcc.png}

  \begin{quote}
  Водосборная площадь при движении вниз по склону увеличивается экспоненциально, поэтому изображение в оттенках серого, которое вы видите, почти чёрное.
  \end{quote}
\item
  Измените стиль отображения растра на «Одноканальное псевдоцветное», максимальное значение --- \texttt{1e+07}, и выберите шкалу Blues. Примените изменения.
\item
  Перейдите на вкладку «Пирамиды» и постройте пирамидальные слои всех доступных разрешений для вашего набора данных. Для этого выберите в списке справа все доступные разрешения, установите в переключателе внизу метод передискретизации Гаусса и нажмите кнопку «Построение пирамид». Примените изменения.

  \includegraphics{images/Ex13/pyramids.png}

  \begin{quote}
  Пирамидальные слои, или пирамиды --- это производные растры относительно низкого разрешения, создаваемые на основе исходного растра для улучшения производительности в процессе визуализации. Если используется мелкий масштаб карты, ГИС-пакет отрисовывает не исходный растр, а один из пирамидальных слоёв.
  \end{quote}

  \includegraphics{images/Ex13/FlowAcc2.png}

  Если после построения пирамид на экране не произойдёт никаких изменений, перезагрузите проект QGIS.
\item
  Изучите полученное изображение, увеличивая и уменьшая масштаб визуализации.
\item
  Добавьте в проект мозаику спутниковых снимков из Интернета. Оцените, в какой мере области высоких значений водосборной площади соответствуют положениям водотоков и крупных эрозионных форм. Сделайте снимок экрана.
\end{enumerate}

\textbf{Скриншот 3:} растр водосборной площади после настройки визуализации

\textbf{Вопрос 3:} Можно ли сказать, что области высоких значений водосборной площади, рассчитанной по ЦМР, соответствуют тальвегам эрозионных форм и руслам рек? Ответ обоснуйте.

\hypertarget{hydrodem-network}{%
\section{Создание растра водотоков на основе модели водосборной площади}\label{hydrodem-network}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

Растр водосборной площади (или объёма стока) позволяет выделить сеть потенциальных водотоков. Ячейка считается принадлежащей к сети потенциальных водотоков, если величина водосборной площади в ней превышает некоторый заданный порог. Это упрощённый принцип, но он позволяет строить сети, подобные реальным.

Для выборки ячеек в QGIS можно воспользоваться уже знакомым вам инструментом переклассификации (см. \protect\hyperlink{weighted-overlay-reclass}{Переклассификация наборов данных}). Примем в рамках упражнения, что минимальная водосборная площадь, необходимая для формирования водотока, составляет 1 км².

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите инструмент «Переклассификация по таблице». Переклассифицируйте растр \texttt{flowacc} таким образом, чтобы все значения, меньшие 1 км², получили новое значение \(-9999\) (нет данных), а все значения, большие или равные 1 км² --- новое значение \(1\). Результат сохраните в вашу рабочую директорию под именем \texttt{streams}, формат --- GeoTIFF.

  \includegraphics{images/Ex13/streams.png}
\item
  Откройте свойства растра водотоков и измените стиль отображения на «Палитра / Уникальные значения». Нажмите «Классифицировать», чтобы добавить в таблицу все возможные значения растра, а затем выберите и удалите все значения, кроме \(1\). Для значения \(1\) установите тёмно-синий цвет, как показано на рисунке ниже.

  \includegraphics{images/Ex13/palette.png}
\item
  Увеличьте изображение до масштаба 1:100 000 и сделайте снимок экрана.
\end{enumerate}

\textbf{Скриншот 4:} Фрагмент растра сети потенциальных водотоков

\hypertarget{hydrodem-basin}{%
\section{Определение границ бассейна р. Оскол}\label{hydrodem-basin}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

\textbf{Внимание!} Инструменты, используемые в этой части упражнения, могут работать некорректно или не работать вовсе. Если вы сталкиваетесь с проблемами, переходите к следующему шагу упражнения.

Для дальнейшего анализа нам будет нужна только территория водосборного бассейна р. Оскол. На этом шаге мы определим границы её бассейна.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Добавьте на карту набор данных \texttt{outlet.kml}. Он отражает конечную точку модели водотока, соответствующей р. Оскол.
\item
  Найдите и запустите инструмент \textbf{Upslope Area} из группы SAGA. Этот инструмент предназначен для идентификации всех ячеек, сток из которых проходит через точку с заданными координатами --- фактически, он позволяет определить границы водосборного бассейна.
\item
  Используйте инструмент определения \includegraphics{images/Ex13/identify.png}, чтобы узнать координаты X и Y установленной точки.

  \includegraphics{images/Ex13/identify2.png}
\item
  Задайте входные параметры инструмента \textbf{Upslope Area}. Скопируйте координаты X и Y в соответствующие поля. Установите \texttt{DEM\_filled} в качестве исходной ЦМР и выберите метод D8. Остальные опции не задавайте. Результат сохраните в папку \texttt{processing} под именем \texttt{oskol\_basin}.

  \includegraphics{images/Ex13/basin.png}

  На полученном растре представлено всего два значения: \(100\) для ячеек, входящих в границы бассейна, и \(0\) для всех остальных ячеек.
\item
  Векторизуйте полученный растр. Результат векторизации сохраните в папку \texttt{processing} под именем \texttt{basin}.
\item
  Если необходимо, удалите из результата векторизации полигон, соответствующий областям за пределами бассейна р. Оскол. Также отключите растр границ бассейна.

  \includegraphics{images/Ex13/basin2.png}
\end{enumerate}

\hypertarget{hydrodem-mapping}{%
\section{Картографическое представление результата}\label{hydrodem-mapping}}

\protect\hyperlink{hydrodem}{В начало упражнения ⇡}

На этом этапе мы создадим трёхмерную визуализацию бассейна р. Оскол.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Отобразите слои проекта в охвате слоя DEM.
\item
  Если на предыдущем шаге упражнения вам не удалось построить границы бассейна, добавьте в проект набор \texttt{basin.shp} из папки с исходными данными. Этот шейп-файл содержит границу бассейна.
\item
  Измените стиль отображения слоя границ бассейна: установите прозрачную заливку и красную обводку толщиной 0,46 мм
\item
  Поместите слой устья реки (\emph{outlet}) над слоем границы бассейна. Измените условный знак устья на маркер в виде красного круга размером 2 мм.
\item
  Поместите под слоем границ бассейнов слой водосборной площади, а под ним --- слой скорректированной ЦМР. Остальные слои отключите.
\item
  Для слоя водосборной площади установите прозрачность 50 \%.
\item
  Измените настройки визуализации слоя ЦМР следующим образом:

  \begin{itemize}
  \tightlist
  \item
    Стиль: одноканальное псевдоцветное
  \item
    Минимальное значение: 50
  \item
    Максимальное значение: 275
  \item
    Интерполяция: дискретная
  \item
    Шкала: нажмите правой кнопкой мыши на палитру, выберите «Создать новый градиент», тип градиента --- «Каталог: cpt-city». В открывшемся интерфейсе в разделе Topography выберите палитру \texttt{wiki-knutux}.
  \item
    Режим классификации: равные интервалы
  \item
    Число классов: 9
  \end{itemize}

  \includegraphics{images/Ex13/dem_settings.png}

  После применения настроек изображение должно выглядеть, как показано на рисунке ниже:

  \includegraphics{images/Ex13/dem_result.png}
\item
  Для создания 3D-визуализации установите модуль \textbf{Qgis2threejs}. Этот модуль предназначен для создания трёхмерных визуализаций в QGIS на основе растровых и векторных пространственных данных --- в первую очередь, цифровых моделей рельефа.
\item
  Иконка модуля Qgis2treejs \includegraphics{images/Ex13/Qgis2threejs_icon.png} появится в панели инструментов. Нажмите на неё, чтобы открыть окно модуля.

  \includegraphics{images/Ex13/Qgis2threejs_interface.png}
\item
  В окне модуля Qgis2threejs включите слой DEM\_fill. Высоты из этого слоя будут использоваться для создания 3D-поверхности, а текстура (материал) изображения будет составлена на основе изображения в основном окне карты.
\item
  Изображение в окне Qgis2threejs выглядит плоским. Для того, чтобы сделать его более «объёмным», можно увеличить вертикальный масштаб. Для этого зайдите в настройки сцены (Scene -- Scene settings\ldots) и установите коэффициент вертикального масштабирования (Z exaggeration) равным 25.

  \includegraphics{images/Ex13/Qgis2threejs_result.png}
\item
  Вращая (с помощью зажатой левой кнопки мыши), перемещая (правой кнопкой мыши) и масштабируя (колесо мыши) изображение в окне Qgis2threejs, подберите такой ракурс изображения, который позволит наиболее наглядно, на ваш взгляд, продемонстрировать рельеф местности.
\item
  Экспортируйте полученное изображение (File -- Save Scene As -- Image (*.png) \ldots) и вставьте его в отчётный файл.
\end{enumerate}

\textbf{Изображение 5:} трёхмерная визуализация бассейна р. Оскол

\hypertarget{part-ux441ux435ux442ux435ux432ux43eux439-ux430ux43dux430ux43bux438ux437}{%
\part{Сетевой анализ}\label{part-ux441ux435ux442ux435ux432ux43eux439-ux430ux43dux430ux43bux438ux437}}

\hypertarget{networks}{%
\chapter{Анализ транспортных сетей}\label{networks}}

\href{https://1drv.ms/u/s!AmtmZDq3JgxHgZ0j1tgKv_d1ElUpow?e=s0gsKz}{Архив с данными и файл отчёта}

\hypertarget{networks-intro}{%
\section{Введение}\label{networks-intro}}

\textbf{Цель задания} --- научиться решать простые задачи сетевого анализа в ГИС

\textbf{Необходимая теоретическая подготовка:} Понятие о сетевой модели данных, граф дорожной сети. Сетевой анализ и его основные задачи: поиск кратчайшего маршрута, определение границ зон обслуживания и ближайшего пункта обслуживания, размещение-распределение. Матрица источник-назначение.

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер макетов). Выделение объектов на карте. Пространственные и атрибутивные запросы.

\textbf{Исходные данные:} наборы пространственных данных о дорожной сети, созданные на основе выгрузки с OpenStreetMap на территорию г. Рязань.

\textbf{Результат:} Маршрут между двумя точками назначения. Схема изохрон относительно выбранных стартовых точек. Матрица источник-назначение для складов и точек продажи. Схема зонирования территории по принадлежности к складам.

\hypertarget{networks-control}{%
\subsection{Контрольный лист}\label{networks-control}}

\begin{itemize}
\tightlist
\item
  Добавить на карту слой дорожной сети, слой зданий и сооружений
\item
  Выбрать из слоя дорожной сети объекты, подходящие для создания графа дорожной сети
\item
  Построить маршрут между двумя точками
\item
  Выполнить анализ дорожной сети для расчёта изохрон
\item
  Рассчитать матрицу источник-назначение, определить ближайшие источники для каждого назначения
\item
  Очертить зоны обслуживания
\end{itemize}

\hypertarget{networks-annotation}{%
\subsection{Аннотация}\label{networks-annotation}}

Задание посвящено знакомству с сетевым анализом. Задачи, предлагаемые в задании, связаны с определением оптимальных маршрутов, построением зон обслуживания, определением ближайших сервисных точек, размещением сервисных точек. Данные задачи активно используются в логистике --- оптимизации перевозок, а также в геомаркетинге и оптимизации местоположения пунктов обслуживания (магазинов, складов, пожарных депо и т.д.).

В основе решения этих задач лежит сетевая модель данных, являющаяся частным случаем векторной модели. В сетевой модели дорожная сеть представляется в виде графа.

\hypertarget{networks-init}{%
\section{Добавление исходных данных}\label{networks-init}}

\protect\hyperlink{networks}{В начало упражнения ⇡}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Скопируйте материалы к упражнению (файл GeoPackage) в свою рабочую директорию
\item
  Создайте проект QGIS и сохраните его в свою рабочую директорию
\item
  Добавьте в проект слои \emph{RyazanRoadNetwork} (улично-дорожная сеть) и \emph{RyazanBuildings} (здания и сооружения). Оба этих слоя подготовлены на основе данных OpenStreetMap
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/load_data.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Задайте следующие настройки отображения слоёв:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Улично-дорожная сеть --- линии серого цвета (60 \% светлоты) толщиной 0,26 мм;
\item
  Здания и сооружения --- полигоны серого цвета (80 \% насыщенности) без обводки
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Задайте подписи слоёв. Для этого откройте свойства соответствующего слоя, перейдите на вкладку «Подписи» и измените стиль подписей с \emph{No labels} на \emph{Single labels}. Изучите доступные настройки подписей.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/labels_settings.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Задайте следующие параметры подписей:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Для слоя дорожной сети: подписи по полю \texttt{Name}, кегль (размер) шрифта --- 8 типографских пунктов, остальные параметры по умолчанию;
\item
  Для слоя зданий и сооружений: подписи по полю \texttt{addr:housenumber}, кегль (размер) шрифта --- 6 типографских пунктов, остальные параметры по умолчанию.
\end{itemize}

\begin{quote}
Примечание: в некоторых версиях QGIS в интерфейсе настройки подписей некорректно переведено название единиц измерения --- вместо правильного «Пункты» написано «Точки». Как правило, эти единицы используются по умолчанию, поэтому даже в случае некорректного перевода у вас не должно возникнуть проблем.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\tightlist
\item
  Увеличьте масштаб изображения до 1:5000 и сделайте снимок экрана. Изображение фрейма карты должно быть похож на изображение ниже.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/visualization.png}

\textbf{Снимок экрана №1.} Окно QGIS после завершения настройки символов и подписей

\textbf{Вопрос 1}: сколько объектов содержится в слое объектов улично-дорожной сети?

\hypertarget{networks-query}{%
\section{Выбор элементов дорожной сети}\label{networks-query}}

\protect\hyperlink{networks}{В начало упражнения ⇡}

В рамках этого упражнения мы будем решать задачи логистики на примере движения автомобилей. Однако набор данных об улично-дорожной сети, предоставленный вам в качестве исходных данных, содержит не только действующие автомобильные дороги, но и другие типы объектов. Тип объекта хранится в поле \texttt{highway}. В таблице ниже перечислены значения атрибута \texttt{highway} для тех объектов, которые не должны участвовать в анализе.

\begin{longtable}[]{@{}ll@{}}
\toprule()
Значения атрибута \texttt{highway} & Пояснение \\
\midrule()
\endhead
construction & строящиеся дороги \\
cycleway & велодорожки \\
footway, pedestrian & пешеходные дороги и тротуары \\
path & тропы \\
proposed & планируемые дороги \\
raceway & гоночные треки \\
steps & лестницы \\
\bottomrule()
\end{longtable}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Составьте запрос, чтобы выбрать в слое \emph{RyazanRoadNetwork} все объекты, \textbf{кроме} перечисленных выше. Это можно сделать разными способами: с использованием оператора \texttt{\textless{}\textgreater{}} (не равно) или оператора \texttt{IN} (содержит).
\item
  Сохраните выборку в новый набор данных формата GeoPackage (правой кнопкой мыши на слой --- «Экспорт\ldots» --- «Сохранить выбранные объекты как\ldots»). Сохраните новый GeoPackage в вашу рабочую директорию и присвойте ему имя по шаблону \texttt{RoadNetwork\_\%Фамилия\%}. Укажите, что слой необходимо добавить в проект после сохранения
\item
  Когда новый слой будет добавлен к проекту, измените настройки его визуализации: установите толщину линий равной 0,26 мм, а цвет --- любой, кроме того, который уже используется для улично-дорожной сети.
\item
  Сделайте снимок экрана.
\end{enumerate}

\textbf{Снимок экрана №2.} Окно QGIS после сохранения выбранных дорог в отдельный набор

\hypertarget{networks-route}{%
\section{Построение маршрута}\label{networks-route}}

\protect\hyperlink{networks}{В начало упражнения ⇡}

Существует несколько подключаемых модулей для QGIS, которые позволяют решать задачи сетевого анализа. Мы воспользуемся одним из самых простых --- модулем \href{https://root676.github.io/}{QNEAT3}.

В отличие от «продвинутых» программных продуктов, таких, как ArcGIS, большинство модулей для сетевого анализа в QGIS не требуют представления графа дорожной сети в виде отдельной сущности. Вместо этого такой граф создаётся непосредственно в процессе работы инструментов на основе векторного линейного набора объектов.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Установите модуль QNEAT3.
\item
  Откройте панель инструментов анализа и убедитесь, что в неё добавилась группа инструментов QNEAT3.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/qneat3_instruments.png}

Теперь мы попробуем построить маршрут между двумя точками. Для решения этой задачи используется инструмент \textbf{Shortest path (point to point)} из группы \emph{Routing} набора QNEAT3

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Найдите здание вокзала \textbf{Рязань-1} (Вокзальная улица, 26А) и \textbf{Музыкальный колледж} (улица Дзержинского, 42). Запомните расположение этих зданий.
\end{enumerate}

\begin{quote}
Подсказка: названия зданий и их адреса могут быть указаны в таблице атрибутов.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Запустите инструмент \textbf{Shortest path (point to point)}. Откроется интерфейс настройки инструмента.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/qneat3_interface.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\item
  В качестве слоя дорожной сети (\emph{Network Layer}) укажите набор данных, который вы создали на предыдущем шаге.
\item
  Чтобы указать начальную точку маршрута, нажмите многоточие справа от поля ввода \emph{Start point}. Интерфейс настройки инструмента будет свёрнут, а курсор в окне QGIS примет вид мишени. Найдите здание вокзала Рязань-1 и щёлкните левой кнопкой мыши в произвольном месте внутри здания. Координаты курсора будут считаны и введены в поле \emph{Start point}.
\item
  Аналогичным образом укажите конечную точку маршрута в пределах здания музыкального колледжа.
\item
  Проверьте, что в качестве критерия оптимизации указано \emph{Shortest Path} (кратчайшее расстояние), а выходной набор данных сохраняется во временный файл.
\item
  Запустите инструмент. Дождитесь, пока будет рассчитан кратчайший маршрут, и не закрывайте интерфейс инструмента --- мы воспользуемся им снова, но изменим параметры.
\item
  Построенный кратчайший маршрут появится в таблице слоёв как временный слой с названием \emph{Shortest Path Layer}. Измените стиль этого слоя на линию красного цвета толщиной 1 мм. Отобразите карту в охвате слоя \emph{Shortest Path Layer}.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/shortestpath1.png}

Обратите внимание, что при построении этого маршрута учитывались только длины сегментов пути, но не учитывались характерные скорости и разрешённые направления движения. На следующих шагах мы внесём соответствующие коррективы.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\tightlist
\item
  Откройте таблицу атрибутов слоя дорожной сети и изучите её содержимое.
\end{enumerate}

\textbf{Вопрос 1}: какие характеристики дорожной сети записаны в таблице атрибутов?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{11}
\item
  Вернитесь в интерфейс инструмента \textbf{Shortest path (point to point)} (напомним, что его не нужно было закрывать).
\item
  Измените критерий оптимизации с кратчайшего пути на наиболее быстрый путь.
\item
  В настройке \emph{Direction field} укажите, в каком поле содержится информация о разрешённых направлениях движения. В следующих полях введите значения, соответствующие разрешённым направлениям: \texttt{yes} для движения только в прямом направлении, \texttt{-1} для движения только в обратном направлении, \texttt{no} для разрешения движения в обоих направлениях.
\item
  В настройке \emph{Speed field} укажите, из какого поля следует взять разрешённую скорость движения.

  \begin{quote}
  Примечание: обратите внимание, в каких единицах измеряется скорость в исходных данных и какие единицы требуются на вход модулю QNEAT. При необходимости воспользуйтесь калькулятором полей, чтобы преобразовать единицы измерения.
  \end{quote}
\item
  Снова запустите расчёт пути. Дождитесь, пока инструмент завершит работу, и новый временный слой будет добавлен в проект. После этого окно инструмента можно закрыть.
\item
  Переименуйте добавленный слой в \emph{Fastest Path Layer} и измените его отображение на линию синего цвета толщиной 1 мм.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/shortest_vs_fastest.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{17}
\tightlist
\item
  Самостоятельно повторите расчёт маршрутов по кратчайшему расстоянию и скорейшему времени для одной из пар «источник-назначение», приведённых в таблице ниже. Сохраняйте построенные пути в «постоянные» наборы данных.
\end{enumerate}

\begin{longtable}[]{@{}lrrrr@{}}
\toprule()
№ п/п & Источник & Адрес & Назначение & Адрес \\
\midrule()
\endhead
1 & ДК Станкозавода & Октябрьская улица, 5 & Соборная колокольня & улица Кремль, 10 \\
2 & ДК Станкозавода & Октябрьская улица, 5 & Рязанский цирк & Лево-Лыбедская улица, 34 \\
3 & ДК Станкозавода & Октябрьская улица, 5 & Вознесенский храм & Вознесенская улица, 26А \\
4 & ДК Станкозавода & Октябрьская улица, 5 & Рязанский городской центр детского творчества улица & Есенина, 46 \\
5 & Рязань-1 & Вокзальная улица, 26А & Рязанский государственный радиотехничекий университет & улица Гагарина, 59/1 \\
6 & Рязань-1 & Вокзальная улица, 26А & ТЦ ``Полетаевский'' & улица Гагарина, 164 \\
7 & Муниципальный культурный центр & Первомайский проспект, 68/2 & Рязанский театр драмы & Театральная площадь, 7 \\
8 & Муниципальный культурный центр & Первомайский проспект, 68/2 & Театр кукол & улица Есенина, 27 \\
9 & Муниципальный культурный центр & Первомайский проспект, 68/2 & РИРО & улица Урицкого, 2А \\
10 & Муниципальный культурный центр & Первомайский проспект, 68/2 & НИИ газоразрядных приборов «Плазма» & улица Циолковского, 17 \\
\bottomrule()
\end{longtable}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{17}
\tightlist
\item
  Создайте карту-схему построенных путей с масштабной линейкой и легендой. Вставьте эту схему в отчётный файл
\end{enumerate}

\begin{quote}
Примечание: перед тем, как оформлять схему, отключите подписи номеров домов
\end{quote}

\textbf{Изображение №3.} Схема маршрутов

\hypertarget{networks-isochrones}{%
\section{Расчёт изохрон}\label{networks-isochrones}}

\protect\hyperlink{networks}{В начало упражнения ⇡}

Модуль QNEAT3 комбинирует собственные алгоритмы анализа и базовый функционал QGIS для создания представления расстояний (или времени достижения) от определённых точек в виде изохрон. Для этого вычисляется расстояние (или время движения) от стартовой точки до ближайших узлов графа дорожной сети, а затем выполняется линейная интерполяция вычисленной величины между узлами, в результате чего создаётся поверхность расстояния (времени достижения) в растровом представлении. На основе растра создаётся изолинейное представление --- в виде изолиний либо в виде полигонов, представляющих послойную окраску. Эта задача решается с использованием библиотеки \texttt{matplotlib}.

За расчёт изолиний отвечают инструменты группы \texttt{Iso-Areas}.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Найдите на карте Автовокзал Центральный (Московское шоссе, 31). Мы будем рассчитывать время, которое затрачивается на проезд от этой точки на автотранспорте.
\item
  Запустите инструмент \emph{Iso-Area as Interpolation (from Point)}. Используйте дорожную сеть, которую вы применяли на предыдущем шаге, и укажите здание автовокзала в качестве стартовой точки для расчёта изохрон.
\item
  Размер области расчёта, или предельное расстояние/время, устанавливается либо в метрах, либо в секундах. Интерпретация величины зависит от того, какой критерий оптимизации был выбран. Установите в переменной \emph{Size of Iso-Area} значение 900, а критерий оптимизации --- по времени. В этом случае значение переменной будет прочитано как время в секундах.
\item
  Размер ячейки целевого растра интерполяции --- оставьте 10 м, как предлагается по умолчанию.
\item
  Установите дополнительные настройки расчёта таким образом, чтобы при расчёте учитывались скорость и разрешённые направления движения:
\end{enumerate}

\begin{itemize}
\tightlist
\item
  В поле Direction field нужно выбрать столбец таблицы атрибутов, в котором записаны кодированные значения направления движения;
\item
  В опциях \emph{Value for forward direction}, \emph{Value for backward direction} и \emph{Value for both directions} указать конкретные значения, которые кодируют соответствующее направление движения
\item
  В поле \emph{Speed Field} нужно выбрать столбец таблицы атрибутов, в котором указана скоросто движения по выбранному участку пути.
\end{itemize}

\includegraphics{images/Ex11_RoadNetwork/isoarea1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Запустите расчёт. Дождитесь, пока растр времени достижения (временный набор данных) будет добавлен к проекту QGIS
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/isoarea2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Переместите построенный растр на последнее место в списке слоёв.
\item
  Измените настройки визуализации растра следующим образом
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Тип визуализации: одноканальное псевдоцветное;
\item
  Минимум: 0
\item
  Максимум: 900
\item
  Интерполяция: дискретная
\item
  Градиент: Magma, инвертировать градиент
\item
  Число знаков после запятой в легенде (\emph{Label Precision}): 0
\item
  Мода: равные интервалы
\item
  Число классов: 15
\end{itemize}

\includegraphics{images/Ex11_RoadNetwork/isoarea3.png}

Кроме того, задайте на вкладке «Прозрачность» значение 66 \%.

В результате окно QGIS будет выглядеть, как показано ниже

\includegraphics{images/Ex11_RoadNetwork/isoarea4.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{8}
\item
  Добавьте на карту слой складов (\emph{Warehouses}) из базы \emph{RyazanNetworkData.gpkg}.
\item
  С помощью инструмента \emph{Iso-Area as Interpolation (from Layer)} рассчитайте изохроны для движения от складов. Используйте параметры, аналогичные применённым ранее. Также укажите, что результат интерполяции должен быть сохранён в вашу рабочую директорию как файл TIFF.
\item
  Когда файл будет создан и добавлен к проекту, примените к нему те же настройки визуализации, которые вы использовали для предыдущего аналогичного растра.
\item
  Создайте карту-схему с масштабной линейкой и легендой на основе созданного слоя и вставьте её в отчётный файл.
\end{enumerate}

\textbf{Изображение №4.} Время достижения точек местности при движении от складов

\hypertarget{networks-matrix}{%
\section{Работа с матрицей «источник-назначение»}\label{networks-matrix}}

\protect\hyperlink{networks}{В начало упражнения ⇡}

При расчёте изохрон для каждой точки местности рассчитывается расстояние до «источника». При этом, если источников несколько, расстояние рассчитывается только до ближайшего из них, причём сам источник никак не идентифицируется. Однако расчёт кратчайших путей можно делать таким образом, что пути будут построены для каждой пары источник-назначение. Результат такого вычисления удобно представлять в виде матрицы: матрица «источник-назначение» отражает стоимость пути между каждой точкой-источником и каждой точкой-назначением. Под стоимостью здесь может пониматься любая величина, которую необходимо минимизировать: длина маршрута, продолжительность поездки, денежная стоимость.

Если в задаче дано \(M\) точек-источников и \(N\) точек-назначений, то результирующая матрица будет иметь размер \(M \times N\). В практике геоинформационного анализа такое представление по ряду причин не очень удобно, поэтому чаще применяют форму представления не в виде матрицы, а в виде списка из трёх столбцов, где в первом столбце указывается идентификатор источника, во втором --- идентификатор назначения, в третьем --- рассчитанная стоимость маршрута.

\begin{quote}
Примечание: такой список в математике и анализе данных называется «вектор», а процедура трансформации матрицы в вектор --- «векторизация». В геоинформатике оба этих термина имеют несколько другое значение.
\end{quote}

QNEAT3 позволяет создавать матрицы источник-назначение на основе одного или двух наборов точечных данных и представлять их в виде списка. Опционально строкам списка могут быть сопоставлены линейные векторные объекты, связывающие источник и назначение по прямой линии. Мы воспользуемся матрицей источник-назначение, чтобы определить источник, ближайший к каждой точке назначения и рассчитать границы «зоны обслуживания» (\emph{service area}) для каждого источника. Для этого мы:

\begin{itemize}
\tightlist
\item
  Создадим точечный слой, представляющий пункты назначений;
\item
  Построим матрицу источник-назначение в виде таблицы;
\item
  Для каждой строки назначения определим путь с наименьшей стоимостью и выберем строку, соответствующую этому пути;
\item
  Удалим все невыбранные строки;
\item
  Присоединим матрицу источник-назначение к точечному слою пунктов назначений, таким образом ``приписав'' к каждому назначению идентификатор источника --- иначе говоря, найдём ближайший пункт обслуживания (\emph{closest facility}) для каждого пункта назначения;
\item
  Построим диаграмму Вороного (полигоны Тиссена) на пунктах назначений;
\item
  Объединим построенные полигоны по признаку.
\end{itemize}

В качестве исходных точек мы возьмём известные положения складов, с которыми вы работали в предыдущей части упражнения. В качестве точек назначения мы будем использовать центры полигонов зданий и сооружений. Однако этот набор данных содержит почти 25 тыс. объектов --- избыточно много для учебного упражнения. Поэтому сначала мы уменьшим это количество путём случайной выборки.

\textbf{Прежде, чем вы приступите к этой части упражнения}: все инструменты, указанные ниже, по умолчанию сохраняют выходные данные как временные файлы. Временные файлы удаляются после закрытия проекта QGIS, поэтому, если вы планируете надолго прерваться при выполнении упражнения, при запуске каждого инструмента явно указывайте, куда и в каком виде следует сохранить результирующий набор данных. Это требование не будет упоминаться далее в инструкции.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте случайную выборку объектов в слое зданий и сооружений. Для этого воспользуйтесь инструментом «Вектор» --- «Выбор» --- «Выбрать случайно\ldots». Выберите в слое \emph{RyazanBuildings} от 500 до 1500 объектов, согласно указаниям преподавателя, и закройте интерфейс инструмента.
\item
  Рассчитайте положения центральных точек (центроидов) для выбранных объектов. Для этого воспользуйтесь инструментом «Вектор» --- «Обработка геометрии» --- «Центроиды\ldots». Создайте центроиды только для выбранных объектов, при этом игнорируйте составную геометрию (не создавайте отдельный центроид для каждой части полигона).
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/centroids.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Рассчитайте матрицу источник-назначение при помощи инструмента \emph{OD Matrix from Layers as Table (m:n)}. Самостоятельно укажите, какой слой должен использоваться в качестве источника, а какой --- в качестве назначения. Уникальными идентификаторами в обоих случаях лучше назначить поле \texttt{fid}. Настройки поиска оптимальных маршрутов установите следующим образом: искать самый быстрый маршрут с учётом направления движения (вы уже неоднократно устанавливали такие настройки). Подождите, пока инструмент рассчитает матрицу --- на это потребуется несколько минут, в зависимости от мощности компьютера.
\item
  Откройте рассчитанную матрицу источник-назначение как таблицу атрибутов. Обратите внимание, что в каждой строке этой таблицы указан идентификатор источника, идентификатор назначения и несколько характеристик стоимости пути. Нас интересует последняя из них --- полная стоимость, \texttt{total\_cost}.
\end{enumerate}

\textbf{Вопрос 3}: сколько всего записей в открывшейся таблице? Почему их именно столько?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Теперь вам нужно выбрать в этой таблице строки, соответствующие минимальным расстояниям для каждого пункта назначения. Для этого откройте интерфейс выборки по условию и введите следующее выражение:
\end{enumerate}

\texttt{"total\_cost"\ =\ minimum("total\_cost",\ "destination\_id")}

Это выражение устроено следующим образом. Функция \texttt{minimum} ищет минимальное значение в столбце, указанном в качестве первого её аргумента. Второй аргумент используется как критерий группировки: в данном случае он указывает, что нужно искать не единое минимальное значение по всему столбцу, а сгруппировать минимальные значения, соответствующие разным идентификаторам пунктов назначений. Как мы помним, логическое выражение в целом применяется только к текущей строке таблицы атрибутов, поэтому функция \texttt{minimum} выдаст то минимальное значение, которое найдено для группы строк с тем же значением \texttt{destination\_id}, что и у текущей строки. Соответственно, логическое выражение в целом будет истинным для строк с минимальной стоимостью проезда для данного пункта назначения и ложным для всех остальных строк того же пункта.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Нажмите кнопку «Выбрать объекты» и подождите несколько минут, пока QGIS реализует введённый запрос.
\end{enumerate}

\textbf{Вопрос 4}: сколько всего записей было выбрано? Почему именно столько?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{6}
\item
  Включите режим редактирования для таблицы
\item
  Инвертируйте выборку. Для этого нажмите кнопку \includegraphics{images/Ex11_RoadNetwork/button_invertsSelection.png} «Инвертировать выделение» или \texttt{Ctrl+R} на клавиатуре. Таким образом вы выделите те записи, где время достижения не является минимальным для данных точек назначения.
\item
  Удалите выбранные строки, сохраните правки и выключите режим редактирования.
\end{enumerate}

\begin{quote}
Примечание: после этой операции в таблице должно остаться столько строк, сколько было исходных центроидов. Если у вас другое количество строк, удалите таблицу и выполните заново часть инструкции, начиная с расчёта матрицы источник-назначение.
\end{quote}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{9}
\tightlist
\item
  Теперь мы должны соединить то, что осталось от матрицы источник-назначение, с исходным слоем центроидов, чтобы сопоставить каждому центроиду идентификатор соответствующего склада. Присоедините таблицу к слою центроидов. Из всех столбцов таблицы можно присоединить только один --- идентификатор источника.
\end{enumerate}

\begin{quote}
примечание: если вы забыли, как выполняется присоединение таблиц в ГИС, обратитесь к соответствующему разделу \protect\hyperlink{overlay-join}{упражнения 8}
\end{quote}

После того, как вы осуществите присоединение, таблица атрибутов слоя центроидов примет следующий вид:

\includegraphics{images/Ex11_RoadNetwork/centroids_attrTable.png}

Теперь мы создадим диаграмму Вороного (\emph{Voronoy diagram}) точек центроидов. Диаграмма Вороного разбивает пространство вокруг точек на полигоны, причём каждый полигон ограничивает область пространства, более близких к одной из исходных точек, чем к остальным точкам. Поскольку каждый полигон диаграммы Вороного унаследует атрибуты исходных точек и поскольку в атрибутах точек содержится идентификатор ближайшего склада, мы сможем выделить области пространства, ближайшие к каждому складу при движении по сети автодорог.

Полигоны диаграммы Вороного иногда называют полигонами Тиссена (\emph{Thiessen polygons}). Распространено также некорректное название «полигоны Вороного» --- именно оно используется в QGIS.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{10}
\tightlist
\item
  Откройте интерфейс инструмента построения диаграммы Вороного («Вектор» --- «Обработка геометрии» --- «Полигоны Вороного\ldots»). Задайте исходный слой для построения, оставьте параметр «Буферная область» по умолчанию и запустите расчёт. Результат будет выглядеть аналогично представленному на рисунке ниже:
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/VoronoyDiagram.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{11}
\tightlist
\item
  Объедините полигоны с одинаковыми идентификаторами источников. Для этого воспользуйтесь уже знакомой вам функцией \protect\hyperlink{overlay-merge}{объединения по признаку}. Полученные полигоны представляют зоны обслуживания (\emph{service areas}) для каждой из исходных точек.
\end{enumerate}

\includegraphics{images/Ex11_RoadNetwork/VoronoyDiagram2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{12}
\tightlist
\item
  Создайте карту-схему зон обслуживания и вставьте её в отчётный документ. На карте-схеме должны быть показаны положения складов и границы зон обслуживания, соответствующих им. Желательно использовать цветовой фон для изображения разных складов и зон. Также схема должна иметь необходимую географическую основу (можно пользоваться базовой картой из Интернета), название и масштабную линейку. Добавлять легенду не обязательно.
\end{enumerate}

\textbf{Изображение №5.} Зоны обслуживания

\hypertarget{part-ux433ux435ux43eux43aux43eux434ux438ux440ux43eux432ux430ux43dux438ux435}{%
\part{Геокодирование}\label{part-ux433ux435ux43eux43aux43eux434ux438ux440ux43eux432ux430ux43dux438ux435}}

\hypertarget{geocoding}{%
\chapter{Адресное геокодирование и ядерная оценка плотности}\label{geocoding}}

\href{https://github.com/aentin/qgis-course/raw/master/files/Ex12_\%D0\%BE\%D1\%82\%D1\%87\%D1\%91\%D1\%82.docx}{Контрольный лист}

\hypertarget{geoding-intro}{%
\section{Введение}\label{geoding-intro}}

\textbf{Цель задания} --- научиться создавать новые наборы пространственных данных с использованием геокодирования

\textbf{Необходимая теоретическая подготовка:} модели пространственных данных, модели пространственных объектов, базы пространственных объектов, системы координат, геокодирование, адресное геокодирование, ядерная оценка плотности

\textbf{Необходимая практическая подготовка:} Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных . Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

\textbf{Исходные данные:} отсутствуют (вся необходимая информация загружается в процессе работы)

\textbf{Результат:} геокодированные точки объявлений о продаже недвижимости, карта плотности объявлений

\hypertarget{geocoding-control}{%
\subsection{Контрольный лист}\label{geocoding-control}}

\begin{itemize}
\tightlist
\item
  Получить список адресов с веб-сайта в виде электронной таблицы
\item
  Загрузить таблицу в QGIS
\item
  Выполнить геокодирование с использованием сервиса Nominatim
\item
  Проанализировать результат, определить проблемы, мешающие геокодированию
\item
  Исправить таблицу в соответсвии с выявленными проблемами
\item
  Повторно выполнить геокодирование, получить координаты точек, заданных адресами
\item
  Выполнить ядерную оценку плотности полученных точек
\item
  Визуализировать результат в виде карты-схемы
\end{itemize}

\hypertarget{geocoding-annotation}{%
\subsection{Аннотация}\label{geocoding-annotation}}

Геокодирование (англ. \emph{geocoding}) --- это определение координат объектов по их географическим текстовым описаниям, которые, как правило, выражены в виде адресов и/или почтовых кодов. Геокодирование широко применяется в тех сферах, где входящая информация поступает массово, но не имеет прямой географической привязки. Примеры такой информации: места дорожно-транспортных происшествий, адреса объектов недвижимости для продажи или сдачи в аренду, IP-адреса отправителей и получателей сообщений в сети Интернет.

Для обеспечения геокодирования необходимо иметь обширную и постоянно обновляемую базу пространственных данных, где каждому адресу сопоставлены географические координаты. Другой компонент геокодирования --- подсистема парсинга адреса, которая преобразует поданную на вход текстовую строку в вид, пригодный для автоматического распознавания геокодером.

Существует и противоположная операция --- обратное геокодирование (англ. \emph{reverse geocoding}), в ходе которого по заданным географическим координатам определяются почтовые или сетевые адреса.

Оперативное и достоверное геокодирование представляет большой интерес для различных групп пользователей --- от служб доставок до спасателей и полиции. В то же время, для обеспечения пригодности результатов геокодирования требуется создать и поддерживать в актуальном состоянии обширную базу пространственных данных, а также предусмотреть надёжный интерфейс для обращения к сервису. Это превращает геокодирование в конкурентную бизнес-услугу. Существует ряд коммерческих сервисов, предоставляющих услуги геокодирования: \href{https://pickpoint.io/ru}{PickPoint}, \href{https://developer.mapquest.com/documentation/geocoding-api/}{MapQuest}, \href{https://locationiq.com/geocoding}{LocationIQ}; почти у всех из них есть «демонстрационный» бесплатный режим с ограничением по количеству запросов. Крупные картографические интернет-сервисы, такие, как Google Maps или Яндекс.Карты, предоставляют \href{https://developers.google.com/maps/documentation/javascript/geocoding}{свои} \href{https://yandex.ru/dev/maps/geocoder/doc/desc/concepts/about.html}{сервисы} геокодирования на похожих условиях. Из открытых решений популярностью пользуется сервис \href{https://nominatim.org/}{Nominatim}, использующий данные OpenStreetMap. Результаты геокодирования с помощью Nominatim проигрывают в точности и оперативности результатам коммерческих сервисов (по понятным причинам), но всё же пригодны для использования в научных и учебных целях.

Мы воспользуемся сервисом геокодирования Nominatim, чтобы нанести на карту точки, соответствующие объявлениям о продаже недвижимости, предоставленные сайтом \href{https://www.cian.ru/}{ЦИАН}.

\hypertarget{geocoding-input}{%
\section{Получение исходных данных}\label{geocoding-input}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

В качестве исходных данных в этом упражнении мы будем использовать выгрузку объявлений с сайта \href{https://www.cian.ru/}{ЦИАН}. Перед началом упражнения следует выбрать охват территории, на которую будет производиться выгрузка. На примерах, приведённых ниже, показаны микрорайоны Московский и Мервино города Рязань. В соответствии с указаниями преподавателя, ваш индивидуальный вариант может быть другим.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте сайт \href{https://www.cian.ru/}{ЦИАН}
\item
  В выпадающих списках главной страницы выберите опции поиска, соответствующе следующему запросу: «\emph{Купить квартиру на вторичном рынке, любой планировки, любой цены}»
\item
  Нажмите на кнопку «Показать на карте». Отобразите карту таким образом, чтобы охват территории соответствал вашему варианту задания.

  \includegraphics{images/Ex08_Geocoding/cian01.png}
\item
  Нажмите кнопку «Список» в правой части экрана. Под заголовком списка найдите число объявлений, найденных в текущем охвате.

  \includegraphics{images/Ex08_Geocoding/cian02.png}
\item
  Для дальнейшей работы нам нужно, чтобы в вашей подборке было примерно 200 объявлений. Если в списке около 200 объявлений, переходите на следующий шаг инструкции. Если в списке меньше 150 или больше 250 объявлений, вернитесь в окно карты и измените экстент поиска, чтобы в него попало больше или меньше объявлений, а затем снова перейдите в окно списка.
\item
  Найдите внизу списка кнопку «Сохранить файл в Excel» и нажмите на неё. Файл со списком будет загружен на ваш компьютер под именем \texttt{offers.xlsx}

  \includegraphics{images/Ex08_Geocoding/cian03.png}
\item
  Создайте рабочую директорию и переместите в неё загруженный файл
\item
  Откройте список любым табличным редактором (например, Microsoft Excel или LibreOffice Calc).

  \includegraphics{images/Ex08_Geocoding/list01.png}
\item
  Найдите в загруженном файле столбец, в котором записан адрес квартиры.
\end{enumerate}

На следующих шагах вы выполните геокодирование адресов и соедините полученные пространственные объекты с текстовой информацией.

\hypertarget{geocoding-debug}{%
\section{Тестирование работы сервиса геокодирования}\label{geocoding-debug}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

Прежде чем начинать «пакетное» геокодирование всего списка, мы возьмём несколько отдельных адресов из него и проверим, насколько хорошо работает сервис распознавания адресов Nominatim. Для этого мы воспользуемся страницей интерфейса отладки Nominatim.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте страницу интерфейса отладки Nominatim по \href{https://nominatim.openstreetmap.org/ui/search.html}{этой ссылке}

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim01.png}
  \caption{Интерфейс отладки Nominatim. Используется для тестирования распознавания отдельных адресов}
  \end{figure}
\item
  Скопируйте любой адрес из вашей таблицы и вставьте его в строку поиска (\emph{Search}). Нажмите кнопку \textbf{Search}, чтобы запустить поиск

  Дальнейшее поведение системы зависит от того, насколько успешно парсер смог «прочитать» адрес. Если вся строка адреса распознана корректно, то в окне карты будет отображён объект, соответствующий найденному адресу.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim02.png}
  \caption{Пример успешного геокодирования}
  \end{figure}

  Если с распознаванием адресов возникли какие-либо трудности, то их можно отследить по выдаче. На рисунке ниже в адресе \texttt{Рязанская\ область,\ Рязань,\ улица\ Костычева,\ 8к1} распознал всё, кроме номера дома, и выдал в качестве результата объект, соответствующий улице.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim03.png}
  \caption{Пример сомнительного результата}
  \end{figure}

  В этом примере достаточно поставить пробел между номером дома и номером корпуса (\texttt{8\ к1}), и Nominatim отработает корректно.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim04.png}
  \caption{Пример результата после исправления входной строки}
  \end{figure}

  В худшем случае геокодер вообще не сможет определить адрес. В примере ниже (\texttt{Рязанская\ область,\ Рязань,\ улица\ Надежды\ Крупской,\ 11}) геокодер «сломался» уже на названии улицы.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim05.png}
  \caption{Адрес не распознан}
  \end{figure}

  В этом примере проблема кроется в названии улицы. В Рязани действительно есть улица, названная именем \href{https://ru.wikipedia.org/wiki/\%D0\%9A\%D1\%80\%D1\%83\%D0\%BF\%D1\%81\%D0\%BA\%D0\%B0\%D1\%8F,_\%D0\%9D\%D0\%B0\%D0\%B4\%D0\%B5\%D0\%B6\%D0\%B4\%D0\%B0_\%D0\%9A\%D0\%BE\%D0\%BD\%D1\%81\%D1\%82\%D0\%B0\%D0\%BD\%D1\%82\%D0\%B8\%D0\%BD\%D0\%BE\%D0\%B2\%D0\%BD\%D0\%B0}{Надежды Крупской}, но в OpenStreetMap она называется \texttt{улица\ Крупской}. С точки зрения Nominatim, \texttt{улица\ Надежды\ Крупской} и \texttt{улица\ Крупской} --- это разные улицы. Если изменить запрос на \texttt{Рязанская\ область,\ Рязань,\ улица\ Крупской,\ 11}, Nominatim выдаст корректный результат.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Nominatim06.png}
  \caption{После изменения названия улицы адрес распознан корректно}
  \end{figure}
\item
  Подберите три аналогичных примера из вашего набора исходных данных и сделайте скриншоты выдачи сервиса отладки Nominatim.
\end{enumerate}

\textbf{Скриншот 1:} успешное распознавание адреса сервисом Nominatim (в ответ на запрос выводится правильный дом)

\textbf{Скриншот 2:} неточное или неполное распознавание адреса (в ответ на запрос выводится улица, или неправильный дом, или правильный адрес, но в другом населённом пункте)

\textbf{Скриншот 3:} полностью неудачная попытка распознавания (пустая выдача)

Мы рассмотрели некоторые потенциальные проблемы с распознаванием адресов, которые возникают при использовании сервиса Nominatim. Следует заметить, что другие, более «продвинутые» сервисы геокодирования могут автоматически распознавать и разрешать проблемы такого рода.

\hypertarget{geocoding-import}{%
\section{Импорт списка адресов в QGIS}\label{geocoding-import}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

В предыдущих упражнениях вы импортировали табличную информацию в QGIS, пользуясь форматом Comma-Separated Values (CSV). В этом упражнении вы импортируете данные напрямую из таблицы Excel, пользуясь подключаемым модулем \textbf{Spreadsheet Layers}.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Создайте проект QGIS и сохраните его в своей рабочей директории
\item
  Используя функционал модуля QuickMapServices, подключите к проекту QGIS базовую карту OpenStreetMap.
\item
  Установите модуль Spreadsheet Layers. Модуль доступен в репозитории QGIS, поэтому достаточно ввести его имя в строке поиска.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Spreadsheet01.png}
  \caption{Модуль Spreadsheet Layers в окне управления модулями QGIS}
  \end{figure}
\item
  После установки модуля найдите опцию импорта табличных данных: меню «Слой» --- «Добавить слой» --- «Add Spreadsheet Layer».

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Spreadsheet02.png}
  \caption{Модуль Spreadsheet Layers в окне управления модулями QGIS}
  \end{figure}
\item
  В открывшемся окне укажите путь к файлу Excel и страницу, с которой требуется загрузить данные. Выходной слой назовите по шаблону \texttt{offers-\%Фамилия\%}, где \texttt{\%Фамилия\%} --- ваша фамилия латинскими буквами

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Spreadsheet03.png}
  \caption{Инструмент загрузки табличных данных в QGIS}
  \end{figure}

  При необходимости на этом этапе можно изменить типы данных для столбцов, но в нашем упражнении такой необходимости нет.
\item
  Нажмите OK, чтобы добавить слой к проекту QGIS.
\item
  Откройте таблицу атрибутов слоя и убедитесь, что данные из таблицы Excel отображаются корректно.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/Spreadsheet04.png}
  \caption{Таблица атрибутов загруженного слоя}
  \end{figure}
\end{enumerate}

\hypertarget{geocoding-batch-install}{%
\section{Установка модуля пакетного геокодирования}\label{geocoding-batch-install}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

Интерфейс отладки, который мы использовали на ранее, пригоден для геокодирования отдельных адресов, но неудобен для пакетного геокодирования, когда нужно распознавать несколько сотен адресов.

Для решения задача пакетного геокодирования на базе QGIS и Nominatim разработано несколько модулей. Мы воспользуемся модулем \href{https://github.com/NationalSecurityAgency/qgis-bulk-nominatim}{Bulk Nominatim QGIS Plugin}. В отличие от модуля Spreadsheet Layers, этот модуль не содержится в репозитории QGIS, поэтому его придётся установить из ZIP-архива.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Перейдите на \href{https://github.com/NationalSecurityAgency/qgis-bulk-nominatim}{страницу модуля Bulk Nominatim QGIS Plugin на GitHub}:

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/bulk-nominatim01.png}
  \caption{Bulk Nominatim на GitHub}
  \end{figure}
\item
  Нажмите на кнопку «Code» и в открывшемся выпадающем списке выберите «Download ZIP».

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/bulk-nominatim02.png}
  \caption{Загрузка архива}
  \end{figure}
\item
  Перенесите загруженный ZIP-архив в вашу рабочую директорию.
\item
  Вернитесь в QGIS и установите модуль из ZIP-файла

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/bulk-nominatim03.png}
  \caption{Установка модуля из ZIP-файла}
  \end{figure}
\end{enumerate}

После установки модуля его инструменты будут доступны через меню «Модули» --- «Nominatim GeoCoding» или при помощи кнопок \includegraphics{images/Ex08_Geocoding/bulk-nominatim04.png} на панели инструменов.

\begin{figure}
\centering
\includegraphics{images/Ex08_Geocoding/bulk-nominatim05.png}
\caption{Инструменты модуля Bulk GeoCoding}
\end{figure}

\hypertarget{geocoding-batch}{%
\section{Пакетное геокодирование}\label{geocoding-batch}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

Теперь, когда вы установили инструмент для пакетного геокодирования, можно попытаться выполнить распознавание адресов при помощи Nominatim.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Откройте интерфейс настройки модуля Bulk Geocoding («Модули» --- «Nominatim GeoCoding» --- «Settings»). Установите максимальное число объектов для геокодирования (\emph{Maximum Features to Geocode}) равным \(200\).

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding00.png}
  \caption{Настройки модуля Bulk GeoCoding}
  \end{figure}
\item
  Запустите инструмент Bulk GeoCoding. В открывшемся окне укажите исходный слой и поле, из которого будут взяты адреса.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding01.png}
  \caption{Настройки пакетного геокодирования}
  \end{figure}
\item
  Убедитесь, что вы подключены к Интернету.
\item
  Нажмите кнопку OK, чтобы запустить процесс пакетного геокодирования. Не закрывайте окно инструмента.

  Результат геокодирования будет представлен в виде временного точечного слоя.
\item
  Когда инструмент завершит работу, обратите внимание на выдачу в поле Results. В этом поле отображаются адреса, которые не удалось распознать. Скопируйте эти адреса в отдельный текстовый документ и сохраните этот документ в вашу рабочую директорию.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding02.png}
  \caption{Нераспознанные адреса}
  \end{figure}
\item
  Закройте окно инструмента и изучите распределение точек, которые были созданы в ходе геокодирования.

  На рисунке ниже все точки адресов, за исключением двух, группируются в северо-западной части карты. Две отлетающих точки попали в другие населённые пункты.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding03.png}
  \caption{Неправильно распознанные адреса: несколько точек «вылетело» далеко за пределы целевой территории}
  \end{figure}

  Но и среди точек, попавших в правильный населённый пункт, есть ситуации некорректного и неточного распознавания. При правильном распознавании точка устанавливается поверх здания, имеющего соответствующий адрес. Если точка располагается поверх линейного объекта, как на рисунке ниже, это тоже следует считать ошибкой: распознано название улицы, но не распознан номер дома.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding04.png}
  \caption{Неправильно распознанные адреса: точки установлены поверх улиц}
  \end{figure}
\item
  Сделайте скриншот окна QGIS после первой попытки геокодирования. Покажите полный охват точечного слоя.

  \textbf{Скриншот 1:} Результат геокодирования исходной таблицы адресов

  На следующих шагах мы постараемся систематизировать ситуации, которые приводят к некорректным распознаваниям, и внести правки в соответствующие записи. Строго говоря, правки можно сделать непосредственно в Excel, но, поскольку одной из наших задач является освоение геоинформационного ПО, мы воспользуемся возможностями QGIS.
\item
  Сохраните слой под именем \texttt{offers} (вашу таблицу с адресами) в формат GeoPackage. Для этого в контекстном меню слоя выберите «Экспорт» --- «Сохранить объекты как\ldots». В открывшемся окне укажите имя выходного файла (\texttt{geocoding\_\%Фамилия\%}) и имя слоя (\texttt{input\_table\_\%Фамилия\%}). В разделе «Геометрия» обязательно установите тип «Без геометрии». Убедитесь, что опция «Добавить слой в проект» включена.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/save_table.png}
  \caption{Сохранение таблицы}
  \end{figure}
\item
  После добавления слоя удалите из проекта старую таблицу, а новый слой переименуйте, убрав из названия имя выходного файла.
\item
  Изучите списки адресов, которые не были геокодированы или были кодированы с ошибками. Определите возможные причины ошибок.

  В каждом наборе исходных данных причины ошибок могут быть разными. В демонстрационном наборе наиболее заметны следующие причины:

  \begin{enumerate}
  \def\labelenumii{\alph{enumii}.}
  \item
    Несовпадения в названиях улиц. Например, Nominatim не распознаёт такие записи, как \texttt{улица\ Надежды\ Крупской} или \texttt{Улица\ Александра\ Полина}. Вместо них следует подставить \texttt{улица\ Крупской} и \texttt{улица\ Полина}, соответственно;
  \item
    Пунктуация в номерах домов. В OpenStreetMap литеры, корпуса, владения и другие «дополнительные» элементы номера дома традиционно вносятся через пробел, например \texttt{8\ к2}. В исходной же таблице эти элементы написаны слитно (\texttt{8к2}).
  \end{enumerate}
\item
  Используя \textbf{калькулятор полей}, отредактируйте поле адресов, чтобы привести адреса в вид, пригодный для использования с Nominatim.

  В приведённых выше примерах это делается следующим образом:

  \begin{enumerate}
  \def\labelenumii{\alph{enumii}.}
  \tightlist
  \item
    Проблема с полным названием улицы решается использованием строковой функции \texttt{replace}, которая заменяет одну подстроку другой:
  \end{enumerate}

  \texttt{replace("Адрес",\ \textquotesingle{}улица\ Надежды\ Крупской\textquotesingle{},\ \textquotesingle{}улица\ Крупской\textquotesingle{})}

  \texttt{replace("Адрес",\ \textquotesingle{}улица\ Александра\ Полина\textquotesingle{},\ \textquotesingle{}улица\ Полина\textquotesingle{})}

  \begin{enumerate}
  \def\labelenumii{\alph{enumii}.}
  \setcounter{enumii}{1}
  \tightlist
  \item
    Чтобы отделить номер корпуса от номера дома, замена с помощью \texttt{replace} уже не поможет, потому что нужно вставить пробел не перед каждой буквой \texttt{к}, а только перед теми, которые содержатся в номере дома. Здесь нам на помощь придут \href{https://ru.wikipedia.org/wiki/\%D0\%A0\%D0\%B5\%D0\%B3\%D1\%83\%D0\%BB\%D1\%8F\%D1\%80\%D0\%BD\%D1\%8B\%D0\%B5_\%D0\%B2\%D1\%8B\%D1\%80\%D0\%B0\%D0\%B6\%D0\%B5\%D0\%BD\%D0\%B8\%D1\%8F}{регулярные выражения} и функция QGIS \texttt{regexp\_replace}. Выражение, приведённое ниже, ищет вхождения буквы \texttt{к}, стоящие после любой цифры (\texttt{0\ -\ 9}), и заменяет его на \texttt{\textbackslash{}\_к} (т.е. ставит пробел перед буквой):
  \end{enumerate}

  \texttt{regexp\_replace("Адрес",\ \textquotesingle{}(.*{[}0-9{]})к(.*)\textquotesingle{},\ \textquotesingle{}\textbackslash{}\textbackslash{}1\ к\textbackslash{}\textbackslash{}2\textquotesingle{})}

  Подробное изучение операторов и синтаксиса регулярных выражений выходит за рамки нашего курса.
\item
  После внесения необходимых правок в поле «Адрес» удалите из списка слоёв предыдущий результат геокодирования, а затем выполните геокодирование повторно.
\item
  Изучите новый результат геокодирования. Если из 200 имеющихся адресов корректно распознано менее 150, повторите шаги 11--12. Добейтесь корректного позициронирования по крайней мере 150 адресов.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/coding05.png}
  \caption{Сохранение таблицы}
  \end{figure}
\item
  После получения пригодного результата перепроецируйте его в подходящую систему координат («Вектор» --- «Управление данными» --- «Перепроецировать слой\ldots») и сохраните в тот же GeoPackage, где лежит исходная таблица. Назовите его \texttt{points}.
\item
  Удалите временный слой с результатом распознавания из таблицы слоёв
\item
  Запустите редактирование слоя точек и удалите все точки, которые находятся за пределами вашего участка. После удаления увеличьте изображение до охвата слоя и сделайте снимок экрана и ответьте на контрольный вопрос.
\end{enumerate}

\textbf{Скриншот 2:} Результат геокодирования отредактированной таблицы адресов

\hypertarget{geocoding-mapping}{%
\section{Картографирование плотности объявлений}\label{geocoding-mapping}}

\protect\hyperlink{geocoding}{В начало упражнения ⇡}

В результате геокодирования вы получили набор точек, каждая из которых соответствует одному объявлению о продаже недвижимости. При этом точки объявлений с одинаковым адресом будут иметь полностью совпадающие координаты. Поэтому визуальное отображение адресов даёт искажённое представление о распределении продаваемой недвижимости по территории.

Чтобы получить более достоверное распределение, можно перейти от дискретного представления явления (отдельные точки) к континуальному представлению (поле плотности). Для решения этой задачи применяется ядерная оценка плотности (\emph{kernel density estimation}). Результатом ядерной оценки плотности является растр (регулярная сетка), каждая ячейка которой характеризует плотность явления или его ожидаемое количество.

\begin{quote}
Примечание: результат ядерной оценки плотности зачастую называют «тепловой картой» или «теплокартой», поскольку при удачно подобранных графических средствах области высокой концентрации явления выглядят «яркими», «горячими», а области низкой концентрации --- «тёмными», «холодными». Несмотря на широкое распространение этих названий, мы не рекомендуем пользоваться ими в географических исследованиях, чтобы избежать путаницы с картами климатических и метеорологических характеристик, где «тепло» и «холодно» используются в прямом смысле.
\end{quote}

Для выполнения ядерной оценки плотности в QGIS имеется инструмент \textbf{Тепловая карта (оценка плотности ядер)}. Его можно найти в панели инструментов анализа, в разделе «Интерполяция»

\begin{figure}
\centering
\includegraphics{images/Ex08_Geocoding/kde00.png}
\caption{Инструмент ядерной оценки плотности в QGIS}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Запустите инструмент ядерной оценки плотности. В качестве исходного слоя задайте геокодированные точки
\item
  Проверьте предлагаемое значение в поле «Радиус». Если возле поля «Радиус» изображён предупреждающий знак, а предлагаемая единица измерения --- градусы, значит, ваш исходный слой сохранён в географической системе координат. Выполните перепроецирование слоя (шаг 14 предыдущего раздела).
\item
  Если с единицами измерения всё в порядке, установите радиус равным 250 м. Это охват области, на которую будет «распределяться» плотность точек.
\item
  Установите размер пиксела по X и по Y равным 5 м. Этого вполне достаточно для аппроксимации.
\item
  Укажите, что результирующий слой (\emph{Heatmap}) нужно сохранить в вашу рабочую директорию под именем \texttt{heatmap\_\%Фамилия\%.tif}, где \texttt{\%Фамилия\%} --- ваша фамилия латинскими буквами

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/kde01.png}
  \caption{Настройки ядерной оценки плотности}
  \end{figure}
\item
  Запустите инструмент ядерной оценки плотности и дождитесь, пока результат оценки будет добавлен к карте. После этого закройте инструмент ядерной оценки плотности.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/kde02.png}
  \caption{Результат ядерной оценки плотности}
  \end{figure}
\item
  Поместите слой исходных точек над слоем ядерной оценки плотности.
\item
  Откройте свойства слоя ядерной оценки плотности на вкладке «Стиль». Измените цветовую схему на «Одноканальное псевдоцветное». Округлите максимальное отображаемое значение вверх до ближайшего целого числа, кратного 5. Измените тип интерполяции на «Линейную», задайте точность подписи равной 0, режим классификации --- «Равные интервалы». Установите число интервалов, равное или пропорциональное максимальному значению.

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/kde_symbology_01.png}
  \caption{Результат ядерной оценки плотности}
  \end{figure}
\item
  Нажмите правой кнопкой на изображение шкалы (градиента) и активируйте опцию «Инвертировать градиент».
\item
  Перейдите на вкладку «Прозрачность» и установите прозрачность слоя равной 50 \%.

  В результате применения описанных настроек вы получите изображение ядерной оценки, аналогичное представленному ниже:

  \begin{figure}
  \centering
  \includegraphics{images/Ex08_Geocoding/kde_symbology_02.png}
  \caption{Результат ядерной оценки плотности}
  \end{figure}
\item
  Сделайте снимок экрана.
\end{enumerate}

\textbf{Скриншот 3:} Ядерная оценка плотности объявлений о продаже недвижимости

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{11}
\item
  Создайте картографическое изображение на основе имеющихся пространственных данных. Создайте макет компоновки, добавьте на него картографическое изображение, легенду, масштабную линейку, название карты и сведения об авторстве. Для картографического изображения настройте градусную сетку. В легенде сохраните только те условные знаки, которые соответствуют тематическому содержанию карты.
\item
  Экспортируйте карту в формат PNG и вставьте её в отчёт.
\end{enumerate}

\textbf{Рисунок 4:} Карта-схема плотности объявлений о продаже недвижимости

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{13}
\tightlist
\item
  Ответьте на контрольные вопросы в отчётном файле.
\end{enumerate}

\hypertarget{appendix-ux441ux43fux440ux430ux432ux43eux447ux43dux44bux435-ux441ux432ux435ux434ux435ux43dux438ux44f}{%
\appendix}


\hypertarget{manual-catalog}{%
\chapter{Форматы пространственных данных}\label{manual-catalog}}

\hypertarget{manual-dataformats-shapefile}{%
\section{Шейп-файлы}\label{manual-dataformats-shapefile}}

\hypertarget{geopackage}{%
\section{GeoPackage}\label{geopackage}}

\hypertarget{ux431ux430ux437ux44b-ux433ux435ux43eux434ux430ux43dux43dux44bux445-esri}{%
\section{Базы геоданных ESRI}\label{ux431ux430ux437ux44b-ux433ux435ux43eux434ux430ux43dux43dux44bux445-esri}}

\hypertarget{manual-crs}{%
\chapter{Форматы описания систем координат}\label{manual-crs}}

В современной практике работы с ГИС применяется три основных формата описания систем координат:

\begin{itemize}
\tightlist
\item
  Текстовое описание в формате \textbf{Well-Known Text (WKT)};
\item
  Текстовое описание в формате строки \textbf{PROJ};
\item
  Код (индекс) системы координат в одной из широко используемых баз данных --- EPSG, ESRI, IAU, SpatialReference.org
\end{itemize}

Формат \textbf{PROJ} --- один из трёх стандартных форматов описания систем координат, был предложен разработчиками библиотеки \href{https://proj.org/}{PROJ}, используемой для преобразования систем координат пространственных данных (отсюда и название формата). Часто этот формат называют также PROJ.4, поскольку он был введен в 4-й версии библиотеки PROJ. Другой формат --- коды \href{http://www.epsg-registry.org/}{\textbf{EPSG}} (удобный ресурс для поиска --- \href{https://epsg.io/}{epsg.io}), введённые в оборот для быстрого доступа к наиболее распространенным системам координат. Третий вариант --- формат \textbf{Well-Known Text (WKT)}, который предоставляет наиболее полные возможности для описания параметров системы координат. Формат WKT является \href{https://www.iso.org/standard/76496.html}{международным стандартом}. Ознакомиться с его определением можно на \href{http://docs.opengeospatial.org/is/18-010r7/18-010r7.html}{сайте} Open Geospatial Consortium.

\hypertarget{manual-plugins}{%
\chapter{Установка модулей в QGIS}\label{manual-plugins}}

Одно из преимуществ QGIS как геоинформационной платформы --- наличие большого количества подключаемых модулей (плагинов). Подключаемые модули расширяют возможности QGIS, предоставляя пользователям специализированные инструменты для решения определённых задач --- например, для конвертации логов ГНСС-приёмников, геокодирования или получения информации из кадастровых баз данных. С другой стороны, поскольку большинство подключаемых модулей написано сторонними разработчиками, программный код любого модуля может содержать ошибки, приводящей к некорректной работе модуля, или не обеспечивать требуемый функционал.

\hypertarget{manual-plugins-install}{%
\section{Установка модулей}\label{manual-plugins-install}}

Существует два пути установки модулей:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Установка из репозитория;
\item
  Установка из ZIP-архива.
\end{enumerate}

Для установки новых модулей, обновления или удаления имеющихся модулей следует зайти в меню «Модули» --- «Управление модулями\ldots»

\includegraphics{images/Man02_InstallModules/Modules01.png}

\textbf{Установка из репозитория} --- наиболее удобный способ установки модулей в QGIS. Этот способ требует подключения к Интернету. При запуске команды «Управление модулями\ldots» QGIS производит проверку доступных модулей в репозиториях, сохранённых в списке. По умолчанию в списке присутствует только официальный репозиторий модулей QGIS. Включение модуля в официальный репозиторий даёт некоторые гарантии его стабильной работы: от разработчика требуется поддерживать сайт и репозиторий кода модуля, а также отслеживать сообщения об ошибках.

Для установки из репозитория достаточно выбрать вкладку «Все» или «Не установленные» в левой части окна управления модулями, а затем при помощи строки поиска в верхней части найти нужный модуль по названию или ключевым словам. Выбрав нужный модуль из списка подходящих, нажмите кнопку «Установить модуль» в правом нижнем углу.

\includegraphics{images/Man02_InstallModules/Modules02.png}

\textbf{Установка модуля из архива} применяется, как правило, для экспериментальных модулей, которые не доведены разработчиками до состояния, пригодного для размещения в открытом репозитории.
Для установки модуля из архива необходимо загрузить на компьютер пользователя ZIP-архив с файлами модуля. Затем в окне управления модулями нужно открыть вкладку «Установить из ZIP файла», в этой вкладке указать путь к файлу и нажать на кнопку «Установить модуль»

\includegraphics{images/Man02_InstallModules/Modules03.png}

\hypertarget{manual-plugins-update}{%
\section{Обновление модулей}\label{manual-plugins-update}}

Модули, размещённые в открытых репозиториях, периодически получают обновления от разработчиков.

Модули, установленные из ZIP-архивов, не получают обновлений автоматически. Для перехода на новую версию модуля нужно получить архив с новой версией, а затем повторить процедуру установки.

\hypertarget{manual-plugins-uninstall}{%
\section{Удаление модулей}\label{manual-plugins-uninstall}}

Для удаления модуля нужно выбрать его на вкладке «Установленные», а затем нажать кнопку «Удалить модуль» в правом нижнем углу.

\hypertarget{mastertest}{%
\chapter{Инструкция по регистрации в системе Мастер-тест}\label{mastertest}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Зайдите на сайт \href{https://master-test.net/ru}{Мастер-Тест}

  \includegraphics{./images/instruction/001.png}
\item
  Нажмите кнопку «Регистрация»
\item
  Введите ваше имя и фамилию, а также адрес электронной почты. Придумайте пароль.

  \includegraphics{./images/instruction/002.png}
\item
  На указанный e-mail придёт сообщение с кодом. Введите его в поле «Код»:

  \includegraphics{./images/instruction/003.png}
\item
  После регистрации в системе перейдите на главную страницу
\item
  На главной странице укажите, что вы регистрируетесь как студент, и выберите часовой пояс, соответствующий вашему местоположению. Нажмите «Продолжить»

  \includegraphics{./images/instruction/004.png}
\item
  Перейдите на вкладку «Мои учителя» и нажмите кнопку «Добавить учителя» в верхней строке.

  \includegraphics{./images/instruction/005.png}
\item
  В появившемся окне введите код \texttt{9c833c4d} и нажмите «Добавить»

  \includegraphics{./images/instruction/006.png}
\item
  Доступные вам тесты будут отображаться на вкладке «Активные тесты».

  \includegraphics{./images/instruction/007.png}
\end{enumerate}

  \bibliography{book.bib,packages.bib}

\end{document}
